{% liquid
  assign hide_often_bought_together = false

  if product == blank
    assign hide_often_bought_together = true
  else
    assign product_settings_ref = product.metafields.custom.sbv2_product_settings.value | default: product.metafields.custom.sbv2_product_settings
    if product_settings_ref != blank
      assign hide_often_bought_together_value = product_settings_ref.hide_often_bught_together.value | default: product_settings_ref.hide_often_bught_together
      if hide_often_bought_together_value == blank
        assign hide_often_bought_together_value = product_settings_ref.hide_often_bought_together.value | default: product_settings_ref.hide_often_bought_together
      endif

      if hide_often_bought_together_value == true or hide_often_bought_together_value == 'true' or hide_often_bought_together_value == 1 or hide_often_bought_together_value == '1'
        assign hide_often_bought_together = true
      endif
    endif
  endif
%}

{% unless hide_often_bought_together %}
  <sb-product-recommendations
    id="sb-often-bought-together-{{ section.id }}"
    data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ product.id }}&limit=4&intent=related"
    data-recommendations-performed="{{ recommendations.performed }}"
  >
    {% if recommendations.performed %}
      {% liquid
        if recommendations.products_count > 0
          assign recommended_products = recommendations.products
        endif
      %}
    {% endif %}

    {% if recommendations.performed and recommended_products != blank %}
      <section class="sb-often-bought-together" data-sb-reveal>
        <h2 class="sb-often-bought-together__title font-title weight-bold" data-sb-reveal-item>
          {{ section.settings.title }}
        </h2>

        <div class="sb-often-bought-together__grid" data-sb-reveal-item>
          {% for recommended_product in recommended_products limit: 4 %}
            {% liquid
              assign product_rating = 0
              assign product_reviews_count = 0
              assign product_hide_reviews = false
              assign selected_variant = recommended_product.selected_or_first_available_variant
              assign product_price_text = ''
              assign product_compare_price_text = ''
              assign swatch_1 = blank
              assign swatch_2 = blank
              assign swatch_3 = blank
              assign swatch_4 = blank
              assign swatch_1_image = blank
              assign swatch_2_image = blank
              assign swatch_3_image = blank
              assign swatch_4_image = blank
              assign swatch_1_hover_image = blank
              assign swatch_2_hover_image = blank
              assign swatch_3_hover_image = blank
              assign swatch_4_hover_image = blank
              assign swatch_1_gallery = blank
              assign swatch_2_gallery = blank
              assign swatch_3_gallery = blank
              assign swatch_4_gallery = blank
              assign swatch_1_variant_id = blank
              assign swatch_2_variant_id = blank
              assign swatch_3_variant_id = blank
              assign swatch_4_variant_id = blank
              assign swatch_1_price_text = blank
              assign swatch_2_price_text = blank
              assign swatch_3_price_text = blank
              assign swatch_4_price_text = blank
              assign swatch_1_compare_price_text = blank
              assign swatch_2_compare_price_text = blank
              assign swatch_3_compare_price_text = blank
              assign swatch_4_compare_price_text = blank
              assign swatch_index = 0

              if recommended_product.metafields.reviews.rating.value != blank
                assign rating_value = recommended_product.metafields.reviews.rating.value
                assign product_rating = rating_value.rating | default: rating_value | plus: 0
              endif

              assign product_reviews_count = recommended_product.metafields.reviews.rating_count.value | default: 0 | plus: 0 | round: 0

              assign recommended_product_settings_ref = recommended_product.metafields.custom.sbv2_product_settings.value | default: recommended_product.metafields.custom.sbv2_product_settings
              if recommended_product_settings_ref != blank
                assign product_hide_reviews_value = recommended_product_settings_ref.hide_reviews.value | default: recommended_product_settings_ref.hide_reviews
                if product_hide_reviews_value == true or product_hide_reviews_value == 'true' or product_hide_reviews_value == 1 or product_hide_reviews_value == '1'
                  assign product_hide_reviews = true
                endif
              endif

              if selected_variant != blank
                assign product_price_text = selected_variant.price | money
                if selected_variant.compare_at_price > selected_variant.price
                  assign product_compare_price_text = selected_variant.compare_at_price | money
                endif
              endif

              for option in recommended_product.options_with_values
                assign option_name_downcase = option.name | downcase
                if option_name_downcase contains 'color' or option_name_downcase contains 'colour'
                  for option_value in option.values
                    assign option_swatch_color = option_value.swatch.color | default: option_value.name
                    assign option_swatch_image = blank
                    assign option_swatch_hover_image = blank
                    assign option_swatch_gallery = blank
                    assign option_swatch_variant_id = blank
                    assign option_swatch_price_text = blank
                    assign option_swatch_compare_price_text = blank

                    if option_value.swatch.image != blank
                      assign option_swatch_image = option_value.swatch.image | image_url: width: 584
                    endif

                    for product_variant in recommended_product.variants
                      assign variant_color_value = blank
                      case option.position
                        when 1
                          assign variant_color_value = product_variant.option1
                        when 2
                          assign variant_color_value = product_variant.option2
                        when 3
                          assign variant_color_value = product_variant.option3
                      endcase

                      if variant_color_value == option_value.name
                        assign option_swatch_variant_id = product_variant.id
                        assign option_swatch_price_text = product_variant.price | money
                        if product_variant.compare_at_price > product_variant.price
                          assign option_swatch_compare_price_text = product_variant.compare_at_price | money
                        else
                          assign option_swatch_compare_price_text = blank
                        endif
                        break
                      endif
                    endfor

                    if option_swatch_image == blank
                      for product_variant in recommended_product.variants
                        assign variant_color_value = blank
                        case option.position
                          when 1
                            assign variant_color_value = product_variant.option1
                          when 2
                            assign variant_color_value = product_variant.option2
                          when 3
                            assign variant_color_value = product_variant.option3
                        endcase

                        if variant_color_value == option_value.name and product_variant.featured_image != blank
                          assign option_swatch_image = product_variant.featured_image | image_url: width: 584
                          assign option_swatch_gallery = 'image::' | append: option_swatch_image
                          assign option_swatch_variant_id = product_variant.id
                          assign option_swatch_price_text = product_variant.price | money
                          if product_variant.compare_at_price > product_variant.price
                            assign option_swatch_compare_price_text = product_variant.compare_at_price | money
                          else
                            assign option_swatch_compare_price_text = blank
                          endif

                          assign option_variant_hover_photo = product_variant.metafields.custom.sbv2_hover_photo.value | default: product_variant.metafields.custom.sbv2_hover_photo
                          if option_variant_hover_photo != blank
                            assign option_swatch_hover_image = option_variant_hover_photo | image_url: width: 584
                          endif

                          assign option_variant_gallery_images = product_variant.metafields.custom.images.value | default: product_variant.metafields.custom.images
                          if option_variant_gallery_images != blank
                            for option_variant_gallery_image in option_variant_gallery_images
                              assign option_variant_gallery_media = option_variant_gallery_image.value | default: option_variant_gallery_image
                              assign option_variant_gallery_type = option_variant_gallery_media.media_type | default: 'image'
                              assign option_variant_gallery_image_url = blank
                              assign option_variant_gallery_video_url = blank
                              assign option_variant_gallery_poster_url = blank

                              if option_variant_gallery_type == 'video'
                                if option_variant_gallery_media.sources != blank
                                  for option_variant_video_source in option_variant_gallery_media.sources
                                    assign option_variant_gallery_video_url = option_variant_video_source.url | default: option_variant_video_source.src
                                    if option_variant_gallery_video_url != blank
                                      break
                                    endif
                                  endfor
                                endif
                                if option_variant_gallery_media.preview_image != blank
                                  assign option_variant_gallery_poster_url = option_variant_gallery_media.preview_image | image_url: width: 584
                                endif
                              else
                                if option_variant_gallery_media.preview_image != blank
                                  assign option_variant_gallery_image_url = option_variant_gallery_media.preview_image | image_url: width: 584
                                elsif option_variant_gallery_media != blank
                                  assign option_variant_gallery_image_url = option_variant_gallery_media | image_url: width: 584
                                endif
                              endif

                              assign option_variant_gallery_token = blank
                              if option_variant_gallery_video_url != blank
                                assign option_variant_gallery_token = 'video::' | append: option_variant_gallery_video_url
                                if option_variant_gallery_poster_url != blank
                                  assign option_variant_gallery_token = option_variant_gallery_token | append: '::' | append: option_variant_gallery_poster_url
                                endif
                              elsif option_variant_gallery_image_url != blank and option_variant_gallery_image_url != option_swatch_image
                                assign option_variant_gallery_token = 'image::' | append: option_variant_gallery_image_url
                              endif

                              if option_variant_gallery_token != blank
                                assign option_swatch_gallery = option_swatch_gallery | append: '||' | append: option_variant_gallery_token
                              endif
                            endfor
                          endif
                          break
                        endif
                      endfor
                    endif

                    if option_swatch_hover_image == blank
                      for product_variant in recommended_product.variants
                        assign variant_color_value = blank
                        case option.position
                          when 1
                            assign variant_color_value = product_variant.option1
                          when 2
                            assign variant_color_value = product_variant.option2
                          when 3
                            assign variant_color_value = product_variant.option3
                        endcase
                        if variant_color_value == option_value.name
                          assign option_variant_hover_photo = product_variant.metafields.custom.sbv2_hover_photo.value | default: product_variant.metafields.custom.sbv2_hover_photo
                          if option_variant_hover_photo != blank
                            assign option_swatch_hover_image = option_variant_hover_photo | image_url: width: 584
                            break
                          endif
                        endif
                      endfor
                    endif

                    if option_swatch_color != blank and swatch_index < 4
                      assign swatch_index = swatch_index | plus: 1
                      case swatch_index
                        when 1
                          assign swatch_1 = option_swatch_color
                          assign swatch_1_image = option_swatch_image
                          assign swatch_1_hover_image = option_swatch_hover_image
                          assign swatch_1_gallery = option_swatch_gallery
                          assign swatch_1_variant_id = option_swatch_variant_id
                          assign swatch_1_price_text = option_swatch_price_text
                          assign swatch_1_compare_price_text = option_swatch_compare_price_text
                        when 2
                          assign swatch_2 = option_swatch_color
                          assign swatch_2_image = option_swatch_image
                          assign swatch_2_hover_image = option_swatch_hover_image
                          assign swatch_2_gallery = option_swatch_gallery
                          assign swatch_2_variant_id = option_swatch_variant_id
                          assign swatch_2_price_text = option_swatch_price_text
                          assign swatch_2_compare_price_text = option_swatch_compare_price_text
                        when 3
                          assign swatch_3 = option_swatch_color
                          assign swatch_3_image = option_swatch_image
                          assign swatch_3_hover_image = option_swatch_hover_image
                          assign swatch_3_gallery = option_swatch_gallery
                          assign swatch_3_variant_id = option_swatch_variant_id
                          assign swatch_3_price_text = option_swatch_price_text
                          assign swatch_3_compare_price_text = option_swatch_compare_price_text
                        when 4
                          assign swatch_4 = option_swatch_color
                          assign swatch_4_image = option_swatch_image
                          assign swatch_4_hover_image = option_swatch_hover_image
                          assign swatch_4_gallery = option_swatch_gallery
                          assign swatch_4_variant_id = option_swatch_variant_id
                          assign swatch_4_price_text = option_swatch_price_text
                          assign swatch_4_compare_price_text = option_swatch_compare_price_text
                      endcase
                    endif
                  endfor
                endif
              endfor
            %}

            <article class="sb-often-bought-together__item">
              {% render 'product-thumbnail',
                product: recommended_product,
                product_name: recommended_product.title,
                rating: product_rating,
                reviews_count_number: product_reviews_count,
                compare_price_text: product_compare_price_text,
                price_text: product_price_text,
                swatch_1: swatch_1,
                swatch_2: swatch_2,
                swatch_3: swatch_3,
                swatch_4: swatch_4,
                swatch_1_image: swatch_1_image,
                swatch_2_image: swatch_2_image,
                swatch_3_image: swatch_3_image,
                swatch_4_image: swatch_4_image,
                swatch_1_hover_image: swatch_1_hover_image,
                swatch_2_hover_image: swatch_2_hover_image,
                swatch_3_hover_image: swatch_3_hover_image,
                swatch_4_hover_image: swatch_4_hover_image,
                swatch_1_gallery: swatch_1_gallery,
                swatch_2_gallery: swatch_2_gallery,
                swatch_3_gallery: swatch_3_gallery,
                swatch_4_gallery: swatch_4_gallery,
                swatch_1_variant_id: swatch_1_variant_id,
                swatch_2_variant_id: swatch_2_variant_id,
                swatch_3_variant_id: swatch_3_variant_id,
                swatch_4_variant_id: swatch_4_variant_id,
                swatch_1_price_text: swatch_1_price_text,
                swatch_2_price_text: swatch_2_price_text,
                swatch_3_price_text: swatch_3_price_text,
                swatch_4_price_text: swatch_4_price_text,
                swatch_1_compare_price_text: swatch_1_compare_price_text,
                swatch_2_compare_price_text: swatch_2_compare_price_text,
                swatch_3_compare_price_text: swatch_3_compare_price_text,
                swatch_4_compare_price_text: swatch_4_compare_price_text,
                selected_swatch: 1,
                hide_reviews: product_hide_reviews,
                show_add_to_cart: true,
                show_compare_add_to_cart_large: false
              %}
            </article>
          {% endfor %}
        </div>
      </section>
    {% endif %}
  </sb-product-recommendations>
{% else %}
  <script>
    (() => {
      const sectionWrapper = document.currentScript && document.currentScript.closest('.shopify-section');
      if (sectionWrapper) {
        sectionWrapper.style.setProperty('display', 'none', 'important');
      }
    })();
  </script>
{% endunless %}

{% stylesheet %}
  .sb-often-bought-together {
    width: 100%;
  }

  .sb-often-bought-together__title {
    color: var(--sb-color-neutral-900);
    margin: 0 0 var(--sb-space-48);
    text-align: center;
  }

  .sb-often-bought-together__grid {
    align-items: stretch;
    column-gap: var(--sb-space-24);
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    margin: 0 auto;
    row-gap: var(--sb-space-24);
    width: 100%;
  }

  .sb-often-bought-together__item,
  .sb-often-bought-together__item .sb-product-thumbnail {
    min-width: 0;
    width: 100%;
  }

  .sb-often-bought-together__item {
    display: flex;
    margin: 0 !important;
    padding: 0 !important;
  }

  .sb-often-bought-together .sb-product-thumbnail {
    align-self: stretch !important;
    display: flex;
    flex-direction: column;
    height: 100%;
    margin: 0 !important;
    padding: 0 !important;
    width: 100%;
  }

  .sb-often-bought-together .sb-product-thumbnail__media-wrap {
    margin: 0 !important;
    padding: 0 !important;
    position: relative;
  }

  .sb-often-bought-together .sb-product-thumbnail__media {
    background: var(--sb-color-neutral-100);
    border-radius: var(--sb-space-24);
    box-shadow: 0 0 10px 0 var(--sb-color-always-black-12);
    display: block;
    overflow: hidden;
    position: relative;
    text-decoration: none;
    width: 100%;
  }

  .sb-often-bought-together .sb-product-thumbnail__badge {
    align-items: center;
    border-radius: var(--sb-space-12);
    color: var(--sb-color-always-white);
    display: inline-flex;
    left: var(--sb-space-16);
    padding: var(--sb-space-8) var(--sb-space-12);
    position: absolute;
    top: var(--sb-space-16);
    white-space: nowrap;
    z-index: 2;
  }

  .sb-often-bought-together .sb-product-thumbnail__badge--bestseller {
    background: var(--sb-color-red-500);
  }

  .sb-often-bought-together .sb-product-thumbnail__badge--new {
    background: var(--sb-color-primary-500);
  }

  .sb-often-bought-together .sb-product-thumbnail__media-item {
    aspect-ratio: 1 / 1;
    display: block;
    height: auto;
    object-fit: cover;
    width: 100%;
  }

  .sb-often-bought-together .sb-product-thumbnail__video.sb-product-thumbnail__media-item {
    background: var(--sb-color-neutral-100);
  }

  .sb-often-bought-together .sb-product-thumbnail__name {
    color: var(--sb-color-neutral-900);
    display: block;
    margin: var(--sb-space-16) 0 0;
    text-decoration: none;
    width: 100%;
  }

  .sb-often-bought-together .sb-product-thumbnail__name:hover,
  .sb-often-bought-together .sb-product-thumbnail__name:focus-visible {
    color: var(--sb-color-primary-500);
  }

  .sb-often-bought-together .sb-product-thumbnail__rating-row {
    align-items: center;
    display: flex;
    flex-wrap: wrap;
    gap: var(--sb-space-12);
    margin-top: var(--sb-space-8);
  }

  .sb-often-bought-together .sb-product-thumbnail__stars {
    align-items: center;
    display: inline-flex;
    gap: 4px;
    padding-bottom: var(--sb-space-2);
  }

  .sb-often-bought-together .sb-product-thumbnail__star {
    display: inline-block;
    height: var(--sb-space-20);
    position: relative;
    width: var(--sb-space-20);
  }

  .sb-often-bought-together .sb-product-thumbnail__star::before,
  .sb-often-bought-together .sb-product-thumbnail__star::after {
    content: '';
    display: block;
    height: 100%;
    left: 0;
    mask: center / contain no-repeat var(--sb-star-icon-url);
    position: absolute;
    top: 0;
    width: 100%;
    -webkit-mask: center / contain no-repeat var(--sb-star-icon-url);
  }

  .sb-often-bought-together .sb-product-thumbnail__star::before {
    background: var(--sb-color-neutral-900-50);
  }

  .sb-often-bought-together .sb-product-thumbnail__star::after {
    background: var(--sb-color-neutral-900);
    clip-path: inset(0 calc(100% - var(--sb-star-fill)) 0 0);
    -webkit-clip-path: inset(0 calc(100% - var(--sb-star-fill)) 0 0);
  }

  .sb-often-bought-together .sb-product-thumbnail__reviews {
    color: var(--sb-color-neutral-900);
    margin: 0;
    white-space: nowrap;
  }

  .sb-often-bought-together .sb-product-thumbnail__price-row {
    align-items: center;
    display: flex;
    gap: var(--sb-space-8);
    margin-top: var(--sb-space-8);
  }

  .sb-often-bought-together .sb-product-thumbnail__price {
    margin: 0;
  }

  .sb-often-bought-together .sb-product-thumbnail__price--compare {
    color: var(--sb-color-neutral-800);
    text-decoration: line-through;
  }

  .sb-often-bought-together .sb-product-thumbnail__price--current {
    color: var(--sb-color-blue-500);
  }

  .sb-often-bought-together .sb-product-thumbnail__add-to-cart {
    --sb-add-label-width: 3ch;
    --sb-add-gap: var(--sb-space-8);
    --sb-add-pill-padding: var(--sb-space-16);
    align-items: center;
    background: var(--sb-color-always-white);
    border: 0;
    border-radius: 500px;
    box-sizing: border-box;
    bottom: var(--sb-space-16);
    box-shadow: 0 0 24px 0 var(--sb-color-always-black-25);
    color: var(--sb-color-always-black);
    cursor: pointer;
    display: inline-flex;
    gap: 0;
    height: var(--sb-space-36);
    inline-size: max-content;
    justify-content: center;
    opacity: 0;
    overflow: hidden;
    padding-inline: calc((var(--sb-space-36) - var(--sb-space-16)) / 2);
    pointer-events: none;
    position: absolute;
    right: var(--sb-space-16);
    width: var(--sb-space-36);
    transition: width 140ms linear, opacity 140ms linear, gap 140ms linear, padding-inline 140ms linear;
    z-index: 2;
  }

  .sb-often-bought-together .sb-product-thumbnail__gallery-nav {
    align-items: center;
    background: transparent;
    border: 0;
    border-radius: 999px;
    box-shadow: 0 0 24px 0 var(--sb-color-always-black-25);
    cursor: pointer;
    display: inline-flex;
    height: var(--sb-space-36);
    justify-content: center;
    opacity: 0;
    padding: 0;
    pointer-events: none;
    position: absolute;
    top: 50%;
    transition: opacity 120ms, transform 120ms;
    width: var(--sb-space-36);
    z-index: 2;
  }

  .sb-often-bought-together .sb-product-thumbnail__gallery-nav--left {
    left: var(--sb-space-16);
    transform: translate(calc(-1 * var(--sb-space-8)), -50%);
  }

  .sb-often-bought-together .sb-product-thumbnail__gallery-nav--right {
    right: var(--sb-space-16);
    transform: translate(var(--sb-space-8), -50%);
  }

  .sb-often-bought-together .sb-product-thumbnail__media-wrap:hover .sb-product-thumbnail__gallery-nav,
  .sb-often-bought-together .sb-product-thumbnail__gallery-nav:focus-visible {
    opacity: 1;
    pointer-events: auto;
    transform: translate(0, -50%);
  }

  .sb-often-bought-together .sb-product-thumbnail__gallery-nav-icon {
    display: block;
    height: var(--sb-space-36);
    width: var(--sb-space-36);
  }

  .sb-often-bought-together .sb-product-thumbnail__gallery-nav--right .sb-product-thumbnail__gallery-nav-icon {
    transform: rotate(180deg);
  }

  .sb-often-bought-together .sb-product-thumbnail__gallery-nav-icon svg {
    display: block;
    height: 100%;
    width: 100%;
  }

  .sb-often-bought-together .sb-product-thumbnail__gallery-nav-icon svg path:first-child {
    fill: var(--sb-color-always-white);
  }

  .sb-often-bought-together .sb-product-thumbnail__gallery-nav-icon svg path:last-child {
    fill: var(--sb-color-always-black);
  }

  .sb-often-bought-together .sb-product-thumbnail__gallery-nav:hover .sb-product-thumbnail__gallery-nav-icon svg path:last-child,
  .sb-often-bought-together .sb-product-thumbnail__gallery-nav:focus-visible .sb-product-thumbnail__gallery-nav-icon svg path:last-child {
    fill: var(--sb-color-primary-500);
  }

  .sb-often-bought-together .sb-product-thumbnail__media-wrap:hover .sb-product-thumbnail__add-to-cart,
  .sb-often-bought-together .sb-product-thumbnail__add-to-cart:focus-visible,
  .sb-often-bought-together .sb-product-thumbnail__add-to-cart.is-added,
  .sb-often-bought-together .sb-product-thumbnail__add-to-cart.is-loading {
    opacity: 1;
    pointer-events: auto;
  }

  .sb-often-bought-together .sb-product-thumbnail__add-to-cart:hover,
  .sb-often-bought-together .sb-product-thumbnail__add-to-cart:focus-visible {
    gap: var(--sb-add-gap);
    width: calc((var(--sb-add-pill-padding) * 2) + var(--sb-space-16) + var(--sb-add-gap) + var(--sb-add-label-width));
    padding-inline: var(--sb-add-pill-padding);
  }

  .sb-often-bought-together .sb-product-thumbnail__add-to-cart.is-loading {
    gap: var(--sb-add-gap);
    width: calc((var(--sb-add-pill-padding) * 2) + var(--sb-space-16) + var(--sb-add-gap) + var(--sb-add-label-width));
    padding-inline: var(--sb-add-pill-padding);
  }

  .sb-often-bought-together .sb-product-thumbnail__add-to-cart.is-added {
    --sb-add-label-width: 5ch;
    gap: var(--sb-add-gap);
    width: calc((var(--sb-add-pill-padding) * 2) + var(--sb-space-16) + var(--sb-add-gap) + var(--sb-add-label-width));
    padding-inline: var(--sb-add-pill-padding);
  }

  .sb-often-bought-together .sb-product-thumbnail__add-to-cart-icon-image {
    display: block;
    flex: 0 0 var(--sb-space-16);
    filter: var(--sb-add-icon-filter, brightness(0));
    height: var(--sb-space-16);
    max-width: none;
    object-fit: contain;
    width: var(--sb-space-16);
  }

  .sb-often-bought-together .sb-product-thumbnail__add-to-cart-label {
    color: var(--sb-color-always-black);
    display: inline-block;
    max-width: 0;
    opacity: 0;
    overflow: hidden;
    transition: max-width 140ms linear, opacity 140ms linear;
    white-space: nowrap;
  }

  .sb-often-bought-together .sb-product-thumbnail__add-to-cart:hover .sb-product-thumbnail__add-to-cart-label,
  .sb-often-bought-together .sb-product-thumbnail__add-to-cart:focus-visible .sb-product-thumbnail__add-to-cart-label,
  .sb-often-bought-together .sb-product-thumbnail__add-to-cart.is-added .sb-product-thumbnail__add-to-cart-label,
  .sb-often-bought-together .sb-product-thumbnail__add-to-cart.is-loading .sb-product-thumbnail__add-to-cart-label {
    opacity: 1;
    max-width: var(--sb-add-label-width);
  }

  .sb-often-bought-together .sb-product-thumbnail__add-to-cart:hover .sb-product-thumbnail__add-to-cart-label,
  .sb-often-bought-together .sb-product-thumbnail__add-to-cart:focus-visible .sb-product-thumbnail__add-to-cart-label {
    color: var(--sb-color-primary-500);
  }

  .sb-often-bought-together .sb-product-thumbnail__add-to-cart:hover .sb-product-thumbnail__add-to-cart-icon-image,
  .sb-often-bought-together .sb-product-thumbnail__add-to-cart:focus-visible .sb-product-thumbnail__add-to-cart-icon-image {
    --sb-add-icon-filter: brightness(0) saturate(100%) invert(45%) sepia(80%) saturate(808%) hue-rotate(134deg)
      brightness(91%) contrast(96%);
  }

  .sb-often-bought-together .sb-product-thumbnail__carousel {
    display: block;
    overflow: hidden;
    width: 100%;
  }

  .sb-often-bought-together .sb-product-thumbnail__carousel-track {
    display: flex;
    transform: translate3d(0, 0, 0);
    transition: transform 180ms linear;
    width: 100%;
  }

  .sb-often-bought-together .sb-product-thumbnail__carousel-track.is-instant {
    transition: none;
  }

  .sb-often-bought-together .sb-product-thumbnail__carousel-slide {
    flex: 0 0 100%;
    width: 100%;
  }

  .sb-often-bought-together .sb-product-thumbnail__gallery-sources {
    display: none;
  }

  .sb-often-bought-together .sb-product-thumbnail__swatches {
    align-items: center;
    display: flex;
    gap: var(--sb-space-8);
    margin-top: var(--sb-space-8);
    min-height: var(--sb-space-36);
  }

  .sb-often-bought-together .sb-product-thumbnail__swatches.is-empty {
    display: none;
    pointer-events: none;
  }

  @media (hover: none) {
    .sb-often-bought-together .sb-product-thumbnail__add-to-cart {
      opacity: 1;
      pointer-events: auto;
    }
  }

  @media (min-width: 990px) {
    .sb-often-bought-together__grid {
      grid-template-columns: repeat(4, minmax(0, 292px));
      width: min(100%, 1240px);
    }
  }
{% endstylesheet %}

<script>
  (() => {
    const initOftenBoughtTogetherThumbnails = (scope = document) => {
      const roots = scope.querySelectorAll('.sb-often-bought-together');
      if (!roots.length) return;
      const variantUpdateEvent = window.SBProductThumbnail?.ThemeEvents?.variantUpdate || 'variant:update';

      const parseGalleryToken = (token) => {
        const raw = (token || '').trim();
        if (!raw) return null;
        const parts = raw.split('::');
        if (parts.length > 1) {
          const type = parts[0] === 'video' ? 'video' : 'image';
          const src = (parts[1] || '').trim();
          const poster = (parts[2] || '').trim();
          if (!src) return null;
          return { type, src, poster };
        }
        const lowerRaw = raw.toLowerCase();
        if (lowerRaw.includes('.mp4') || lowerRaw.includes('.webm') || lowerRaw.includes('.m3u8')) {
          return { type: 'video', src: raw, poster: '' };
        }
        return { type: 'image', src: raw, poster: '' };
      };

      const buildMediaNode = (item, loading = 'lazy') => {
        if (!item || !item.src) return null;
        const baseClassName = 'sb-product-thumbnail__media-item';
        if (item.type === 'video') {
          const video = document.createElement('video');
          video.className = `${baseClassName} sb-product-thumbnail__video`;
          video.src = item.src;
          video.autoplay = true;
          video.muted = true;
          video.loop = true;
          video.playsInline = true;
          video.setAttribute('playsinline', 'true');
          if (item.poster) video.poster = item.poster;
          return video;
        }
        const image = document.createElement('img');
        image.className = `${baseClassName} sb-product-thumbnail__image`;
        image.src = item.src;
        image.loading = loading;
        image.decoding = 'async';
        return image;
      };

      const getSourceItems = (mediaWrap) => {
        const fromSources = Array.from(mediaWrap.querySelectorAll('.sb-product-thumbnail__gallery-image-source'))
          .map((node) => parseGalleryToken(node.dataset.galleryImage || ''))
          .filter(Boolean);
        if (fromSources.length) return fromSources;

        const mediaItem = mediaWrap.querySelector('.sb-product-thumbnail__media-item');
        if (mediaItem instanceof HTMLVideoElement) {
          return [{ type: 'video', src: mediaItem.currentSrc || mediaItem.src || '', poster: mediaItem.poster || '' }].filter((item) => item.src);
        }
        if (mediaItem instanceof HTMLImageElement && mediaItem.src) {
          return [{ type: 'image', src: mediaItem.src, poster: '' }];
        }
        return [];
      };

      const updateSlide = (mediaWrap, nextIndex) => {
        const track = mediaWrap.querySelector('.sb-product-thumbnail__carousel-track');
        if (!track) return;
        const slides = Array.from(track.children);
        const total = slides.length;
        if (!total) return;
        const wrapped = ((nextIndex % total) + total) % total;
        track.style.transform = `translate3d(${-wrapped * 100}%, 0, 0)`;
        slides.forEach((slide, idx) => slide.setAttribute('aria-hidden', idx === wrapped ? 'false' : 'true'));
        mediaWrap.dataset.galleryIndex = `${wrapped}`;
      };

      const renderMediaFromSources = (mediaWrap, sourceItems) => {
        const mediaLink = mediaWrap.querySelector('.sb-product-thumbnail__media');
        if (!mediaLink) return;

        const normalizedItems = sourceItems.filter((item) => item && item.src);
        if (!normalizedItems.length) return;

        mediaLink
          .querySelectorAll(':scope > .sb-product-thumbnail__media-item, :scope > .sb-product-thumbnail__carousel, :scope > .sb-product-thumbnail__image-placeholder')
          .forEach((node) => node.remove());

        if (normalizedItems.length > 1) {
          const carousel = document.createElement('div');
          carousel.className = 'sb-product-thumbnail__carousel';
          const track = document.createElement('div');
          track.className = 'sb-product-thumbnail__carousel-track is-instant';
          carousel.appendChild(track);

          normalizedItems.forEach((item, index) => {
            const slide = document.createElement('div');
            slide.className = 'sb-product-thumbnail__carousel-slide';
            slide.setAttribute('aria-hidden', index === 0 ? 'false' : 'true');
            const node = buildMediaNode(item, index === 0 ? 'eager' : 'lazy');
            if (node) slide.appendChild(node);
            track.appendChild(slide);
          });

          mediaLink.appendChild(carousel);
          mediaWrap.dataset.galleryIndex = '0';
          updateSlide(mediaWrap, 0);
          requestAnimationFrame(() => track.classList.remove('is-instant'));
        } else {
          const node = buildMediaNode(normalizedItems[0], 'eager');
          if (node) mediaLink.appendChild(node);
          mediaWrap.dataset.galleryIndex = '0';
        }

        mediaWrap.querySelectorAll('[data-gallery-nav]').forEach((button) => {
          button.hidden = normalizedItems.length < 2;
        });
      };

      const mediaLoadPromiseCache = new Map();
      const ensureMediaReady = (item) => {
        if (!item || !item.src) return Promise.resolve();
        if (mediaLoadPromiseCache.has(item.src)) return mediaLoadPromiseCache.get(item.src);

        const mediaReadyPromise = new Promise((resolve) => {
          if (item.type === 'video') {
            const video = document.createElement('video');
            const done = () => resolve();
            video.preload = 'auto';
            video.muted = true;
            video.playsInline = true;
            video.src = item.src;
            if (item.poster) video.poster = item.poster;
            video.addEventListener('loadeddata', done, { once: true });
            video.addEventListener('canplay', done, { once: true });
            video.addEventListener('error', done, { once: true });
            video.load();
            return;
          }

          const image = new Image();
          const done = () => resolve();
          image.decoding = 'async';
          image.onload = done;
          image.onerror = done;
          image.src = item.src;
          if (image.complete) resolve();
        });

        mediaLoadPromiseCache.set(item.src, mediaReadyPromise);
        return mediaReadyPromise;
      };

      const setFirstSlideImage = (mediaWrap, nextSource) => {
        const nextSrc = String(nextSource || '').trim();
        if (!nextSrc) return;
        const mediaLink = mediaWrap.querySelector('.sb-product-thumbnail__media');
        if (!mediaLink) return;

        const firstSlide = mediaLink.querySelector('.sb-product-thumbnail__carousel-slide');
        const standaloneMedia = mediaLink.querySelector(':scope > .sb-product-thumbnail__media-item');
        const currentMedia = firstSlide
          ? firstSlide.querySelector('.sb-product-thumbnail__media-item')
          : standaloneMedia;
        if (!currentMedia) return;

        const currentSrc = currentMedia.currentSrc || currentMedia.getAttribute('src') || '';
        if (currentMedia.tagName.toLowerCase() === 'img' && currentSrc === nextSrc) return;

        const token = String((Number(mediaWrap.dataset.firstSlideSwapToken || '0') || 0) + 1);
        mediaWrap.dataset.firstSlideSwapToken = token;
        const applyIfCurrent = (callback) => {
          if (mediaWrap.dataset.firstSlideSwapToken !== token) return;
          callback();
        };

        const preload = new Image();
        preload.decoding = 'async';
        preload.src = nextSrc;

        const apply = () => {
          applyIfCurrent(() => {
            if (currentMedia.tagName.toLowerCase() === 'img') {
              currentMedia.setAttribute('src', nextSrc);
              currentMedia.removeAttribute('srcset');
              currentMedia.setAttribute('loading', 'eager');
            } else {
              const replacement = document.createElement('img');
              replacement.className = 'sb-product-thumbnail__media-item sb-product-thumbnail__image';
              replacement.loading = 'eager';
              replacement.decoding = 'async';
              replacement.src = nextSrc;
              replacement.alt = currentMedia.getAttribute('aria-label') || '';
              currentMedia.replaceWith(replacement);
            }
          });
        };

        if (preload.complete) {
          apply();
        } else {
          preload.addEventListener('load', apply, { once: true });
        }
      };

      const setGallerySources = (mediaWrap, sourceItems) => {
        let sourcesContainer = mediaWrap.querySelector('.sb-product-thumbnail__gallery-sources');
        if (!sourcesContainer) {
          sourcesContainer = document.createElement('div');
          sourcesContainer.className = 'sb-product-thumbnail__gallery-sources';
          sourcesContainer.setAttribute('aria-hidden', 'true');
          mediaWrap.appendChild(sourcesContainer);
        }

        sourcesContainer.innerHTML = '';
        sourceItems.forEach((item) => {
          if (!item || !item.src) return;
          const sourceNode = document.createElement('span');
          sourceNode.className = 'sb-product-thumbnail__gallery-image-source';
          const token =
            item.type === 'video'
              ? `video::${item.src}${item.poster ? `::${item.poster}` : ''}`
              : `image::${item.src}`;
          sourceNode.dataset.galleryImage = token;
          sourcesContainer.appendChild(sourceNode);
        });
      };

      roots.forEach((root) => {
        if (root.dataset.sbObtThumbnailsInitialized === 'true') return;
        root.dataset.sbObtThumbnailsInitialized = 'true';

        if (window.SBProductThumbnail && typeof window.SBProductThumbnail.initThumbnailMediaScope === 'function') {
          window.SBProductThumbnail.initThumbnailMediaScope(root, { initSwatchInteractions: true });
        } else {
          root.querySelectorAll('.sb-product-thumbnail__media-wrap').forEach((mediaWrap) => {
            renderMediaFromSources(mediaWrap, getSourceItems(mediaWrap));

            if (mediaWrap.dataset.galleryNavBound !== 'true') {
              mediaWrap.dataset.galleryNavBound = 'true';
              mediaWrap.querySelectorAll('[data-gallery-nav]').forEach((button) => {
                button.addEventListener('click', (event) => {
                  event.preventDefault();
                  event.stopPropagation();
                  const delta = Number.parseInt(button.dataset.galleryNav || '0', 10);
                  if (!Number.isFinite(delta) || delta === 0) return;
                  const currentIndex = Number.parseInt(mediaWrap.dataset.galleryIndex || '0', 10) || 0;
                  updateSlide(mediaWrap, currentIndex + delta);
                });
              });
            }
          });

          root.querySelectorAll('.sb-product-thumbnail__swatches').forEach((row) => {
            const applySwatchMedia = async (swatchButton, sourceId = '') => {
              if (!swatchButton) return;
              const thumbnail = row.closest('.sb-product-thumbnail');
              if (!thumbnail) return;
              const mediaWrap = thumbnail.querySelector('.sb-product-thumbnail__media-wrap');
              if (!mediaWrap) return;
              const swatchSwapToken = String((Number(mediaWrap.dataset.swatchSwapToken || '0') || 0) + 1);
              mediaWrap.dataset.swatchSwapToken = swatchSwapToken;

              const nextImage = (swatchButton.dataset.thumbnailImage || '').trim();
              const nextGallery = (swatchButton.dataset.thumbnailGallery || '').trim();
              const isPreviewSource =
                sourceId === 'product-thumbnail-swatch-hover' || sourceId === 'product-thumbnail-swatch-focus';

              if (isPreviewSource) {
                if (!nextImage) return;
                await ensureMediaReady({ type: 'image', src: nextImage, poster: '' });
                if (mediaWrap.dataset.swatchSwapToken !== swatchSwapToken) return;
                setFirstSlideImage(mediaWrap, nextImage);
                return;
              }

              let nextSourceItems = nextGallery
                .split('||')
                .map((token) => parseGalleryToken(token))
                .filter(Boolean);

              if (!nextSourceItems.length && nextImage) {
                nextSourceItems = [{ type: 'image', src: nextImage, poster: '' }];
              }

              if (!nextSourceItems.length) return;
              await ensureMediaReady(nextSourceItems[0]);
              if (mediaWrap.dataset.swatchSwapToken !== swatchSwapToken) return;
              setGallerySources(mediaWrap, nextSourceItems);
              renderMediaFromSources(mediaWrap, nextSourceItems);
            };

            row.addEventListener(variantUpdateEvent, (event) => {
              const swatchButton = event?.detail?.data?.swatchButton;
              if (!(swatchButton instanceof HTMLElement)) return;
              if (!row.contains(swatchButton)) return;
              applySwatchMedia(swatchButton, String(event?.detail?.sourceId || ''));
            });
          });

          if (window.SBProductThumbnail && typeof window.SBProductThumbnail.initSwatchInteractionScope === 'function') {
            window.SBProductThumbnail.initSwatchInteractionScope(root);
          }
        }

        root.querySelectorAll('[data-add-to-cart]').forEach((button) => {
          const resetToDefault = () => {
            const resetLabel = button.querySelector('[data-add-to-cart-label]');
            const resetIcon = button.querySelector('.sb-product-thumbnail__add-to-cart-icon-image');
            const defaultLabel = button.dataset.labelDefault || 'Add';
            if (resetLabel) resetLabel.textContent = defaultLabel;
            if (resetIcon && resetIcon.dataset.addIcon) resetIcon.setAttribute('src', resetIcon.dataset.addIcon);
            button.classList.remove('is-added');
            button.setAttribute('aria-label', defaultLabel);
          };

          const scheduleReset = () => {
            const existingTimer = Number.parseInt(button.dataset.resetTimerId || '', 10);
            if (Number.isFinite(existingTimer)) clearTimeout(existingTimer);
            const timerId = window.setTimeout(() => {
              delete button.dataset.resetTimerId;
              resetToDefault();
            }, 1400);
            button.dataset.resetTimerId = `${timerId}`;
          };

          button.addEventListener('click', async (event) => {
            event.preventDefault();
            event.stopPropagation();
            if (button.classList.contains('is-loading')) return;

            const variantId = Number.parseInt(button.dataset.variantId || '', 10);
            if (!Number.isFinite(variantId) || variantId <= 0) return;

            const label = button.querySelector('[data-add-to-cart-label]');
            const icon = button.querySelector('.sb-product-thumbnail__add-to-cart-icon-image');
            const labelAdded = button.dataset.labelAdded || 'Added';

            button.classList.add('is-loading');
            try {
              if (window.SBCart && typeof window.SBCart.add === 'function') {
                await window.SBCart.add(variantId, {
                  quantity: 1,
                  sourceElement: button
                });
              } else {
                const response = await fetch('/cart/add.js', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json', Accept: 'application/json' },
                  credentials: 'same-origin',
                  body: JSON.stringify({ id: variantId, quantity: 1 })
                });
                if (!response.ok) throw new Error('Add to cart failed');
              }

              if (label) label.textContent = labelAdded;
              if (icon && icon.dataset.checkIcon) icon.setAttribute('src', icon.dataset.checkIcon);
              button.classList.add('is-added');
              button.setAttribute('aria-label', labelAdded);
              scheduleReset();
            } catch (_) {
              resetToDefault();
            } finally {
              button.classList.remove('is-loading');
            }
          });
        });
      });
    };

    window.SBInitOftenBoughtTogetherThumbnails = initOftenBoughtTogetherThumbnails;
    initOftenBoughtTogetherThumbnails(document);
    document.addEventListener('shopify:section:load', (event) => {
      initOftenBoughtTogetherThumbnails(event.target);
    });

    if (customElements.get('sb-product-recommendations')) return;

    class SbProductRecommendations extends HTMLElement {
      showSection() {
        const sectionWrapper = this.closest('.shopify-section');
        if (sectionWrapper) {
          sectionWrapper.style.removeProperty('display');
        }
        this.hidden = false;
      }

      hideSection() {
        this.hidden = true;
        const sectionWrapper = this.closest('.shopify-section');
        if (sectionWrapper) {
          sectionWrapper.style.display = 'none';
        }
      }

      connectedCallback() {
        if (this.dataset.recommendationsPerformed === 'true') {
          this.showSection();
          return;
        }
        if (this.dataset.loading === 'true') return;

        this.hideSection();
        this.loadRecommendations();
      }

      async loadRecommendations() {
        const url = this.dataset.url;
        if (!url) {
          this.hideSection();
          return;
        }

        this.dataset.loading = 'true';

        try {
          const response = await fetch(url, { credentials: 'same-origin' });
          if (!response.ok) {
            this.hideSection();
            return;
          }

          const html = document.createElement('div');
          html.innerHTML = await response.text();
          const nextSection = html.querySelector(`sb-product-recommendations#${this.id}`);

          if (nextSection && nextSection.innerHTML.trim().length > 0) {
            this.innerHTML = nextSection.innerHTML;
            this.dataset.recommendationsPerformed = 'true';
            this.showSection();
            if (typeof window.SBInitOftenBoughtTogetherThumbnails === 'function') {
              window.SBInitOftenBoughtTogetherThumbnails(this);
            }
          } else {
            this.hideSection();
          }
        } catch (error) {
          this.hideSection();
        } finally {
          delete this.dataset.loading;
        }
      }
    }

    customElements.define('sb-product-recommendations', SbProductRecommendations);
  })();
</script>

{% schema %}
{
  "name": "Often bought together",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section title",
      "default": "Often bought together"
    }
  ],
  "presets": [
    {
      "name": "Often bought together"
    }
  ],
  "enabled_on": {
    "templates": ["product"]
  }
}
{% endschema %}
