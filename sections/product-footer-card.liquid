{% liquid
  assign use_product_metaobjects = section.settings.use_product_metaobjects
  assign hide_section = false

  assign source_image_desktop = section.settings.background_image_desktop
  assign source_image_mobile = section.settings.background_image_mobile

  if request.page_type == 'product' and product != blank and use_product_metaobjects
    assign footer_card_ref = product.metafields.custom.sbv2_footer_card.value | default: product.metafields.custom.sbv2_footer_card

    if footer_card_ref != blank
      assign source_image_desktop = footer_card_ref.background_image_desktop.value | default: footer_card_ref.background_image_desktop
      assign source_image_mobile = footer_card_ref.background_image_mobile.value | default: footer_card_ref.background_image_mobile
    else
      assign hide_section = true
    endif
  endif

  assign image_desktop_fallback = 'hero-card-placeholder-desktop.jpg' | asset_url
  assign image_mobile_fallback = 'hero-card-placeholder-mobile.jpg' | asset_url

  if source_image_mobile != blank
    assign mobile_request_width = source_image_mobile.width | at_most: 1206
    assign image_mobile = source_image_mobile | image_url: width: mobile_request_width
  else
    assign image_mobile = image_mobile_fallback
  endif

  if source_image_desktop != blank
    assign desktop_request_width = source_image_desktop.width | at_most: 2480
    assign image_desktop = source_image_desktop | image_url: width: desktop_request_width
  else
    assign image_desktop = image_desktop_fallback
  endif

  assign selected_variant = product.selected_or_first_available_variant
  assign initial_variant_id = selected_variant.id
  assign initial_price = selected_variant.price | default: 0
  assign initial_compare_price = selected_variant.compare_at_price | default: 0
%}

{% if hide_section %}
  <script>
    (() => {
      const sectionWrapper = document.currentScript && document.currentScript.closest('.shopify-section');
      if (sectionWrapper) {
        sectionWrapper.style.setProperty('display', 'none', 'important');
      }
    })();
  </script>
{% else %}
  <section
    class="sb-product-footer-card"
    data-product-footer-card
    data-product-id="{{ product.id }}"
    data-currency="{{ cart.currency.iso_code | default: shop.currency }}"
    data-initial-variant-id="{{ initial_variant_id }}"
    data-initial-price="{{ initial_price }}"
    data-initial-compare-price="{{ initial_compare_price }}"
    data-sb-reveal
  >
    <div
      class="sb-product-footer-card__frame"
      data-sb-reveal-item
      style="--sb-footer-card-bg-mobile: url('{{ image_mobile }}'); --sb-footer-card-bg-desktop: url('{{ image_desktop }}');"
    >
      <div class="sb-product-footer-card__content">
        <h2 class="sb-product-footer-card__headline font-title weight-bold">Not happy? Get your money back!</h2>
        <p class="sb-product-footer-card__subheadline font-body weight-semibold">
          Test risk free with 30-day money-back guarantee.
        </p>

        <form method="post" action="/cart/add" class="sb-product-footer-card__form" data-footer-card-form>
          <input type="hidden" name="id" value="{{ initial_variant_id }}" data-footer-card-variant-id>
          <button
            type="submit"
            class="sb-product-footer-card__button sb-button-radiant sb-button-radiant--large sb-button-radiant--leading-icon font-caption weight-bold"
            aria-label="Add to cart"
            data-footer-card-submit
          >
            <span class="sb-product-footer-card__button-icon" aria-hidden="true">
              <img
                class="sb-product-footer-card__button-icon-image"
                src="{{ 'icon-add-to-cart.svg' | asset_url }}"
                alt=""
                width="16"
                height="16"
              >
            </span>

            <span class="sb-product-footer-card__button-copy">
              <span class="sb-product-footer-card__button-label" data-footer-card-button-label>Add to cart</span>
              <span class="sb-product-footer-card__button-prices">
                <span class="sb-product-footer-card__button-price sb-product-footer-card__button-price--compare" data-footer-card-compare-price></span>
                <span class="sb-product-footer-card__button-price sb-product-footer-card__button-price--current" data-footer-card-current-price></span>
              </span>
            </span>
          </button>
        </form>
      </div>
    </div>
  </section>
{% endif %}

{% stylesheet %}
  .sb-product-footer-card {
    width: 100%;
  }

  .sb-product-footer-card__frame {
    align-items: flex-start;
    background: var(--sb-color-neutral-200);
    background-image: var(--sb-footer-card-bg-mobile);
    background-position: 50% center;
    background-repeat: no-repeat;
    background-size: cover;
    border-radius: var(--sb-radius-card);
    display: flex;
    min-height: 380px;
    padding: var(--sb-space-64);
    width: 100%;
  }

  .sb-product-footer-card__content {
    display: flex;
    flex-direction: column;
    gap: var(--sb-space-20);
    max-width: 580px;
    text-align: center;
    width: 100%;
  }

  .sb-product-footer-card__headline,
  .sb-product-footer-card__subheadline {
    color: var(--sb-color-neutral-900);
    margin: 0;
  }

  .sb-product-footer-card__form {
    margin-top: var(--sb-space-4);
    width: 100%;
  }

  .sb-product-footer-card__button {
    justify-content: center;
    width: 100%;
  }

  .sb-product-footer-card__button-icon {
    align-items: center;
    display: inline-flex;
    justify-content: center;
    width: var(--sb-space-16);
  }

  .sb-product-footer-card__button-icon-image {
    display: block;
    height: var(--sb-space-16);
    width: var(--sb-space-16);
  }

  .sb-product-footer-card__button-copy {
    align-items: center;
    display: inline-flex;
    gap: var(--sb-space-4);
    justify-content: center;
  }

  .sb-product-footer-card__button-prices {
    align-items: center;
    display: inline-flex;
    gap: var(--sb-space-4);
  }

  .sb-product-footer-card__button-price {
    line-height: 1;
  }

  .sb-product-footer-card__button-price--compare {
    color: var(--sb-color-neutral-900);
    text-decoration: line-through;
  }

  .sb-product-footer-card__button-price--compare[hidden] {
    display: none;
  }

  @media (min-width: 750px) {
    .sb-product-footer-card__frame {
      align-items: center;
      background-image: var(--sb-footer-card-bg-desktop);
      background-position: 75% center;
    }

    .sb-product-footer-card__content {
      text-align: left;
    }

    .sb-product-footer-card__button {
      justify-content: flex-start;
      width: fit-content;
    }
  }
{% endstylesheet %}

{% javascript %}
  (() => {
    const sections = Array.from(document.querySelectorAll('[data-product-footer-card]'));
    if (!sections.length) return;

    sections.forEach((section) => {
      if (section.dataset.footerCardInit === 'true') return;
      section.dataset.footerCardInit = 'true';

      const variantIdInput = section.querySelector('[data-footer-card-variant-id]');
      const currentPriceElement = section.querySelector('[data-footer-card-current-price]');
      const comparePriceElement = section.querySelector('[data-footer-card-compare-price]');
      const submitButton = section.querySelector('[data-footer-card-submit]');
      const buttonLabel = section.querySelector('[data-footer-card-button-label]');
      const form = section.querySelector('[data-footer-card-form]');
      const currencyCode = section.dataset.currency || 'USD';
      const productId = section.dataset.productId || '';
      if (!variantIdInput || !currentPriceElement || !comparePriceElement || !submitButton || !buttonLabel || !form) return;

      const formatter = new Intl.NumberFormat(undefined, {
        style: 'currency',
        currency: currencyCode,
      });

      const formatMoney = (centsValue) => {
        const amount = Number(centsValue) || 0;
        return formatter.format(amount / 100);
      };

      const applyVariant = (variant) => {
        if (!variant || !variant.id) return;
        variantIdInput.value = `${variant.id}`;
        currentPriceElement.textContent = formatMoney(variant.price);

        const hasCompare = Number(variant.compare_at_price) > Number(variant.price);
        if (hasCompare) {
          comparePriceElement.textContent = formatMoney(variant.compare_at_price);
          comparePriceElement.hidden = false;
        } else {
          comparePriceElement.hidden = true;
          comparePriceElement.textContent = '';
        }
      };

      applyVariant({
        id: Number(section.dataset.initialVariantId || '0'),
        price: Number(section.dataset.initialPrice || '0'),
        compare_at_price: Number(section.dataset.initialComparePrice || '0'),
      });

      document.addEventListener('variant:update', (event) => {
        const variant = event?.detail?.resource;
        const eventProductId = event?.detail?.data?.productId;
        if (!variant || `${eventProductId || ''}` !== `${productId}`) return;
        applyVariant(variant);
      });

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const variantId = Number(variantIdInput.value || '0');
        if (!variantId) return;

        submitButton.disabled = true;
        const originalLabel = buttonLabel.textContent;
        buttonLabel.textContent = 'Adding...';

        try {
          if (window.SBCart && typeof window.SBCart.add === 'function') {
            await window.SBCart.add(variantId, {
              sourceId: `pdp-footer-card-${variantId}`,
              sourceData: {
                source: 'product-footer-card',
              },
            });
          } else {
            throw new Error('SBCart unavailable');
          }

          buttonLabel.textContent = 'Added';
          window.setTimeout(() => {
            buttonLabel.textContent = originalLabel;
            submitButton.disabled = false;
          }, 1200);
        } catch (error) {
          buttonLabel.textContent = originalLabel;
          submitButton.disabled = false;
        }
      });
    });
  })();
{% endjavascript %}

{% schema %}
{
  "name": "Product footer card",
  "enabled_on": {
    "templates": ["product"]
  },
  "settings": [
    {
      "type": "checkbox",
      "id": "use_product_metaobjects",
      "label": "Use product page metaobjects",
      "default": true
    },
    {
      "type": "image_picker",
      "id": "background_image_desktop",
      "label": "Background image desktop",
      "info": "Target minimum 1240x380 at 2x export (2480x760)."
    },
    {
      "type": "image_picker",
      "id": "background_image_mobile",
      "label": "Background image mobile",
      "info": "Target minimum 603x380 at 2x export (1206x760)."
    }
  ],
  "presets": [
    {
      "name": "Product footer card"
    }
  ]
}
{% endschema %}
