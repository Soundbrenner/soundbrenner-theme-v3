<section class="sb-feature-carousel" data-sb-carousel data-sb-reveal>
  {% if section.settings.title != blank %}
    <h2 class="sb-feature-carousel__title font-title weight-bold" data-sb-reveal-item>{{ section.settings.title }}</h2>
  {% endif %}

  <div class="sb-feature-carousel__viewport" data-sb-carousel-viewport>
    <div class="sb-feature-carousel__track" data-sb-carousel-track>
      {% for block in section.blocks %}
        {% assign item_image = block.settings.image %}
        {% assign item_video = block.settings.video %}
        {% if item_image != blank %}
          {% assign item_image_request_width = item_image.width | at_most: 864 %}
          {% assign item_image_url = item_image | image_url: width: item_image_request_width %}
        {% else %}
          {% assign item_image_url = 'feature-carousel-placeholder.jpg' | asset_url %}
        {% endif %}

        <article class="sb-feature-carousel__item" data-sb-carousel-item data-sb-reveal-item {{ block.shopify_attributes }}>
          <div class="sb-feature-carousel__media">
            {% if item_video != blank %}
              {{
                item_video
                | video_tag:
                  class: 'sb-feature-carousel__media-video',
                  controls: true,
                  autoplay: false,
                  loop: false,
                  muted: false,
                  image_size: '864x',
                  preload: 'metadata'
              }}
            {% else %}
              <img
                src="{{ item_image_url }}"
                alt="{{ item_image.alt | default: block.settings.body | strip_html | truncate: 80 | escape }}"
                loading="lazy"
                width="283"
                height="283"
              >
            {% endif %}
          </div>
          <div class="sb-feature-carousel__body font-body weight-regular rte">
            {{ block.settings.body }}
          </div>
        </article>
      {% endfor %}
    </div>
  </div>

  <div class="sb-feature-carousel__controls" data-sb-carousel-controls>
    <button type="button" class="sb-feature-carousel__arrow" data-sb-carousel-prev aria-label="Previous" disabled>
      <span class="sb-feature-carousel__arrow-icon sb-feature-carousel__arrow-icon--left" aria-hidden="true">
        {{ 'icon-carousel-arrow-left-filled.svg' | inline_asset_content }}
      </span>
    </button>

    <button type="button" class="sb-feature-carousel__arrow" data-sb-carousel-next aria-label="Next" disabled>
      <span class="sb-feature-carousel__arrow-icon sb-feature-carousel__arrow-icon--right" aria-hidden="true">
        {{ 'icon-carousel-arrow-left-filled.svg' | inline_asset_content }}
      </span>
    </button>
  </div>
</section>

{% stylesheet %}
  .sb-feature-carousel {
    --sb-carousel-gap: var(--sb-space-36);
    --sb-carousel-bleed-inline: var(--page-margin);
    width: 100%;
  }

  .sb-feature-carousel__title {
    color: var(--sb-color-neutral-900);
    margin: 0 0 var(--sb-space-48);
    text-align: center;
  }

  .sb-feature-carousel__viewport {
    margin-left: calc(-1 * var(--sb-carousel-bleed-inline));
    margin-right: calc(-1 * var(--sb-carousel-bleed-inline));
    overflow-x: auto;
    overflow-y: hidden;
    padding-left: var(--sb-carousel-bleed-inline);
    padding-right: var(--sb-carousel-bleed-inline);
    scrollbar-width: none;
    width: calc(100% + (var(--sb-carousel-bleed-inline) * 2));
    -webkit-overflow-scrolling: touch;
  }

  .sb-feature-carousel__viewport::-webkit-scrollbar {
    display: none;
  }

  .sb-feature-carousel__track {
    display: flex;
    gap: var(--sb-carousel-gap);
    padding: 0;
    width: max-content;
  }

  .sb-feature-carousel__item {
    flex: 0 0 283px;
    max-width: 283px;
    min-width: 283px;
  }

  .sb-feature-carousel__media {
    border-radius: var(--sb-radius-card);
    overflow: hidden;
  }

  .sb-feature-carousel__media img {
    aspect-ratio: 1 / 1;
    display: block;
    height: auto;
    object-fit: cover;
    width: 100%;
  }

  .sb-feature-carousel__media-video {
    aspect-ratio: 1 / 1;
    display: block;
    height: auto;
    object-fit: cover;
    width: 100%;
  }

  .sb-feature-carousel__body {
    color: var(--sb-color-neutral-900);
    margin-top: var(--sb-space-24);
  }

  .sb-feature-carousel__body > * {
    margin: 0;
  }

  .sb-feature-carousel__body > * + * {
    margin-top: var(--sb-space-20);
  }

  .sb-feature-carousel__controls {
    align-items: center;
    display: none;
    gap: var(--sb-space-16);
    justify-content: flex-end;
    margin-bottom: 0;
    margin-top: var(--sb-space-48);
    padding-bottom: 0;
  }

  .sb-feature-carousel.is-overflowing .sb-feature-carousel__controls {
    display: flex;
  }

  .sb-feature-carousel__arrow {
    align-items: center;
    background: transparent;
    border: 0;
    cursor: pointer;
    display: inline-flex;
    height: var(--sb-space-48);
    justify-content: center;
    padding: 0;
    width: var(--sb-space-48);
  }

  .sb-feature-carousel__arrow[disabled] {
    cursor: default;
    opacity: 0.5;
  }

  .sb-feature-carousel__arrow-icon {
    display: inline-flex;
    height: var(--sb-space-48);
    width: var(--sb-space-48);
  }

  .sb-feature-carousel__arrow-icon--right {
    transform: scaleX(-1);
  }

  .sb-feature-carousel__arrow-icon svg {
    display: block;
    height: 100%;
    width: 100%;
  }

  .sb-feature-carousel__arrow-icon svg path:first-child {
    fill: var(--sb-color-neutral-200);
  }

  .sb-feature-carousel__arrow-icon svg path:last-child {
    fill: var(--sb-color-neutral-800);
    transition: fill 180ms ease;
  }

  .sb-feature-carousel__arrow:hover:not([disabled]) .sb-feature-carousel__arrow-icon svg path:last-child,
  .sb-feature-carousel__arrow:focus-visible:not([disabled]) .sb-feature-carousel__arrow-icon svg path:last-child {
    fill: var(--sb-color-primary-500);
  }

  .sb-feature-carousel.is-not-overflowing .sb-feature-carousel__track {
    margin-inline: auto;
  }

  @media (max-width: 749px) {
    .sb-feature-carousel__viewport {
      overflow-x: auto;
    }

    .sb-feature-carousel__controls {
      justify-content: flex-end;
    }
  }
{% endstylesheet %}

<script>
  (() => {
    const roots = document.querySelectorAll('[data-sb-carousel]');
    if (!roots.length) return;

    roots.forEach((root) => {
      if (root.dataset.sbCarouselInit === 'true') return;
      root.dataset.sbCarouselInit = 'true';

      const viewport = root.querySelector('[data-sb-carousel-viewport]');
      const track = root.querySelector('[data-sb-carousel-track]');
      const prev = root.querySelector('[data-sb-carousel-prev]');
      const next = root.querySelector('[data-sb-carousel-next]');

      if (!viewport || !track || !prev || !next) return;

      const px = (value) => {
        const n = Number.parseFloat(value || '0');
        return Number.isFinite(n) ? n : 0;
      };

      const pageMargin = () => {
        const styles = getComputedStyle(document.documentElement);
        const desktop = window.matchMedia('(min-width: 750px)').matches;
        const token = desktop ? '--page-margin-desktop' : '--page-margin-mobile';
        return px(styles.getPropertyValue(token)) || px(styles.getPropertyValue('--page-margin')) || 16;
      };
      const pageWidth = () => px(getComputedStyle(document.documentElement).getPropertyValue('--page-width')) || 1240;
      const gap = () => px(getComputedStyle(root).getPropertyValue('--sb-carousel-gap'));
      const contentWidth = () => Math.max(1, Math.min(pageWidth(), window.innerWidth - (pageMargin() * 2)));
      const nativeExtraScroll = () => Math.max(0, viewport.clientWidth - contentWidth());
      const applyNativeExtraScroll = () => {
        track.style.paddingRight = `${nativeExtraScroll()}px`;
      };

      const items = () => track.querySelectorAll('[data-sb-carousel-item]');
      const itemsWidth = () => {
        const list = items();
        if (!list.length) return 0;
        const itemWidth = list[0].getBoundingClientRect().width;
        return (itemWidth * list.length) + (gap() * Math.max(0, list.length - 1));
      };

      const desiredMaxScroll = () => Math.max(0, itemsWidth() - contentWidth());
      const currentMaxScroll = () => {
        const desired = desiredMaxScroll();
        const native = Math.max(0, viewport.scrollWidth - viewport.clientWidth);
        return Math.max(0, Math.min(desired, native));
      };

      const getSnapPoints = (max) => {
        const list = items();
        if (!list.length) return [0, max];

        const firstLeft = list[0].offsetLeft;
        const points = Array.from(list).map((item) => item.offsetLeft - firstLeft);
        points.push(max);

        const normalized = points
          .map((point) => Math.max(0, Math.min(max, point)))
          .map((point) => Number(point.toFixed(2)));

        return Array.from(new Set(normalized)).sort((a, b) => a - b);
      };

      const getNextSnap = (current, max) => {
        const points = getSnapPoints(max);
        for (const point of points) {
          if (point > current + 1) return point;
        }
        return max;
      };

      const getPrevSnap = (current, max) => {
        const points = getSnapPoints(max);
        for (let i = points.length - 1; i >= 0; i -= 1) {
          if (points[i] < current - 1) return points[i];
        }
        return 0;
      };

      const setBleed = () => {
        const bleed = Math.max(pageMargin(), (window.innerWidth - contentWidth()) / 2);
        root.style.setProperty('--sb-carousel-bleed-inline', `${Math.max(0, bleed)}px`);
      };

      const syncState = () => {
        setBleed();
        applyNativeExtraScroll();
        track.style.transform = '';

        const max = currentMaxScroll();
        const overflowing = max > 1;
        root.classList.toggle('is-overflowing', overflowing);
        root.classList.toggle('is-not-overflowing', !overflowing);

        if (!overflowing) {
          if (Math.abs(viewport.scrollLeft) > 1) viewport.scrollLeft = 0;
          prev.disabled = true;
          next.disabled = true;
          return;
        }

        if (viewport.scrollLeft > max) viewport.scrollLeft = max;
        if (viewport.scrollLeft < 0) viewport.scrollLeft = 0;

        prev.disabled = viewport.scrollLeft <= 1;
        next.disabled = viewport.scrollLeft >= max - 1;
      };

      const scrollToOffset = (value) => {
        applyNativeExtraScroll();
        const max = currentMaxScroll();
        const clamped = Math.max(0, Math.min(value, max));
        viewport.scrollTo({ left: clamped, behavior: 'smooth' });
      };

      prev.addEventListener('click', () => {
        const max = currentMaxScroll();
        scrollToOffset(getPrevSnap(viewport.scrollLeft, max));
      });

      next.addEventListener('click', () => {
        const max = currentMaxScroll();
        scrollToOffset(getNextSnap(viewport.scrollLeft, max));
      });

      viewport.addEventListener('scroll', () => {
        window.requestAnimationFrame(syncState);
      }, { passive: true });

      viewport.addEventListener('wheel', (event) => {
        if (!root.classList.contains('is-overflowing')) return;

        const horizontalDelta = event.deltaX;
        if (Math.abs(horizontalDelta) < 1) return;

        event.preventDefault();
        const max = currentMaxScroll();
        const nextOffset = Math.max(0, Math.min(viewport.scrollLeft + horizontalDelta, max));
        viewport.scrollLeft = nextOffset;
      }, { passive: false });

      if ('ResizeObserver' in window) {
        const observer = new ResizeObserver(() => syncState());
        observer.observe(viewport);
        observer.observe(track);
      }

      track.querySelectorAll('img').forEach((img) => {
        if (!img.complete) {
          img.addEventListener('load', syncState, { once: true });
          img.addEventListener('error', syncState, { once: true });
        }
      });

      window.addEventListener('load', syncState);
      window.addEventListener('resize', syncState);
      syncState();
      window.requestAnimationFrame(syncState);
      window.setTimeout(syncState, 120);
      window.setTimeout(syncState, 360);
    });
  })();
</script>

{% schema %}
{
  "name": "Feature carousel",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Feature carousel"
    }
  ],
  "blocks": [
    {
      "type": "item",
      "name": "Carousel item",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image",
          "info": "Target minimum 288x288 at 3x export (864x864)."
        },
        {
          "type": "video",
          "id": "video",
          "label": "Video",
          "info": "Target minimum 288x288 at 3x export (864x864). If both are set, video is shown."
        },
        {
          "type": "richtext",
          "id": "body",
          "label": "Text",
          "default": "<p><strong>Placeholder.</strong> Placeholder 2.</p>"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Feature carousel",
      "blocks": [
        {
          "type": "item"
        },
        {
          "type": "item"
        },
        {
          "type": "item"
        },
        {
          "type": "item"
        }
      ]
    }
  ]
}
{% endschema %}
