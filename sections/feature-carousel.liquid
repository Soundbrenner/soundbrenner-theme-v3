<section class="sb-feature-carousel" data-sb-carousel data-sb-reveal>
  {% if section.settings.title != blank %}
    <h2 class="sb-feature-carousel__title font-title weight-bold" data-sb-reveal-item>{{ section.settings.title }}</h2>
  {% endif %}

  <div class="sb-feature-carousel__viewport" data-sb-carousel-viewport>
    <div class="sb-feature-carousel__track" data-sb-carousel-track>
      {% for block in section.blocks %}
        {% assign item_image = block.settings.image %}
        {% if item_image != blank %}
          {% assign item_image_url = item_image | image_url: width: 566 %}
        {% else %}
          {% assign item_image_url = 'feature-carousel-placeholder.jpg' | asset_url %}
        {% endif %}

        <article class="sb-feature-carousel__item" data-sb-carousel-item data-sb-reveal-item {{ block.shopify_attributes }}>
          <div class="sb-feature-carousel__media">
            <img
              src="{{ item_image_url }}"
              alt="{{ item_image.alt | default: block.settings.body | strip_html | truncate: 80 | escape }}"
              loading="lazy"
              width="283"
              height="283"
            >
          </div>
          <div class="sb-feature-carousel__body font-body weight-regular rte">
            {{ block.settings.body }}
          </div>
        </article>
      {% endfor %}
    </div>
  </div>

  <div class="sb-feature-carousel__controls" data-sb-carousel-controls>
    <button type="button" class="sb-feature-carousel__arrow" data-sb-carousel-prev aria-label="Previous" disabled>
      <span class="sb-feature-carousel__arrow-icon sb-feature-carousel__arrow-icon--left" aria-hidden="true">
        {{ 'icon-carousel-arrow-left-filled.svg' | inline_asset_content }}
      </span>
    </button>

    <button type="button" class="sb-feature-carousel__arrow" data-sb-carousel-next aria-label="Next" disabled>
      <span class="sb-feature-carousel__arrow-icon sb-feature-carousel__arrow-icon--right" aria-hidden="true">
        {{ 'icon-carousel-arrow-left-filled.svg' | inline_asset_content }}
      </span>
    </button>
  </div>
</section>

{% stylesheet %}
  .sb-feature-carousel {
    --sb-carousel-gap: var(--sb-space-36);
    --sb-carousel-bleed-inline: var(--page-margin);
    width: 100%;
  }

  .sb-feature-carousel__title {
    color: var(--sb-color-neutral-900);
    margin: 0 0 var(--sb-space-48);
    text-align: center;
  }

  .sb-feature-carousel__viewport {
    margin-left: calc(-1 * var(--sb-carousel-bleed-inline));
    margin-right: calc(-1 * var(--sb-carousel-bleed-inline));
    overflow-x: hidden;
    overflow-y: hidden;
    padding-left: var(--sb-carousel-bleed-inline);
    padding-right: var(--sb-carousel-bleed-inline);
    scrollbar-width: none;
    width: calc(100% + (var(--sb-carousel-bleed-inline) * 2));
    -webkit-overflow-scrolling: touch;
  }

  .sb-feature-carousel__viewport::-webkit-scrollbar {
    display: none;
  }

  .sb-feature-carousel__track {
    display: flex;
    gap: var(--sb-carousel-gap);
    padding: 0;
    width: max-content;
  }

  .sb-feature-carousel__item {
    flex: 0 0 283px;
    max-width: 283px;
    min-width: 283px;
  }

  .sb-feature-carousel__media {
    border-radius: var(--sb-radius-card);
    overflow: hidden;
  }

  .sb-feature-carousel__media img {
    aspect-ratio: 1 / 1;
    display: block;
    height: auto;
    object-fit: cover;
    width: 100%;
  }

  .sb-feature-carousel__body {
    color: var(--sb-color-neutral-900);
    margin-top: var(--sb-space-24);
  }

  .sb-feature-carousel__body > * {
    margin: 0;
  }

  .sb-feature-carousel__body > * + * {
    margin-top: var(--sb-space-20);
  }

  .sb-feature-carousel__controls {
    align-items: center;
    display: none;
    gap: var(--sb-space-16);
    justify-content: flex-end;
    margin-bottom: 0;
    margin-top: var(--sb-space-48);
    padding-bottom: 0;
  }

  .sb-feature-carousel.is-overflowing .sb-feature-carousel__controls {
    display: flex;
  }

  .sb-feature-carousel__arrow {
    align-items: center;
    background: transparent;
    border: 0;
    cursor: pointer;
    display: inline-flex;
    height: var(--sb-space-48);
    justify-content: center;
    padding: 0;
    width: var(--sb-space-48);
  }

  .sb-feature-carousel__arrow[disabled] {
    cursor: default;
    opacity: 0.5;
  }

  .sb-feature-carousel__arrow-icon {
    display: inline-flex;
    height: var(--sb-space-48);
    width: var(--sb-space-48);
  }

  .sb-feature-carousel__arrow-icon--right {
    transform: scaleX(-1);
  }

  .sb-feature-carousel__arrow-icon svg {
    display: block;
    height: 100%;
    width: 100%;
  }

  .sb-feature-carousel__arrow-icon svg path:first-child {
    fill: var(--sb-color-neutral-200);
  }

  .sb-feature-carousel__arrow-icon svg path:last-child {
    fill: var(--sb-color-neutral-800);
    transition: fill 180ms ease;
  }

  .sb-feature-carousel__arrow:hover:not([disabled]) .sb-feature-carousel__arrow-icon svg path:last-child,
  .sb-feature-carousel__arrow:focus-visible:not([disabled]) .sb-feature-carousel__arrow-icon svg path:last-child {
    fill: var(--sb-color-primary-500);
  }

  .sb-feature-carousel.is-not-overflowing .sb-feature-carousel__track {
    margin-inline: auto;
  }

  @media (max-width: 749px) {
    .sb-feature-carousel__viewport {
      overflow-x: auto;
    }

    .sb-feature-carousel__track {
      padding-right: var(--page-margin);
    }

    .sb-feature-carousel__controls {
      justify-content: flex-end;
    }
  }
{% endstylesheet %}

<script>
  (() => {
    const roots = document.querySelectorAll('[data-sb-carousel]');
    if (!roots.length) return;

    roots.forEach((root) => {
      if (root.dataset.sbCarouselInit === 'true') return;
      root.dataset.sbCarouselInit = 'true';

      const viewport = root.querySelector('[data-sb-carousel-viewport]');
      const track = root.querySelector('[data-sb-carousel-track]');
      const prev = root.querySelector('[data-sb-carousel-prev]');
      const next = root.querySelector('[data-sb-carousel-next]');

      if (!viewport || !track || !prev || !next) return;

      const px = (value) => {
        const n = Number.parseFloat(value || '0');
        return Number.isFinite(n) ? n : 0;
      };

      const pageMargin = () => px(getComputedStyle(document.documentElement).getPropertyValue('--page-margin'));
      const gap = () => px(getComputedStyle(root).getPropertyValue('--sb-carousel-gap'));
      const isMobile = () => window.matchMedia('(max-width: 749px)').matches;
      const contentWidth = () => Math.max(1, root.getBoundingClientRect().width);
      const itemsWidth = () => {
        const items = track.querySelectorAll('[data-sb-carousel-item]');
        if (!items.length) return 0;
        const itemWidth = items[0].getBoundingClientRect().width;
        return (itemWidth * items.length) + (gap() * (items.length - 1));
      };

      const getSnapPoints = (max) => {
        const items = track.querySelectorAll('[data-sb-carousel-item]');
        if (!items.length) return [0, max];

        const firstLeft = items[0].offsetLeft;
        const points = Array.from(items).map((item) => item.offsetLeft - firstLeft);
        points.push(max);

        const normalized = points
          .map((point) => Math.max(0, Math.min(max, point)))
          .map((point) => Number(point.toFixed(2)));

        return Array.from(new Set(normalized)).sort((a, b) => a - b);
      };

      const getNextSnap = (current, max) => {
        const points = getSnapPoints(max);
        for (const point of points) {
          if (point > current + 1) return point;
        }
        return max;
      };

      const getPrevSnap = (current, max) => {
        const points = getSnapPoints(max);
        for (let i = points.length - 1; i >= 0; i -= 1) {
          if (points[i] < current - 1) return points[i];
        }
        return 0;
      };

      const setBleed = () => {
        const computed = isMobile()
          ? pageMargin()
          : Math.max(pageMargin(), (window.innerWidth - contentWidth()) / 2);
        const bleed = Number.isFinite(computed) ? Math.max(0, computed) : pageMargin();
        root.style.setProperty('--sb-carousel-bleed-inline', `${bleed}px`);
      };

      const desiredMaxScroll = () => Math.max(0, itemsWidth() - contentWidth());
      const nativeMaxScroll = () => Math.max(0, viewport.scrollWidth - viewport.clientWidth);
      let currentOffset = 0;
      let targetOffset = 0;
      let rafId = 0;

      const syncArrows = (max) => {
        prev.disabled = targetOffset <= 1;
        next.disabled = targetOffset >= max - 1;
      };

      const paintOffset = () => {
        track.style.transform = `translate3d(${-currentOffset}px, 0, 0)`;
      };

      const stopAnimation = () => {
        if (!rafId) return;
        window.cancelAnimationFrame(rafId);
        rafId = 0;
      };

      const animateOffset = () => {
        const diff = targetOffset - currentOffset;
        if (Math.abs(diff) < 0.2) {
          currentOffset = targetOffset;
          paintOffset();
          rafId = 0;
          return;
        }

        currentOffset += diff * 0.22;
        paintOffset();
        rafId = window.requestAnimationFrame(animateOffset);
      };

      const scheduleAnimation = () => {
        if (rafId) return;
        rafId = window.requestAnimationFrame(animateOffset);
      };

      const setTargetOffset = (value, { smooth = true } = {}) => {
        if (isMobile()) {
          const max = nativeMaxScroll();
          const clamped = Math.max(0, Math.min(value, max));
          viewport.scrollTo({ left: clamped, behavior: smooth ? 'smooth' : 'auto' });
          return;
        }

        const max = desiredMaxScroll();
        const clamped = Math.max(0, Math.min(value, max));
        targetOffset = clamped;

        if (!smooth) {
          stopAnimation();
          currentOffset = clamped;
          paintOffset();
        } else {
          scheduleAnimation();
        }

        syncArrows(max);
      };

      const update = () => {
        setBleed();
        const max = isMobile() ? nativeMaxScroll() : desiredMaxScroll();
        const overflow = max > 1;
        root.classList.toggle('is-overflowing', overflow);
        root.classList.toggle('is-not-overflowing', !overflow);

        if (!overflow) {
          stopAnimation();
          currentOffset = 0;
          targetOffset = 0;
          paintOffset();
          prev.disabled = true;
          next.disabled = true;
          return;
        }

        if (isMobile()) {
          stopAnimation();
          currentOffset = 0;
          targetOffset = 0;
          paintOffset();
          const left = viewport.scrollLeft;
          prev.disabled = left <= 1;
          next.disabled = left >= max - 1;
          return;
        }

        if (targetOffset > max) targetOffset = max;
        if (currentOffset > max) currentOffset = max;
        paintOffset();
        syncArrows(max);
      };

      prev.addEventListener('click', () => {
        const max = isMobile() ? nativeMaxScroll() : desiredMaxScroll();
        const base = isMobile() ? viewport.scrollLeft : targetOffset;
        setTargetOffset(getPrevSnap(base, max), { smooth: true });
      });

      next.addEventListener('click', () => {
        const max = isMobile() ? nativeMaxScroll() : desiredMaxScroll();
        const base = isMobile() ? viewport.scrollLeft : targetOffset;
        setTargetOffset(getNextSnap(base, max), { smooth: true });
      });

      viewport.addEventListener('scroll', update, { passive: true });
      viewport.addEventListener('wheel', (event) => {
        if (!root.classList.contains('is-overflowing')) return;
        if (isMobile()) return;

        const delta = Math.abs(event.deltaX) > Math.abs(event.deltaY) ? event.deltaX : event.deltaY;
        if (Math.abs(delta) < 2) return;

        event.preventDefault();
        setTargetOffset(targetOffset + delta, { smooth: true });
      }, { passive: false });

      if ('ResizeObserver' in window) {
        const observer = new ResizeObserver(() => update());
        observer.observe(viewport);
        observer.observe(track);
      }

      track.querySelectorAll('img').forEach((img) => {
        if (!img.complete) {
          img.addEventListener('load', update, { once: true });
          img.addEventListener('error', update, { once: true });
        }
      });

      window.addEventListener('load', update);
      window.addEventListener('resize', update);
      update();
      window.requestAnimationFrame(update);
      window.setTimeout(update, 120);
      window.setTimeout(update, 360);
    });
  })();
</script>

{% schema %}
{
  "name": "Feature carousel",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Feature carousel"
    }
  ],
  "blocks": [
    {
      "type": "item",
      "name": "Carousel item",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image",
          "info": "Target 288x288 at 3x export (864x864)."
        },
        {
          "type": "richtext",
          "id": "body",
          "label": "Text",
          "default": "<p><strong>Placeholder.</strong> Placeholder 2.</p>"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Feature carousel",
      "blocks": [
        {
          "type": "item"
        },
        {
          "type": "item"
        },
        {
          "type": "item"
        },
        {
          "type": "item"
        }
      ]
    }
  ]
}
{% endschema %}
