<header class="header full-width">
  <div class="header__inner">
    <h2 class="header__title">
      {{ shop.name | link_to: routes.root_url }}
    </h2>

    <div class="header__menu">
      {% for link in section.settings.menu.links %}
        {{ link.title | link_to: link.url }}
      {% endfor %}

      {% if localization.available_languages.size > 1 %}
        <localization-form class="header__localization">
          {% form 'localization', class: 'header__language-form', id: 'HeaderLanguageForm' %}
            <div class="header__language-disclosure">
              <input type="hidden" name="return_to" value="{{ request.path }}">
              <button
                type="button"
                class="header__language-button"
                aria-expanded="false"
                aria-controls="HeaderLanguageList"
              >
                {{ localization.language.endonym_name | capitalize }}
                <span aria-hidden="true">â–¾</span>
              </button>

              <ul id="HeaderLanguageList" role="list" class="header__language-list" hidden>
                {% for language in localization.available_languages %}
                  <li class="header__language-item" tabindex="-1">
                    <a
                      href="#"
                      {% if language.iso_code == localization.language.iso_code %}
                        aria-current="true"
                      {% endif %}
                      hreflang="{{ language.iso_code }}"
                      lang="{{ language.iso_code }}"
                      data-value="{{ language.iso_code }}"
                    >
                      {{ language.endonym_name | capitalize }}
                    </a>
                  </li>
                {% endfor %}
              </ul>

              <input type="hidden" name="language_code" value="{{ localization.language.iso_code }}">
            </div>

            <noscript>
              <select name="language_code" class="header__language-select" aria-label="Language">
                {% for language in localization.available_languages %}
                  <option
                    value="{{ language.iso_code }}"
                    {% if language.iso_code == localization.language.iso_code %}
                      selected
                    {% endif %}
                  >
                    {{ language.endonym_name | capitalize }}
                  </option>
                {% endfor %}
              </select>
              <button type="submit" class="header__language-submit">Update</button>
            </noscript>
          {% endform %}
        </localization-form>
      {% endif %}
    </div>

    <div class="header__icons">
      <button type="button" class="header__theme-toggle" data-theme-toggle>
        Theme
      </button>

      {% if shop.customer_accounts_enabled %}
        {{ 'icon-account.svg' | inline_asset_content | link_to: routes.account_url }}
      {% endif %}

      <a href="{{ routes.cart_url }}">
        {% if cart.item_count > 0 %}
          <sup>{{ cart.item_count }}</sup>
        {% endif %}

        {{ 'icon-cart.svg' | inline_asset_content }}
      </a>
    </div>
  </div>
</header>

{% stylesheet %}
  .header {
    --sb-header-height: 5rem;
    background-color: var(--sb-color-neutral-200);
    left: 0;
    position: fixed;
    right: 0;
    top: 0;
    transform: translateY(0);
    transition: none;
    z-index: 50;
  }

  .header.is-hidden {
    transform: translateY(-100%);
  }

  .header__inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: var(--sb-header-height);
    margin-inline: auto;
    max-width: var(--page-width, 1240px);
    width: min(
      var(--page-width, 1240px),
      calc(100% - (var(--page-margin, 16px) * 2))
    );
  }

  .header a {
    position: relative;
    text-decoration: none;
    color: var(--color-foreground);
  }

  .header a sup {
    position: absolute;
    left: 100%;
    overflow: hidden;
    max-width: var(--page-margin);
  }

  .header svg {
    width: 2rem;
  }

  .header .header__menu,
  .header .header__icons {
    display: flex;
    gap: 1rem;
  }

  .header .header__language-form,
  .header .header__localization {
    margin: 0;
    position: relative;
  }

  .header .header__language-select,
  .header .header__language-button {
    background: transparent;
    border: 1px solid var(--sb-color-neutral-600);
    border-radius: var(--sb-radius-pill);
    color: var(--sb-color-neutral-900);
    cursor: pointer;
    font: inherit;
    min-height: var(--sb-space-36);
    padding-block: 0;
    padding-inline: var(--sb-space-12) var(--sb-space-28);
  }

  .header .header__language-list {
    background: var(--sb-color-neutral-100);
    border: 1px solid var(--sb-color-neutral-600);
    border-radius: var(--sb-radius-16);
    list-style: none;
    margin: var(--sb-space-8) 0 0;
    min-width: 100%;
    padding: var(--sb-space-8);
    position: absolute;
    right: 0;
    top: 100%;
    z-index: 60;
  }

  .header .header__language-item a {
    border-radius: var(--sb-radius-pill);
    display: block;
    padding: var(--sb-space-8) var(--sb-space-12);
    text-decoration: none;
    white-space: nowrap;
  }

  .header .header__language-item a:hover {
    background: var(--sb-color-neutral-200);
  }

  .header .header__language-submit {
    margin-left: var(--sb-space-8);
  }

  .header .header__theme-toggle {
    background: transparent;
    border: 1px solid var(--sb-color-neutral-600);
    border-radius: var(--sb-radius-pill);
    color: var(--sb-color-neutral-900);
    cursor: pointer;
    font: inherit;
    padding: 0.375rem 0.75rem;
  }

  .shopify-section:has(> .header) {
    min-height: 5rem;
  }
{% endstylesheet %}

<script>
  (() => {
    const header = document.querySelector('.header');
    if (!header || header.dataset.headerInit === 'true') return;
    header.dataset.headerInit = 'true';

    const getWindowY = () => window.scrollY || window.pageYOffset || document.documentElement.scrollTop || 0;
    let lastY = getWindowY();
    const topThreshold = 8;
    const revealAfterUpDistance = 18;
    let upwardTravel = 0;
    let hiddenOffset = 0;
    let topExitMode = lastY <= topThreshold;

    const clamp = (value, min, max) => Math.min(max, Math.max(min, value));
    const headerHeight = () => header.getBoundingClientRect().height || 0;
    const applyOffset = () => {
      header.style.transform = `translateY(${-hiddenOffset}px)`;
    };

    const sync = (currentY, { force = false } = {}) => {
      const delta = currentY - lastY;
      const maxOffset = headerHeight();

      if (force || currentY <= topThreshold) {
        hiddenOffset = 0;
        upwardTravel = 0;
        topExitMode = true;
        applyOffset();
        lastY = currentY;
        return;
      }

      if (delta > 0) {
        upwardTravel = 0;
        if (topExitMode) {
          // Only when leaving the top, follow page scroll.
          hiddenOffset = clamp(currentY, 0, maxOffset);
          if (hiddenOffset >= maxOffset - 0.5 || currentY > maxOffset) topExitMode = false;
        } else {
          // Everywhere else, hide instantly on downward scroll.
          hiddenOffset = maxOffset;
        }
        applyOffset();
      } else if (delta < 0) {
        upwardTravel += Math.abs(delta);
        if (upwardTravel >= revealAfterUpDistance) {
          hiddenOffset = 0;
          upwardTravel = 0;
          applyOffset();
        }
      }

      lastY = currentY;
    };

    const onWindowScroll = () => {
      sync(getWindowY());
    };

    window.addEventListener('scroll', onWindowScroll, { passive: true });
    window.addEventListener('resize', () => sync(getWindowY(), { force: true }), { passive: true });
    window.requestAnimationFrame(() => sync(getWindowY(), { force: true }));

    const root = document.documentElement;
    const toggle = header.querySelector('[data-theme-toggle]');

    const STORAGE_KEY = 'sb-theme-mode';

    const applyTheme = (theme) => {
      if (!toggle) return;
      if (theme !== 'dark' && theme !== 'light') return;
      root.setAttribute('data-theme', theme);
      toggle.setAttribute('data-theme-current', theme);
      toggle.textContent = `Theme: ${theme}`;
    };

    if (toggle) {
      const storedTheme = localStorage.getItem(STORAGE_KEY);
      if (storedTheme === 'dark' || storedTheme === 'light') applyTheme(storedTheme);
      else applyTheme(root.getAttribute('data-theme') === 'light' ? 'light' : 'dark');

      toggle.addEventListener('click', () => {
        const current = root.getAttribute('data-theme') || 'dark';
        const next = current === 'dark' ? 'light' : 'dark';
        applyTheme(next);
        localStorage.setItem(STORAGE_KEY, next);
      });
    }

    if (!customElements.get('localization-form')) {
      class LocalizationForm extends HTMLElement {
        constructor() {
          super();
          this.elements = {
            input: this.querySelector('input[name="language_code"], input[name="country_code"]'),
            button: this.querySelector('button'),
            panel: this.querySelector('ul')
          };

          if (!this.elements.button || !this.elements.panel || !this.elements.input) return;

          this.elements.button.addEventListener('click', this.openSelector.bind(this));
          this.elements.button.addEventListener('focusout', this.closeSelector.bind(this));
          this.addEventListener('keyup', this.onContainerKeyUp.bind(this));
          this.querySelectorAll('a').forEach((item) => item.addEventListener('click', this.onItemClick.bind(this)));
        }

        hidePanel() {
          this.elements.button.setAttribute('aria-expanded', 'false');
          this.elements.panel.setAttribute('hidden', true);
        }

        onContainerKeyUp(event) {
          if (event.code.toUpperCase() !== 'ESCAPE') return;
          this.hidePanel();
          this.elements.button.focus();
        }

        onItemClick(event) {
          event.preventDefault();
          const form = this.querySelector('form');
          this.elements.input.value = event.currentTarget.dataset.value;
          if (form) form.submit();
        }

        openSelector() {
          this.elements.button.focus();
          this.elements.panel.toggleAttribute('hidden');
          this.elements.button.setAttribute(
            'aria-expanded',
            (this.elements.button.getAttribute('aria-expanded') === 'false').toString()
          );
        }

        closeSelector(event) {
          const shouldClose = event.relatedTarget && event.relatedTarget.nodeName === 'BUTTON';
          if (event.relatedTarget === null || shouldClose) {
            this.hidePanel();
          }
        }
      }

      customElements.define('localization-form', LocalizationForm);
    }
  })();
</script>

{% schema %}
{
  "name": "t:general.header",
  "settings": [
    {
      "type": "link_list",
      "id": "menu",
      "label": "t:labels.menu"
    }
  ]
}
{% endschema %}
