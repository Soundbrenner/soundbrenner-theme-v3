<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Organization",
    "name": {{ shop.name | json }},
    {% if settings.logo %}
      "logo": {{ settings.logo | image_url: width: 500 | prepend: "https:" | json }},
    {% endif %}
    "url": {{ request.origin | append: page.url | json }}
  }
</script>

{% liquid
  assign seasonal_sale_name = settings.seasonal_sale_name | strip
  assign announcement_text = settings.seasonal_announcement_copy | strip
  assign announcement_text = announcement_text | replace: '{{ Seasonal sale name }}', seasonal_sale_name
  assign show_announcement = false
  if announcement_text != blank
    assign show_announcement = true
  endif
  assign sale_end_date = settings.seasonal_sale_end_date | strip
  assign show_announcement_countdown = false
  if show_announcement and sale_end_date != blank
    assign show_announcement_countdown = true
  endif
  assign announcement_gradient = settings.seasonal_announcement_gradient | default: 'linear-gradient(90deg, #E9CC92 0%, #92734F 33%, #92734F 66%, #E9CC92 100%)'
  assign announcement_emoji_asset = 'emoji-sale-new-year.png'

  case announcement_gradient
    when 'linear-gradient(90deg, #E9CC92 0%, #92734F 33%, #92734F 66%, #E9CC92 100%)'
      assign announcement_emoji_asset = 'emoji-sale-new-year.png'
    when 'linear-gradient(90deg, #F3C1DE 0%, #C77CA5 33%, #C77CA5 66%, #F3C1DE 100%)'
      assign announcement_emoji_asset = 'emoji-sale-valentines-day.png'
    when 'linear-gradient(90deg, #A4CF83 0%, #768E57 33%, #768E57 66%, #A4CF83 100%)'
      assign announcement_emoji_asset = 'emoji-sale-spring.png'
    when 'linear-gradient(90deg, #B19CD9 0%, #7B5EA7 33%, #7B5EA7 66%, #B19CD9 100%)'
      assign announcement_emoji_asset = 'emoji-sale-easter.png'
    when 'linear-gradient(90deg, #9CBDCD 0%, #F08835 33%, #F08835 66%, #9CBDCD 100%)'
      assign announcement_emoji_asset = 'emoji-sale-summer.png'
    when 'linear-gradient(90deg, #E6A53C 0%, #1E4F8F 33%, #1E4F8F 66%, #E6A53C 100%)'
      assign announcement_emoji_asset = 'emoji-sale-back-to-school.png'
    when 'linear-gradient(90deg, #1F3937 0%, #57522A 33%, #E58C56 66%, #6F351F 100%)'
      assign announcement_emoji_asset = 'emoji-sale-fall.png'
    when 'linear-gradient(90deg, #2F173A 0%, #D84418 33%, #D84418 66%, #2F173A 100%)'
      assign announcement_emoji_asset = 'emoji-sale-halloween.png'
    when 'linear-gradient(90deg, #8759F1 0%, #023CFB 33%, #8759F1 66%, #023CFB 100%)'
      assign announcement_emoji_asset = 'emoji-sale-bfcm.png'
    when 'linear-gradient(90deg, #B49F76 0%, #C32B2E 33%, #C32B2E 66%, #B49F76 100%)'
      assign announcement_emoji_asset = 'emoji-sale-holiday.png'
    when 'linear-gradient(90deg, var(--sb-color-primary-500) 0%, var(--sb-color-primary-700) 33%, var(--sb-color-primary-700) 66%, var(--sb-color-primary-500) 100%)'
      assign announcement_emoji_asset = 'emoji-sale-anniversary.png'
  endcase
%}

<header
  class="header full-width{% if show_announcement %} has-announcement{% endif %}"
  {% if show_announcement %}
    style="--sb-announcement-background: {{ announcement_gradient }};"
  {% endif %}
>
  {% if show_announcement %}
    <div class="header__announcement">
      <div class="header__announcement-content">
        <div class="header__announcement-emojis" aria-hidden="true">
          <span class="header__announcement-emoji header__announcement-emoji--left">
            <img src="{{ announcement_emoji_asset | asset_url }}" alt="" loading="eager" width="20" height="20">
          </span>
          <span class="header__announcement-emoji header__announcement-emoji--right">
            <img src="{{ announcement_emoji_asset | asset_url }}" alt="" loading="eager" width="20" height="20">
          </span>
        </div>

        <div class="header__announcement-top">
          <p class="header__announcement-text font-caption weight-semibold">{{ announcement_text | escape | newline_to_br }}</p>
        </div>

        {% if show_announcement_countdown %}
          <div class="header__announcement-countdown" data-announcement-countdown data-sale-end-date="{{ sale_end_date | escape }}" hidden>
            <div class="header__announcement-countdown-group">
              <span class="header__announcement-countdown-value font-caption weight-bold" data-countdown-days>00</span>
              <span class="header__announcement-countdown-label font-caption2 weight-semibold">days</span>
            </div>
            <div class="header__announcement-countdown-group">
              <span class="header__announcement-countdown-value font-caption weight-bold" data-countdown-hours>00</span>
              <span class="header__announcement-countdown-label font-caption2 weight-semibold">hours</span>
            </div>
            <div class="header__announcement-countdown-group">
              <span class="header__announcement-countdown-value font-caption weight-bold" data-countdown-mins>00</span>
              <span class="header__announcement-countdown-label font-caption2 weight-semibold">mins</span>
            </div>
            <div class="header__announcement-countdown-group">
              <span class="header__announcement-countdown-value font-caption weight-bold" data-countdown-secs>00</span>
              <span class="header__announcement-countdown-label font-caption2 weight-semibold">secs</span>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  {% endif %}

  <div class="header__inner">
    <div class="header__icons header__icons--left">
      <button type="button" class="header__icon-link header__icon-link--menu" aria-label="Menu">
        <span class="header__icon-asset" aria-hidden="true">
          {{ 'icon-hamburger-padded.svg' | inline_asset_content }}
        </span>
      </button>
      <a class="header__icon-link header__icon-link--search" href="{{ routes.search_url }}" aria-label="Search">
        <span class="header__icon-asset" aria-hidden="true">
          {{ 'icon-search-padded.svg' | inline_asset_content }}
        </span>
      </a>
    </div>

    <a class="header__brand" href="{{ routes.root_url }}" aria-label="{{ shop.name | escape }}">
      <span class="header__brand-logo" aria-hidden="true">
        {{ 'logo-soundbrenner-wordmark.svg' | inline_asset_content }}
      </span>
    </a>

    <nav class="header__menu" aria-label="Primary">
      {% if section.settings.menu != blank and section.settings.menu.links.size > 0 %}
        {% for link in section.settings.menu.links %}
          {% liquid
            assign link_index = forloop.index
            assign link_path = link.url | split: '?' | first
            assign is_active_link = false
            if link.current or request.path == link_path
              assign is_active_link = true
            endif

            assign has_mega_cards = false
            assign dropdown_card_count = 0

            for block in section.blocks
              if block.type == 'mega_menu_item_product' or block.type == 'mega_menu_item_collection' or block.type == 'mega_menu_item_page' or block.type == 'mega_menu_item_app'
                assign card_menu_index = block.settings.menu_item_index | plus: 0
                if card_menu_index == link_index
                  assign has_mega_cards = true
                  assign dropdown_card_count = dropdown_card_count | plus: 1
                endif
              endif
            endfor

            assign has_dropdown = false
            if has_mega_cards
              assign has_dropdown = true
            endif

            assign dropdown_card_count = dropdown_card_count | at_least: 1 | at_most: 4
          %}

          <div class="header__menu-item{% if has_dropdown %} has-dropdown{% endif %}">
            <a
              class="header__menu-link font-caption weight-regular{% if is_active_link %} is-active{% endif %}"
              href="{{ link.url }}"
            >
              {{ link.title }}
            </a>

            {% if has_dropdown %}
              <div class="header__mega-menu" aria-label="{{ link.title | escape }}" style="--sb-mega-columns: {{ dropdown_card_count }};">
                <div class="header__mega-menu-panel">
                  <a class="header__mega-menu-title font-title weight-bold" href="{{ link.url }}">{{ link.title }}</a>
                  <div class="header__mega-menu-grid">
                    {% for block in section.blocks %}
                      {% liquid
                        if block.type != 'mega_menu_item_product' and block.type != 'mega_menu_item_collection' and block.type != 'mega_menu_item_page' and block.type != 'mega_menu_item_app'
                          continue
                        endif

                        assign block_menu_index = block.settings.menu_item_index | plus: 0
                        if block_menu_index != link_index
                          continue
                        endif
                        assign app_mode = false
                        assign card_product = blank
                        assign card_collection = blank
                        assign card_page = blank

                        case block.type
                          when 'mega_menu_item_product'
                            assign card_product = block.settings.product
                          when 'mega_menu_item_collection'
                            assign card_collection = block.settings.collection
                          when 'mega_menu_item_page'
                            assign card_page = block.settings.page
                          when 'mega_menu_item_app'
                            assign app_mode = true
                        endcase
                        assign card_image = block.settings.image
                        assign hide_on_mobile = block.settings.hide_on_mobile
                        assign card_title = blank
                        assign card_body = blank
                        assign card_link = blank
                        assign card_rating_label = '4.8 stars on app stores'

                        if app_mode == true
                          assign card_link = routes.root_url | append: 'pages/the-app'
                          assign card_title = 'The Metronome app'
                          assign card_body = 'Download for iOS and Android'
                        else
                          if card_product != blank
                            assign card_link = card_product.url
                            assign card_title = card_product.title
                            assign product_settings_ref = card_product.metafields.custom.sbv2_product_settings.value | default: card_product.metafields.custom.sbv2_product_settings
                            if product_settings_ref != blank
                              assign card_body = product_settings_ref.tagline.value | default: product_settings_ref.tagline
                            endif
                            if card_body == blank and card_product.description != blank
                              assign card_body = card_product.description | strip_html
                            endif
                          elsif card_collection != blank
                            assign card_link = card_collection.url
                            assign card_title = card_collection.title
                            assign card_body = card_collection.description | strip_html
                          elsif card_page != blank
                            assign card_link = card_page.url
                            assign card_title = card_page.title
                            assign card_body = card_page.content | strip_html
                          endif
                        endif

                        assign card_image_url = blank
                        if card_image != blank
                          assign card_image_url = card_image | image_url: width: 584
                        endif

                        assign card_badge_label = blank
                        assign card_badge_type = blank
                        if card_product != blank and card_product.tags != blank
                          for product_tag in card_product.tags
                            assign product_tag_downcase = product_tag | downcase
                            if product_tag_downcase == 'bestseller'
                              assign card_badge_label = 'Bestseller'
                              assign card_badge_type = 'bestseller'
                              break
                            endif
                            if product_tag_downcase == 'new'
                              assign card_badge_label = 'New'
                              assign card_badge_type = 'new'
                            endif
                          endfor
                        endif
                      %}

                      <article class="header__mega-card" data-hide-on-mobile="{{ hide_on_mobile }}" {{ block.shopify_attributes }}>
                        <a class="header__mega-card-media" href="{{ card_link | default: '#' }}">
                          {% if card_badge_label != blank %}
                            <span class="header__mega-card-badge header__mega-card-badge--{{ card_badge_type }} font-caption weight-semibold">
                              {{ card_badge_label }}
                            </span>
                          {% endif %}

                          {% if card_image_url != blank %}
                            <img
                              class="header__mega-card-image"
                              src="{{ card_image_url }}"
                              alt="{{ card_title | default: link.title | escape }}"
                              loading="eager"
                              fetchpriority="low"
                              decoding="async"
                              width="584"
                              height="584"
                            >
                          {% else %}
                            <img
                              class="header__mega-card-image"
                              src="{{ 'mega-menu-item-placeholder.jpg' | asset_url }}"
                              alt="{{ card_title | default: link.title | escape }}"
                              loading="eager"
                              fetchpriority="low"
                              decoding="async"
                              width="584"
                              height="584"
                            >
                          {% endif %}
                        </a>

                        <p class="header__mega-card-title font-callout weight-bold">
                          <a class="header__mega-card-title-link" href="{{ card_link | default: '#' }}">{{ card_title | default: link.title }}</a>
                        </p>

                        {% if app_mode == true %}
                          <div class="header__mega-card-app">
                            <p class="header__mega-card-rating font-body weight-regular">
                              <span class="header__mega-card-stars" aria-hidden="true">★★★★★</span>
                              <span>{{ card_rating_label }}</span>
                            </p>

                            <div class="header__mega-card-app-links">
                              <a href="{{ card_link }}" aria-label="Download on the App Store">
                                <img
                                  src="{{ 'app-download-app-store.png' | asset_url }}"
                                  alt="Download on the App Store"
                                  loading="lazy"
                                  width="120"
                                  height="36"
                                >
                              </a>
                              <a href="{{ card_link }}" aria-label="Get it on Google Play">
                                <img
                                  src="{{ 'app-download-google-play.png' | asset_url }}"
                                  alt="Get it on Google Play"
                                  loading="lazy"
                                  width="120"
                                  height="36"
                                >
                              </a>
                            </div>
                          </div>
                        {% else %}
                          {% if card_body != blank %}
                            <p class="header__mega-card-body font-body weight-regular">{{ card_body }}</p>
                          {% endif %}

                          {% if block.type == 'mega_menu_item_product' %}
                            {% assign accessories_collection = block.settings.accessories_collection %}
                            {% if accessories_collection == blank and card_product != blank and card_product.collections != blank %}
                              {% for candidate_collection in card_product.collections %}
                                {% assign candidate_handle = candidate_collection.handle | downcase %}
                                {% assign candidate_title = candidate_collection.title | downcase %}
                                {% if candidate_handle contains 'accessor' or candidate_title contains 'accessor' %}
                                  {% assign accessories_collection = candidate_collection %}
                                  {% break %}
                                {% endif %}
                              {% endfor %}
                              {% if accessories_collection == blank %}
                                {% assign accessories_collection = card_product.collections.first %}
                              {% endif %}
                            {% endif %}
                            {% if accessories_collection != blank %}
                              <ul class="header__mega-card-links font-body weight-semibold" role="list">
                                <li>
                                  <a href="{{ accessories_collection.url }}">Accessories</a>
                                </li>
                              </ul>
                            {% endif %}
                          {% elsif block.type == 'mega_menu_item_collection' %}
                            {% assign linked_product_1 = block.settings.related_product_1 %}
                            {% assign linked_product_2 = block.settings.related_product_2 %}
                            {% assign linked_product_3 = block.settings.related_product_3 %}
                            {% assign has_card_links = false %}
                            {% if linked_product_1 != blank or linked_product_2 != blank or linked_product_3 != blank %}
                              {% assign has_card_links = true %}
                            {% endif %}
                            {% if has_card_links %}
                              <ul class="header__mega-card-links font-body weight-semibold" role="list">
                                {% if linked_product_1 != blank %}
                                  {% assign linked_product_1_settings = linked_product_1.metafields.custom.sbv2_product_settings.value | default: linked_product_1.metafields.custom.sbv2_product_settings %}
                                  {% assign linked_product_1_tagline = blank %}
                                  {% if linked_product_1_settings != blank %}
                                    {% assign linked_product_1_tagline = linked_product_1_settings.tagline.value | default: linked_product_1_settings.tagline %}
                                  {% endif %}
                                  <li>
                                    <a
                                      href="{{ linked_product_1.url }}"
                                      data-mobile-product-title="{{ linked_product_1.title | escape }}"
                                      data-mobile-product-description="{{ linked_product_1.description | strip_html | escape }}"
                                      data-mobile-product-tagline="{{ linked_product_1_tagline | escape }}"
                                    >
                                      {{ linked_product_1.title }}
                                    </a>
                                  </li>
                                {% endif %}
                                {% if linked_product_2 != blank %}
                                  {% assign linked_product_2_settings = linked_product_2.metafields.custom.sbv2_product_settings.value | default: linked_product_2.metafields.custom.sbv2_product_settings %}
                                  {% assign linked_product_2_tagline = blank %}
                                  {% if linked_product_2_settings != blank %}
                                    {% assign linked_product_2_tagline = linked_product_2_settings.tagline.value | default: linked_product_2_settings.tagline %}
                                  {% endif %}
                                  <li>
                                    <a
                                      href="{{ linked_product_2.url }}"
                                      data-mobile-product-title="{{ linked_product_2.title | escape }}"
                                      data-mobile-product-description="{{ linked_product_2.description | strip_html | escape }}"
                                      data-mobile-product-tagline="{{ linked_product_2_tagline | escape }}"
                                    >
                                      {{ linked_product_2.title }}
                                    </a>
                                  </li>
                                {% endif %}
                                {% if linked_product_3 != blank %}
                                  {% assign linked_product_3_settings = linked_product_3.metafields.custom.sbv2_product_settings.value | default: linked_product_3.metafields.custom.sbv2_product_settings %}
                                  {% assign linked_product_3_tagline = blank %}
                                  {% if linked_product_3_settings != blank %}
                                    {% assign linked_product_3_tagline = linked_product_3_settings.tagline.value | default: linked_product_3_settings.tagline %}
                                  {% endif %}
                                  <li>
                                    <a
                                      href="{{ linked_product_3.url }}"
                                      data-mobile-product-title="{{ linked_product_3.title | escape }}"
                                      data-mobile-product-description="{{ linked_product_3.description | strip_html | escape }}"
                                      data-mobile-product-tagline="{{ linked_product_3_tagline | escape }}"
                                    >
                                      {{ linked_product_3.title }}
                                    </a>
                                  </li>
                                {% endif %}
                              </ul>
                            {% endif %}
                          {% endif %}
                        {% endif %}
                      </article>
                    {% endfor %}
                  </div>
                </div>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      {% endif %}
    </nav>

    <div class="header__icons header__icons--right">
      <a
        class="header__icon-link header__icon-link--search header__icon-link--desktop-only"
        href="{{ routes.search_url }}"
        aria-label="Search"
      >
        <span class="header__icon-asset" aria-hidden="true">
          {{ 'icon-search-padded.svg' | inline_asset_content }}
        </span>
      </a>
      <a class="header__icon-link header__icon-link--account" href="{{ routes.account_url }}" aria-label="Account">
        <span class="header__icon-asset" aria-hidden="true">
          {{ 'icon-account-padded.svg' | inline_asset_content }}
        </span>
      </a>

      <a class="header__icon-link header__icon-link--cart" href="{{ routes.cart_url }}" data-header-cart-link aria-label="Cart">
        <sup class="header__cart-count-badge font-caption2 weight-semibold" data-header-cart-count {% if cart.item_count == 0 %}hidden{% endif %}>
          {{ cart.item_count }}
        </sup>
        <span class="header__icon-asset" aria-hidden="true">
          {{ 'icon-cart-padded.svg' | inline_asset_content }}
        </span>
      </a>
    </div>
  </div>
</header>
<div class="header__mega-backdrop header__mega-backdrop--top" data-header-mega-backdrop="top" aria-hidden="true"></div>
<div
  class="header__mega-backdrop header__mega-backdrop--bottom"
  data-header-mega-backdrop="bottom"
  aria-hidden="true"
></div>

<div class="header__cart-drawer" data-cart-drawer hidden>
  <div class="header__cart-drawer-backdrop" data-cart-drawer-close></div>
  <aside class="header__cart-drawer-panel" role="dialog" aria-modal="true" aria-label="Cart drawer">
    <div class="header__cart-drawer-header">
      <h3 class="header__cart-drawer-title">Your cart</h3>
      <button type="button" class="header__cart-drawer-close" data-cart-drawer-close aria-label="Close cart">Close</button>
    </div>
    <p class="header__cart-drawer-status" data-cart-drawer-status>Loading cart...</p>
    <ul class="header__cart-drawer-items" data-cart-drawer-items></ul>
    <div class="header__cart-drawer-actions">
      <button type="button" class="header__cart-drawer-action" data-cart-drawer-refresh>Refresh</button>
      <button type="button" class="header__cart-drawer-action" data-cart-drawer-clear>Clear cart</button>
      <a class="header__cart-drawer-action" href="{{ routes.cart_url }}">View cart</a>
      <a class="header__cart-drawer-action" href="/checkout">Checkout</a>
    </div>
  </aside>
</div>

{% stylesheet %}
  .header {
    --sb-header-height: calc(var(--sb-space-48) + var(--sb-space-12));
    --sb-announcement-min-height: 0px;
    --sb-announcement-row-gap: 6px;
    background-color: var(--sb-color-neutral-200);
    border-bottom: 1px solid var(--sb-color-neutral-600);
    left: 0;
    position: fixed;
    right: 0;
    top: 0;
    transform: translateY(0);
    transition: none;
    z-index: 50;
  }

  .header.has-announcement {
    --sb-announcement-min-height: 42px;
  }

  .header__announcement {
    align-items: center;
    background: var(--sb-announcement-background, var(--sb-gradient-default-1));
    display: flex;
    justify-content: center;
    min-height: var(--sb-announcement-min-height);
    padding: var(--sb-space-8) var(--page-margin, 16px);
    width: 100%;
  }

  .header__announcement-content {
    align-items: center;
    display: flex;
    flex-direction: column;
    gap: var(--sb-announcement-row-gap);
    max-width: calc(100% - ((var(--sb-space-20) + var(--sb-space-16)) * 2));
    position: relative;
    width: fit-content;
  }

  .header__announcement-emojis {
    align-items: center;
    display: flex;
    inset: 0 calc(-1 * (var(--sb-space-20) + var(--sb-space-16)));
    justify-content: space-between;
    pointer-events: none;
    position: absolute;
  }

  .header__announcement-top {
    display: block;
    width: 100%;
  }

  .header__announcement-emoji {
    align-items: center;
    display: inline-flex;
    flex: 0 0 auto;
    height: var(--sb-space-20);
    justify-content: center;
    overflow: hidden;
    width: var(--sb-space-20);
  }

  .header__announcement-emoji img {
    display: block;
    height: 100%;
    width: 100%;
  }

  .header__announcement-text {
    color: var(--sb-color-always-white);
    margin: 0;
    max-width: 100%;
    min-width: 0;
    text-align: center;
    white-space: normal;
    word-break: break-word;
  }

  .header__announcement-countdown {
    align-items: center;
    display: flex;
    flex-wrap: wrap;
    gap: var(--sb-space-12);
    justify-content: center;
    width: 100%;
  }

  .header__announcement-countdown[hidden] {
    display: none;
  }

  .header__announcement-countdown-group {
    align-items: center;
    color: var(--sb-color-always-white);
    display: inline-flex;
    gap: var(--sb-space-6);
  }

  .header__announcement-countdown-value {
    align-items: center;
    background: var(--sb-color-always-black-25);
    box-sizing: border-box;
    border-radius: 4px;
    display: inline-flex;
    font-variant-numeric: tabular-nums;
    justify-content: center;
    line-height: 1;
    min-width: var(--sb-space-24);
    padding: var(--sb-space-2);
    text-align: center;
    width: var(--sb-space-24);
  }

  .header__announcement-countdown-label {
    color: var(--sb-color-always-white);
    line-height: 1;
  }

  .header.is-hidden {
    transform: translateY(-100%);
  }

  .header__inner {
    align-items: center;
    display: flex;
    height: var(--sb-header-height);
    justify-content: space-between;
    margin-inline: auto;
    max-width: var(--page-width, 1240px);
    position: relative;
    width: min(
      var(--page-width, 1240px),
      calc(100% - (var(--page-margin, 16px) * 2))
    );
  }

  .header a {
    text-decoration: none;
  }

  .header__brand {
    align-items: center;
    color: var(--sb-color-neutral-900);
    display: inline-flex;
    line-height: 0;
  }

  .header__brand:hover,
  .header__brand:focus-visible {
    color: var(--sb-color-primary-500);
  }

  .header__brand-logo {
    display: inline-flex;
    height: var(--sb-space-36);
    width: auto;
  }

  .header__brand-logo svg {
    display: block;
    height: 100%;
    width: auto;
  }

  .header__menu {
    align-items: center;
    display: flex;
    gap: var(--sb-space-24);
    justify-content: center;
    left: 50%;
    min-width: calc((var(--sb-space-128) * 4) + var(--sb-space-64) + var(--sb-space-24));
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    white-space: nowrap;
    width: fit-content;
  }

  .header__menu-item {
    align-items: center;
    display: inline-flex;
  }

  .header__menu-link {
    align-items: center;
    color: var(--sb-color-neutral-900);
    display: inline-flex;
    justify-content: center;
    line-height: 1;
    min-height: var(--sb-space-36);
    position: relative;
    z-index: 2;
  }

  .header__menu-link:hover,
  .header__menu-link:focus-visible {
    color: var(--sb-color-primary-500);
  }

  .header__menu-link.is-active {
    color: var(--sb-color-primary-500);
  }

  .header__mega-menu {
    --sb-mega-max-width: min(
      calc(100vw - (var(--page-margin, 16px) * 2)),
      var(--page-width, 1240px)
    );
    --sb-mega-card-width: calc(
      (
        var(--sb-mega-max-width)
        - (var(--sb-space-36) * 3)
        - (var(--sb-space-64) * 2)
      ) / 4
    );
    --sb-mega-clip-closed: calc(100% + var(--sb-space-2));
    left: 50%;
    border-radius: var(--sb-space-24);
    pointer-events: none;
    position: absolute;
    top: calc(100% + var(--sb-space-16) + ((var(--sb-header-height) - var(--sb-space-36)) / 2));
    transform: translate(-50%, 0);
    visibility: hidden;
    width: min(
      var(--sb-mega-max-width),
      calc(
        (var(--sb-mega-card-width) * var(--sb-mega-columns, 4))
        + (var(--sb-space-36) * (var(--sb-mega-columns, 4) - 1))
        + (var(--sb-space-64) * 2)
      )
    );
    isolation: isolate;
    z-index: 120;
    transition: visibility 0s linear 460ms;
  }

  .header__mega-menu::before {
    border-radius: var(--sb-space-24);
    box-shadow: 0 calc(var(--sb-space-8) + var(--sb-space-2)) 90px 0 var(--sb-color-always-black-50, rgba(0, 0, 0, 0.5));
    content: '';
    inset: 0;
    opacity: 0;
    pointer-events: none;
    position: absolute;
    transition: opacity 320ms ease;
    will-change: opacity;
    z-index: 0;
  }

  .header__menu-item.has-dropdown.is-open > .header__mega-menu,
  .header__menu-item.has-dropdown:focus-within > .header__mega-menu {
    pointer-events: auto;
    visibility: visible;
    transition-delay: 0s;
  }

  .header.is-mega-shadow-ready .header__menu-item.has-dropdown.is-open > .header__mega-menu::before,
  .header.is-mega-shadow-ready .header__menu-item.has-dropdown:focus-within > .header__mega-menu::before {
    opacity: 1;
  }

  .header__mega-menu-panel {
    clip-path: inset(0 0 var(--sb-mega-clip-closed) 0 round var(--sb-space-24));
    transform-origin: top center;
    transition: clip-path 460ms cubic-bezier(0.22, 1, 0.36, 1);
    will-change: clip-path;
  }

  .header__menu-item.has-dropdown.is-open > .header__mega-menu .header__mega-menu-panel,
  .header__menu-item.has-dropdown:focus-within > .header__mega-menu .header__mega-menu-panel {
    clip-path: inset(0 0 0 0 round var(--sb-space-24));
  }

  .header__mega-menu-panel {
    background: var(--sb-color-neutral-200);
    border-radius: var(--sb-space-24);
    overflow: hidden;
    padding: var(--sb-space-36) var(--sb-space-64) var(--sb-space-48);
    position: relative;
    white-space: normal;
    z-index: 1;
  }

  .header__mega-menu-grid {
    display: grid;
    margin-top: var(--sb-space-36);
    gap: var(--sb-space-36);
    grid-template-columns: repeat(var(--sb-mega-columns, 4), minmax(0, 1fr));
    justify-content: center;
  }

  .header__mega-menu-title {
    align-items: center;
    color: var(--sb-color-neutral-900);
    display: flex;
    justify-content: center;
    margin: 0 auto;
    opacity: 0;
    text-align: center;
    transition: opacity 220ms ease;
    width: fit-content;
  }

  .header__mega-menu-title:hover,
  .header__mega-menu-title:focus-visible {
    color: var(--sb-color-primary-500);
  }

  .header__mega-card {
    min-width: 0;
    opacity: 0;
    transition: opacity 220ms ease;
  }

  .header__menu-item.has-dropdown.is-open > .header__mega-menu .header__mega-menu-title,
  .header__menu-item.has-dropdown:focus-within > .header__mega-menu .header__mega-menu-title,
  .header__menu-item.has-dropdown.is-open > .header__mega-menu .header__mega-card,
  .header__menu-item.has-dropdown:focus-within > .header__mega-menu .header__mega-card {
    opacity: 1;
  }

  .header__mega-card-media {
    border-radius: var(--sb-space-24);
    display: block;
    overflow: hidden;
    position: relative;
    transform: scale(1);
    transform-origin: center center;
    transition: transform 220ms ease;
  }

  .header__mega-card-image {
    aspect-ratio: 1 / 1;
    display: block;
    height: auto;
    object-fit: cover;
    width: 100%;
  }

  .header__mega-card-media:hover,
  .header__mega-card-media:focus-visible {
    transform: scale(1.015);
  }

  .header__mega-card-badge {
    border-radius: var(--sb-space-12);
    color: var(--sb-color-always-white);
    left: var(--sb-space-16);
    padding: var(--sb-space-8) var(--sb-space-12);
    position: absolute;
    top: var(--sb-space-16);
    z-index: 1;
  }

  .header__mega-card-badge--bestseller {
    background: var(--sb-color-red-500);
  }

  .header__mega-card-badge--new {
    background: var(--sb-color-primary-500);
  }

  .header__mega-card-title {
    margin: var(--sb-space-20) 0 0;
  }

  .header__mega-card-title-link {
    color: var(--sb-color-neutral-900);
    overflow-wrap: normal;
  }

  .header__mega-card-title-link:hover,
  .header__mega-card-title-link:focus-visible {
    color: var(--sb-color-primary-500);
  }

  .header__mega-card-body {
    color: var(--sb-color-neutral-900);
    margin: var(--sb-space-12) 0 0;
    overflow-wrap: anywhere;
  }

  .header__mega-card-links {
    display: flex;
    flex-direction: column;
    gap: var(--sb-space-12);
    list-style: none;
    margin: var(--sb-space-20) 0 0;
    padding: 0;
  }

  .header__mega-card-links a {
    color: var(--sb-color-neutral-900);
    overflow-wrap: anywhere;
  }

  .header__mega-card-links a:hover,
  .header__mega-card-links a:focus-visible {
    color: var(--sb-color-primary-500);
  }

  .header__mega-card-app {
    margin-top: var(--sb-space-12);
  }

  .header__mega-card-rating {
    align-items: center;
    color: var(--sb-color-neutral-900);
    display: flex;
    gap: var(--sb-space-8);
    margin: 0;
  }

  .header__mega-card-stars {
    color: var(--sb-color-neutral-900);
    letter-spacing: var(--sb-space-2);
    line-height: 1;
  }

  .header__mega-card-app-links {
    display: flex;
    flex-wrap: wrap;
    gap: var(--sb-space-12);
    margin-top: var(--sb-space-20);
  }

  .header__mega-card-app-links a {
    display: inline-flex;
    line-height: 0;
  }

  .header__mega-card-app-links img {
    display: block;
    height: auto;
    width: calc(var(--sb-space-96) + var(--sb-space-24));
  }

  .header__icons {
    align-items: center;
    display: flex;
    gap: var(--sb-space-16);
    margin-left: auto;
  }

  .header__icons--left {
    display: none;
    margin-left: 0;
  }

  .header__icon-link {
    align-items: center;
    background: transparent;
    border: 0;
    color: var(--sb-color-neutral-900);
    cursor: pointer;
    display: inline-flex;
    justify-content: center;
    line-height: 0;
    padding: 0;
    position: relative;
    text-decoration: none;
  }

  .header__icon-link:hover,
  .header__icon-link:focus-visible {
    color: var(--sb-color-primary-500);
  }

  .header__icon-asset {
    align-items: center;
    display: inline-flex;
    height: var(--sb-space-24);
    justify-content: center;
    width: var(--sb-space-24);
  }

  .header__icon-asset svg,
  .header__icon-asset img {
    display: block;
    height: 100%;
    width: 100%;
  }

  .header__icon-link--menu svg [fill] {
    fill: currentColor;
  }

  .header__icon-link--search svg [fill] {
    fill: currentColor;
  }

  .header__icon-link--account svg [fill] {
    fill: currentColor;
  }

  .header__icon-link--cart svg [fill] {
    fill: currentColor;
  }

  .header [data-header-cart-link] {
    align-items: center;
    display: inline-flex;
  }

  .header [data-header-cart-link]:hover,
  .header [data-header-cart-link]:focus-visible {
    color: var(--sb-color-primary-500);
  }

  .header__cart-count-badge {
    align-items: center;
    background: var(--sb-color-primary-500);
    border: 1px solid var(--sb-color-neutral-200);
    border-radius: 999px;
    box-sizing: border-box;
    color: var(--sb-color-always-white);
    display: inline-flex;
    height: var(--sb-space-20);
    justify-content: center;
    min-width: var(--sb-space-20);
    padding: 0 var(--sb-space-4);
    position: absolute;
    right: calc(-1 * var(--sb-space-6));
    top: calc(-1 * var(--sb-space-6));
    transform: scale(1);
    transform-origin: center;
    z-index: 1;
  }

  .header__cart-count-badge[hidden] {
    display: none;
  }

  .header__cart-count-badge.is-double-digit {
    padding: 0 var(--sb-space-6);
  }

  .header__cart-count-badge.is-bump {
    animation: header-cart-badge-bump 420ms cubic-bezier(0.2, 0.9, 0.2, 1.15);
  }

  @keyframes header-cart-badge-bump {
    0% {
      transform: scale(0.72);
    }
    55% {
      transform: scale(1.18);
    }
    100% {
      transform: scale(1);
    }
  }

  @media screen and (max-width: 989px) {
    .header__inner {
      justify-content: space-between;
    }

    .header__brand {
      left: 50%;
      position: absolute;
      transform: translateX(-50%);
    }

    .header__menu {
      display: none;
    }

    .header__mega-menu {
      display: none;
    }

    .header__icons--left {
      display: flex;
    }

    .header__icons--right .header__icon-link--desktop-only {
      display: none;
    }
  }

  .header__mega-backdrop {
    opacity: 0;
    pointer-events: none;
    position: fixed;
    transition: opacity 180ms ease;
    z-index: 49;
  }

  @media screen and (min-width: 990px) {
    .header__mega-backdrop {
      -webkit-backdrop-filter: blur(var(--sb-space-8));
      backdrop-filter: blur(var(--sb-space-8));
      background: var(--sb-color-always-black-25);
      left: 0;
      right: 0;
    }

    .header__mega-backdrop--top {
      top: 0;
    }

    .header__mega-backdrop--bottom {
      bottom: 0;
    }

    .header__mega-backdrop.is-active {
      opacity: 1;
    }
  }

  .header .header__cart-drawer-action,
  .header .header__cart-drawer-close {
    align-items: center;
    background: transparent;
    border: 1px solid var(--sb-color-neutral-600);
    border-radius: 999px;
    color: var(--sb-color-neutral-900);
    cursor: pointer;
    display: inline-flex;
    font: inherit;
    min-height: var(--sb-space-36);
    padding: 0 var(--sb-space-12);
  }

  .header__cart-drawer {
    inset: 0;
    position: fixed;
    z-index: 80;
  }

  .header__cart-drawer[hidden] {
    display: none;
  }

  .header__cart-drawer-backdrop {
    background: var(--sb-color-always-black-25);
    inset: 0;
    position: absolute;
  }

  .header__cart-drawer-panel {
    background: var(--sb-color-neutral-100);
    border-left: 1px solid var(--sb-color-neutral-600);
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    gap: var(--sb-space-12);
    height: 100%;
    max-width: 420px;
    padding: var(--sb-space-16);
    position: absolute;
    right: 0;
    top: 0;
    width: min(100%, 420px);
  }

  .header__cart-drawer-header {
    align-items: center;
    display: flex;
    justify-content: space-between;
    gap: var(--sb-space-12);
  }

  .header__cart-drawer-title {
    color: var(--sb-color-neutral-900);
    margin: 0;
  }

  .header__cart-drawer-status {
    color: var(--sb-color-neutral-800);
    margin: 0;
  }

  .header__cart-drawer-items {
    display: flex;
    flex-direction: column;
    gap: var(--sb-space-8);
    list-style: none;
    margin: 0;
    min-height: 0;
    overflow: auto;
    padding: 0;
    flex: 1 1 auto;
  }

  .header__cart-drawer-item {
    border-bottom: 1px solid var(--sb-color-neutral-600);
    display: flex;
    justify-content: space-between;
    gap: var(--sb-space-12);
    padding: var(--sb-space-8) 0;
  }

  .header__cart-drawer-item-info {
    display: flex;
    flex-direction: column;
    gap: var(--sb-space-4);
    min-width: 0;
  }

  .header__cart-drawer-item-title {
    color: var(--sb-color-neutral-900);
    margin: 0;
  }

  .header__cart-drawer-item-variant,
  .header__cart-drawer-item-price {
    color: var(--sb-color-neutral-800);
    margin: 0;
  }

  .header__cart-drawer-item-qty {
    color: var(--sb-color-neutral-900);
    white-space: nowrap;
  }

  .header__cart-drawer-actions {
    display: flex;
    flex-wrap: wrap;
    gap: var(--sb-space-8);
  }

  .header__cart-drawer-action {
    text-decoration: none;
  }

  .shopify-section:has(> .header) {
    min-height: calc(var(--sb-header-height) + var(--sb-announcement-min-height, 0px));
  }

{% endstylesheet %}

<script>
  (() => {
    const header = document.querySelector('.header');
    if (!header || header.dataset.headerInit === 'true') return;
    header.dataset.headerInit = 'true';

    const countdownRoot = header.querySelector('[data-announcement-countdown]');
    if (countdownRoot) {
      const endDateValue = countdownRoot.getAttribute('data-sale-end-date') || '';
      const parseSaleEndTimestamp = (value) => {
        const normalizedValue = `${value || ''}`.trim();
        if (!normalizedValue) return NaN;

        const dateOnlyMatch = normalizedValue.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (!dateOnlyMatch) {
          const fallbackTimestamp = Date.parse(normalizedValue);
          return Number.isFinite(fallbackTimestamp) ? fallbackTimestamp : NaN;
        }

        const year = Number.parseInt(dateOnlyMatch[1], 10);
        const monthIndex = Number.parseInt(dateOnlyMatch[2], 10) - 1;
        const day = Number.parseInt(dateOnlyMatch[3], 10);
        const parsedDate = new Date(Date.UTC(year, monthIndex, day));

        if (
          parsedDate.getUTCFullYear() !== year
          || parsedDate.getUTCMonth() !== monthIndex
          || parsedDate.getUTCDate() !== day
        ) {
          return NaN;
        }

        const endOfDayUtcGuess = Date.UTC(year, monthIndex, day, 23, 59, 59);
        if (!window.Intl || typeof Intl.DateTimeFormat !== 'function') {
          return Date.parse(`${normalizedValue}T23:59:59-08:00`);
        }

        const formatter = new Intl.DateTimeFormat('en-US', {
          timeZone: 'America/Los_Angeles',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hourCycle: 'h23'
        });

        if (typeof formatter.formatToParts !== 'function') {
          return Date.parse(`${normalizedValue}T23:59:59-08:00`);
        }

        const getOffsetMs = (utcTimestamp) => {
          const parts = formatter.formatToParts(new Date(utcTimestamp));
          const timeParts = {};

          for (const part of parts) {
            if (part.type !== 'literal') timeParts[part.type] = Number.parseInt(part.value, 10);
          }

          const localTimeAsUtc = Date.UTC(
            timeParts.year,
            timeParts.month - 1,
            timeParts.day,
            timeParts.hour,
            timeParts.minute,
            timeParts.second
          );

          return localTimeAsUtc - utcTimestamp;
        };

        let resolvedTimestamp = endOfDayUtcGuess;
        for (let index = 0; index < 4; index += 1) {
          const nextTimestamp = endOfDayUtcGuess - getOffsetMs(resolvedTimestamp);
          if (Math.abs(nextTimestamp - resolvedTimestamp) < 1) break;
          resolvedTimestamp = nextTimestamp;
        }

        return resolvedTimestamp;
      };

      const endTimestamp = parseSaleEndTimestamp(endDateValue);
      const daysValue = countdownRoot.querySelector('[data-countdown-days]');
      const hoursValue = countdownRoot.querySelector('[data-countdown-hours]');
      const minsValue = countdownRoot.querySelector('[data-countdown-mins]');
      const secsValue = countdownRoot.querySelector('[data-countdown-secs]');

      if (!Number.isFinite(endTimestamp) || !daysValue || !hoursValue || !minsValue || !secsValue) {
        countdownRoot.setAttribute('hidden', '');
      } else {
        const formatCountdownValue = (value) => `${Math.min(99, Math.max(0, value))}`.padStart(2, '0');
        const countdownDisplayThresholdSeconds = 5 * 24 * 60 * 60;
        let countdownTimer = null;

        const updateCountdown = () => {
          const remainingSeconds = Math.max(0, Math.floor((endTimestamp - Date.now()) / 1000));
          const shouldShowCountdown = remainingSeconds > 0 && remainingSeconds <= countdownDisplayThresholdSeconds;
          const days = Math.floor(remainingSeconds / 86400);
          const hours = Math.floor((remainingSeconds % 86400) / 3600);
          const mins = Math.floor((remainingSeconds % 3600) / 60);
          const secs = remainingSeconds % 60;

          if (shouldShowCountdown) {
            countdownRoot.removeAttribute('hidden');
          } else {
            countdownRoot.setAttribute('hidden', '');
          }

          daysValue.textContent = formatCountdownValue(days);
          hoursValue.textContent = formatCountdownValue(hours);
          minsValue.textContent = formatCountdownValue(mins);
          secsValue.textContent = formatCountdownValue(secs);

          if (remainingSeconds <= 0 && countdownTimer) {
            window.clearInterval(countdownTimer);
            countdownTimer = null;
          }
        };

        updateCountdown();
        countdownTimer = window.setInterval(updateCountdown, 1000);
      }
    }

    const getWindowY = () => window.scrollY || window.pageYOffset || document.documentElement.scrollTop || 0;
    let lastY = getWindowY();
    const topThreshold = 8;
    const revealAfterUpDistance = 18;
    let upwardTravel = 0;
    let hiddenOffset = 0;
    let topExitMode = lastY <= topThreshold;

    const clamp = (value, min, max) => Math.min(max, Math.max(min, value));
    const headerHeight = () => header.getBoundingClientRect().height || 0;
    const headerSection = header.closest('.shopify-section');
    const syncHeaderSectionMinHeight = () => {
      if (!headerSection) return;
      headerSection.style.minHeight = `${headerHeight()}px`;
    };
    const applyOffset = () => {
      header.style.transform = `translateY(${-hiddenOffset}px)`;
    };
    const captureHeaderState = () => ({
      hiddenOffset,
      topExitMode,
      upwardTravel
    });
    const restoreHeaderState = (state) => {
      if (!state || typeof state !== 'object') return;
      const nextOffset = Number.parseFloat(`${state.hiddenOffset}`);
      hiddenOffset = clamp(Number.isFinite(nextOffset) ? nextOffset : 0, 0, headerHeight());
      topExitMode = typeof state.topExitMode === 'boolean'
        ? state.topExitMode
        : hiddenOffset < headerHeight();
      upwardTravel = 0;
      applyOffset();
      lastY = getWindowY();
    };

    window.SBHeaderNav = {
      ...(window.SBHeaderNav || {}),
      captureState: captureHeaderState,
      restoreState: restoreHeaderState
    };

    let syncMegaBackdropOnScroll = () => {};

    const dropdownMenuItems = header.querySelectorAll('.header__menu-item.has-dropdown');
    const plainMenuItems = header.querySelectorAll('.header__menu-item:not(.has-dropdown)');
    const megaBackdrops = Array.from(document.querySelectorAll('[data-header-mega-backdrop]'));
    if (dropdownMenuItems.length > 0) {
      let activeDropdownItem = null;
      let closeMenuTimer = null;
      let megaShadowTimer = null;
      let closeAfterShadowTimer = null;
      let pointerX = 0;
      let pointerY = 0;
      const menuSafePadding = 8;
      const megaShadowOpenDelay = 140;
      const megaCloseStartDelay = 0;
      const headerInner = header.querySelector('.header__inner');
      const headerMenu = header.querySelector('.header__menu');
      const dropdownMenuLinks = Array.from(dropdownMenuItems)
        .map((menuItem) => menuItem.querySelector('.header__menu-link'))
        .filter(Boolean);
      const clearMegaShadowTimer = () => {
        if (!megaShadowTimer) return;
        window.clearTimeout(megaShadowTimer);
        megaShadowTimer = null;
      };
      const setMegaShadowReady = (isReady) => {
        header.classList.toggle('is-mega-shadow-ready', Boolean(isReady));
      };
      const clearCloseAfterShadowTimer = () => {
        if (!closeAfterShadowTimer) return;
        window.clearTimeout(closeAfterShadowTimer);
        closeAfterShadowTimer = null;
      };
      const clearCloseMenuTimer = () => {
        if (!closeMenuTimer) return;
        window.clearTimeout(closeMenuTimer);
        closeMenuTimer = null;
      };
      const syncMegaBackdropTop = () => {
        if (!headerInner || megaBackdrops.length === 0) return;
        const navRect = headerInner.getBoundingClientRect();
        const navTop = Math.max(0, navRect.top);
        const navBottom = Math.min(window.innerHeight, navRect.bottom);
        const visibleNavHeight = Math.max(0, navBottom - navTop);
        const navIsTranslatingOut = hiddenOffset > 0.5;

        // If the header row is fully out of view, remove the nav cutout entirely.
        if (visibleNavHeight <= 1 || navIsTranslatingOut) {
          megaBackdrops.forEach((backdrop) => {
            if (backdrop.dataset.headerMegaBackdrop === 'top') {
              backdrop.style.top = '0px';
              backdrop.style.bottom = '100%';
            } else {
              backdrop.style.top = '0px';
              backdrop.style.bottom = '0px';
            }
          });
          return;
        }

        megaBackdrops.forEach((backdrop) => {
          if (backdrop.dataset.headerMegaBackdrop === 'top') {
            backdrop.style.top = '0px';
            backdrop.style.bottom = `${Math.max(0, window.innerHeight - navTop)}px`;
          } else {
            backdrop.style.top = `${navBottom}px`;
            backdrop.style.bottom = '0px';
          }
        });
      };

      syncMegaBackdropOnScroll = () => {
        if (!header.classList.contains('is-mega-open')) return;
        syncMegaBackdropTop();
      };

      const updateMegaOpenState = () => {
        const hasFocusedDropdown = Array.from(dropdownMenuItems).some((menuItem) => menuItem.contains(document.activeElement));
        const isMegaOpen = Boolean(activeDropdownItem) || hasFocusedDropdown;
        if (window.matchMedia('(max-width: 989px)').matches) {
          header.classList.remove('is-mega-open');
          setMegaShadowReady(false);
          clearMegaShadowTimer();
          clearCloseAfterShadowTimer();
          megaBackdrops.forEach((backdrop) => backdrop.classList.remove('is-active'));
          return;
        }
        if (isMegaOpen) {
          header.classList.add('is-mega-open');
          syncMegaBackdropTop();
          megaBackdrops.forEach((backdrop) => backdrop.classList.add('is-active'));
        } else {
          header.classList.remove('is-mega-open');
          megaBackdrops.forEach((backdrop) => backdrop.classList.remove('is-active'));
        }
      };

      const setActiveDropdownItem = (nextItem) => {
        if (activeDropdownItem === nextItem) {
          if (activeDropdownItem) {
            clearCloseAfterShadowTimer();
            clearMegaShadowTimer();
            if (!header.classList.contains('is-mega-shadow-ready')) {
              const expectedActiveItem = activeDropdownItem;
              megaShadowTimer = window.setTimeout(() => {
                if (activeDropdownItem !== expectedActiveItem) return;
                setMegaShadowReady(true);
              }, megaShadowOpenDelay);
            }
          }
          return;
        }
        clearCloseAfterShadowTimer();
        if (activeDropdownItem) activeDropdownItem.classList.remove('is-open');
        activeDropdownItem = nextItem || null;
        if (activeDropdownItem) activeDropdownItem.classList.add('is-open');
        clearMegaShadowTimer();
        if (activeDropdownItem) {
          setMegaShadowReady(false);
          const expectedActiveItem = activeDropdownItem;
          megaShadowTimer = window.setTimeout(() => {
            if (activeDropdownItem !== expectedActiveItem) return;
            setMegaShadowReady(true);
          }, megaShadowOpenDelay);
        } else {
          setMegaShadowReady(false);
        }
        updateMegaOpenState();
      };

      const closeActiveDropdown = () => {
        if (!activeDropdownItem) {
          clearMegaShadowTimer();
          clearCloseAfterShadowTimer();
          setMegaShadowReady(false);
          updateMegaOpenState();
          return;
        }
        clearMegaShadowTimer();
        clearCloseAfterShadowTimer();
        setMegaShadowReady(false);
        updateMegaOpenState();
        const closingItem = activeDropdownItem;
        closeAfterShadowTimer = window.setTimeout(() => {
          if (activeDropdownItem !== closingItem) return;
          setActiveDropdownItem(null);
        }, megaCloseStartDelay);
      };

      const getDropdownTrackBounds = () => {
        if (!headerMenu || dropdownMenuLinks.length === 0) return null;
        const menuRect = headerMenu.getBoundingClientRect();
        const firstRect = dropdownMenuLinks[0].getBoundingClientRect();
        const lastRect = dropdownMenuLinks[dropdownMenuLinks.length - 1].getBoundingClientRect();
        return {
          left: firstRect.left,
          right: lastRect.right,
          top: menuRect.top,
          bottom: menuRect.bottom
        };
      };

      const pointerInSafeCorridor = (menuItem) => {
        if (!menuItem || !headerInner) return false;
        const megaMenu = menuItem.querySelector('.header__mega-menu');
        if (!megaMenu) return false;
        const headerInnerRect = headerInner.getBoundingClientRect();
        const menuRect = megaMenu.getBoundingClientRect();
        const corridorTop = Math.min(headerInnerRect.bottom, menuRect.top);
        const corridorBottom = Math.max(headerInnerRect.bottom, menuRect.top);
        // Gap-safe zone follows the actual mega menu width.
        const corridorLeft = menuRect.left;
        const corridorRight = menuRect.right;
        return (
          pointerX >= corridorLeft
          && pointerX <= corridorRight
          && pointerY >= corridorTop
          && pointerY <= corridorBottom
        );
      };

      const pointerInMenuStrip = () => {
        const trackBounds = getDropdownTrackBounds();
        if (!trackBounds) return false;
        return (
          pointerY >= trackBounds.top
          && pointerY <= trackBounds.bottom
          && pointerX >= trackBounds.left - menuSafePadding
          && pointerX <= trackBounds.right + menuSafePadding
        );
      };

      const scheduleCloseActiveDropdown = () => {
        clearCloseMenuTimer();
        closeMenuTimer = window.setTimeout(() => {
          const activeMegaMenu = activeDropdownItem && activeDropdownItem.querySelector('.header__mega-menu');
          const megaHovered = Boolean(activeMegaMenu && activeMegaMenu.matches(':hover'));
          const inSafeCorridor = pointerInSafeCorridor(activeDropdownItem);
          const inMenuStrip = pointerInMenuStrip();
          if (megaHovered || inSafeCorridor || inMenuStrip) {
            scheduleCloseActiveDropdown();
            return;
          }
          closeActiveDropdown();
        }, 120);
      };

      dropdownMenuItems.forEach((menuItem) => {
        const menuLink = menuItem.querySelector('.header__menu-link');
        const megaMenu = menuItem.querySelector('.header__mega-menu');
        if (menuLink) {
          menuLink.addEventListener('mouseenter', () => {
            clearCloseMenuTimer();
            setActiveDropdownItem(menuItem);
          });
        }

        menuItem.addEventListener('focusin', () => {
          clearCloseMenuTimer();
          setActiveDropdownItem(menuItem);
        });

        menuItem.addEventListener('focusout', (event) => {
          if (menuItem.contains(event.relatedTarget)) return;
          window.requestAnimationFrame(() => {
            if (!header.contains(document.activeElement)) closeActiveDropdown();
            else updateMegaOpenState();
          });
        });

        if (megaMenu) {
          megaMenu.addEventListener('mouseenter', () => {
            clearCloseMenuTimer();
            setActiveDropdownItem(menuItem);
          });

          megaMenu.addEventListener('mouseleave', () => {
            scheduleCloseActiveDropdown();
          });
        }
      });

      plainMenuItems.forEach((menuItem) => {
        const menuLink = menuItem.querySelector('.header__menu-link');
        if (!menuLink) return;
        menuLink.addEventListener('mouseenter', () => {
          clearCloseMenuTimer();
          closeActiveDropdown();
        });
      });

      header.addEventListener('mouseenter', () => {
        clearCloseMenuTimer();
      });

      header.addEventListener('mouseleave', () => {
        scheduleCloseActiveDropdown();
      });

      if (headerInner) {
        headerInner.addEventListener('mousemove', (event) => {
          if (!activeDropdownItem) return;
          if (window.matchMedia('(max-width: 989px)').matches) return;
          const trackBounds = getDropdownTrackBounds();
          if (!trackBounds) return;
          const aboveMenuStrip = event.clientY < (trackBounds.top - menuSafePadding);
          if (aboveMenuStrip) {
            clearCloseMenuTimer();
            closeActiveDropdown();
            return;
          }
          const withinMenuBand = event.clientY >= trackBounds.top && event.clientY <= trackBounds.bottom;
          const outsideMenuHorizontally = event.clientX < (trackBounds.left - menuSafePadding)
            || event.clientX > (trackBounds.right + menuSafePadding);
          if (!withinMenuBand || !outsideMenuHorizontally) return;
          clearCloseMenuTimer();
          closeActiveDropdown();
        });
      }

      document.addEventListener('pointerdown', (event) => {
        if (header.contains(event.target)) return;
        clearCloseMenuTimer();
        closeActiveDropdown();
      });

      document.addEventListener(
        'pointermove',
        (event) => {
          pointerX = event.clientX;
          pointerY = event.clientY;
        },
        { passive: true }
      );

      window.addEventListener(
        'resize',
        () => {
          clearCloseMenuTimer();
          closeActiveDropdown();
          syncMegaBackdropTop();
          updateMegaOpenState();
        },
        { passive: true }
      );

      syncMegaBackdropTop();
    }

    const sync = (currentY, { force = false } = {}) => {
      const delta = currentY - lastY;
      const maxOffset = headerHeight();

      if (force || currentY <= topThreshold) {
        hiddenOffset = 0;
        upwardTravel = 0;
        topExitMode = true;
        applyOffset();
        lastY = currentY;
        return;
      }

      if (delta > 0) {
        upwardTravel = 0;
        if (topExitMode) {
          // Only when leaving the top, follow page scroll.
          hiddenOffset = clamp(currentY, 0, maxOffset);
          if (hiddenOffset >= maxOffset - 0.5 || currentY > maxOffset) topExitMode = false;
        } else {
          // Everywhere else, hide instantly on downward scroll.
          hiddenOffset = maxOffset;
        }
        applyOffset();
      } else if (delta < 0) {
        upwardTravel += Math.abs(delta);
        if (upwardTravel >= revealAfterUpDistance) {
          hiddenOffset = 0;
          upwardTravel = 0;
          applyOffset();
        }
      }

      lastY = currentY;
    };

    const onWindowScroll = () => {
      sync(getWindowY());
      syncMegaBackdropOnScroll();
    };

    window.addEventListener('scroll', onWindowScroll, { passive: true });
    window.addEventListener(
      'resize',
      () => {
        sync(getWindowY(), { force: true });
        syncHeaderSectionMinHeight();
      },
      { passive: true }
    );
    window.requestAnimationFrame(() => {
      sync(getWindowY(), { force: true });
      syncHeaderSectionMinHeight();
    });
    window.setTimeout(syncHeaderSectionMinHeight, 300);

    const cartDrawer = document.querySelector('[data-cart-drawer]');
    const cartDrawerStatus = document.querySelector('[data-cart-drawer-status]');
    const cartDrawerItems = document.querySelector('[data-cart-drawer-items]');
    const cartDrawerRefresh = document.querySelector('[data-cart-drawer-refresh]');
    const cartDrawerClear = document.querySelector('[data-cart-drawer-clear]');
    const cartDrawerCloseButtons = document.querySelectorAll('[data-cart-drawer-close]');
    const headerCartLink = header.querySelector('[data-header-cart-link]');
    const headerCartCount = header.querySelector('[data-header-cart-count]');
    const shopRoot = (() => {
      const root = window.Shopify && window.Shopify.routes && typeof window.Shopify.routes.root === 'string'
        ? window.Shopify.routes.root
        : '/';
      return root.endsWith('/') ? root : `${root}/`;
    })();
    const cartUrl = (path) => `${shopRoot}${path}`;

    let previousCartCount = (() => {
      if (!headerCartCount) return 0;
      const parsed = Number.parseInt(`${headerCartCount.textContent || '0'}`, 10);
      return Number.isFinite(parsed) ? parsed : 0;
    })();

    const triggerCartBadgeAnimation = () => {
      if (!headerCartCount || headerCartCount.hidden) return;
      headerCartCount.classList.remove('is-bump');
      void headerCartCount.offsetWidth;
      headerCartCount.classList.add('is-bump');
    };

    const setCartCount = (count, { animate = true } = {}) => {
      if (!headerCartCount) return;
      const parsedCount = Number.parseInt(`${count}`, 10);
      const normalizedCount = Number.isFinite(parsedCount) ? Math.max(0, parsedCount) : 0;
      const wasHidden = headerCartCount.hidden;
      if (normalizedCount <= 0) {
        headerCartCount.textContent = '';
        headerCartCount.hidden = true;
        headerCartCount.classList.remove('is-double-digit', 'is-bump');
        previousCartCount = 0;
        return;
      }
      const displayCount = normalizedCount > 99 ? '99+' : `${normalizedCount}`;
      headerCartCount.textContent = displayCount;
      headerCartCount.hidden = false;
      headerCartCount.classList.toggle('is-double-digit', displayCount.length > 1);
      const shouldAnimate = animate && normalizedCount > 0 && (wasHidden || normalizedCount !== previousCartCount);
      previousCartCount = normalizedCount;
      if (shouldAnimate) triggerCartBadgeAnimation();
    };

    if (headerCartCount) {
      headerCartCount.addEventListener('animationend', () => {
        headerCartCount.classList.remove('is-bump');
      });
    }

    const formatMoney = (cents, currency = 'USD') => {
      const normalizedCents = Number.isFinite(Number(cents)) ? Number(cents) : 0;
      try {
        return new Intl.NumberFormat(undefined, { style: 'currency', currency }).format(normalizedCents / 100);
      } catch (_) {
        return `${(normalizedCents / 100).toFixed(2)} ${currency}`;
      }
    };

    const renderCartItems = (cart) => {
      if (!cartDrawerItems || !cartDrawerStatus) return;
      cartDrawerItems.innerHTML = '';
      setCartCount(cart.item_count || 0);

      if (!cart.items || cart.items.length === 0) {
        cartDrawerStatus.textContent = 'Cart is empty.';
        return;
      }

      cartDrawerStatus.textContent = `${cart.item_count} item${cart.item_count === 1 ? '' : 's'} in cart`;
      cart.items.forEach((item) => {
        const row = document.createElement('li');
        row.className = 'header__cart-drawer-item';
        const variantTitle = item.variant_title && item.variant_title !== 'Default Title' ? item.variant_title : '';
        row.innerHTML = `
          <div class="header__cart-drawer-item-info">
            <p class="header__cart-drawer-item-title">${item.product_title}</p>
            ${variantTitle ? `<p class="header__cart-drawer-item-variant">${variantTitle}</p>` : ''}
            <p class="header__cart-drawer-item-price">${formatMoney(item.final_line_price, cart.currency || 'USD')}</p>
          </div>
          <span class="header__cart-drawer-item-qty">x${item.quantity}</span>
        `;
        cartDrawerItems.appendChild(row);
      });
    };

    const fetchCart = async () => {
      const response = await fetch(cartUrl('cart.js'), {
        method: 'GET',
        headers: { Accept: 'application/json' }
      });
      if (!response.ok) throw new Error('Cart fetch failed');
      return response.json();
    };

    const openCartDrawer = () => {
      if (!cartDrawer) return;
      cartDrawer.removeAttribute('hidden');
      document.documentElement.style.overflow = 'hidden';
    };

    const closeCartDrawer = () => {
      if (!cartDrawer) return;
      cartDrawer.setAttribute('hidden', '');
      document.documentElement.style.overflow = '';
    };

    const refreshCartDrawer = async () => {
      if (!cartDrawerStatus) return;
      cartDrawerStatus.textContent = 'Loading cart...';
      try {
        const cart = await fetchCart();
        renderCartItems(cart);
        return cart;
      } catch (error) {
        cartDrawerStatus.textContent = 'Unable to load cart.';
        throw error;
      }
    };

    const dispatchCartChanged = (cart, source = 'unknown', itemCount = 0) => {
      const detail = { cart, source, itemCount };
      document.dispatchEvent(new CustomEvent('sb:cart:changed', { detail }));
      document.dispatchEvent(new CustomEvent('cart:updated', { detail }));
      document.dispatchEvent(
        new CustomEvent('cart:update', {
          bubbles: true,
          detail: {
            resource: cart,
            sourceId: 'header-cart',
            data: {
              source,
              itemCount
            }
          }
        })
      );
    };

    const clearCart = async () => {
      if (cartDrawerStatus) cartDrawerStatus.textContent = 'Clearing cart...';
      const response = await fetch(cartUrl('cart/clear.js'), {
        method: 'POST',
        headers: { Accept: 'application/json' }
      });
      if (!response.ok) throw new Error('Cart clear failed');
      const cart = await fetchCart();
      renderCartItems(cart);
      dispatchCartChanged(cart, 'clear');
      return cart;
    };

    const animateFlyToCart = ({ sourceElement, imageSrc }) => {
      if (!sourceElement || !headerCartLink || !imageSrc) return;
      const sourceRect = sourceElement.getBoundingClientRect();
      const targetRect = headerCartLink.getBoundingClientRect();
      if (!sourceRect.width || !sourceRect.height || !targetRect.width || !targetRect.height) return;

      const fly = document.createElement('img');
      fly.src = imageSrc;
      fly.alt = '';
      fly.setAttribute('aria-hidden', 'true');
      fly.style.position = 'fixed';
      fly.style.left = `${sourceRect.left + sourceRect.width / 2 - 24}px`;
      fly.style.top = `${sourceRect.top + sourceRect.height / 2 - 24}px`;
      fly.style.width = `${Math.max(48, Math.min(96, sourceRect.width * 0.35))}px`;
      fly.style.height = fly.style.width;
      fly.style.borderRadius = '999px';
      fly.style.objectFit = 'cover';
      fly.style.pointerEvents = 'none';
      fly.style.zIndex = '120';
      fly.style.boxShadow = '0 0 24px 0 var(--sb-color-always-black-25)';
      document.body.appendChild(fly);

      const deltaX = targetRect.left + targetRect.width / 2 - (sourceRect.left + sourceRect.width / 2);
      const deltaY = targetRect.top + targetRect.height / 2 - (sourceRect.top + sourceRect.height / 2);
      const animation = fly.animate(
        [
          { transform: 'translate3d(0, 0, 0) scale(1)', opacity: 1 },
          { transform: `translate3d(${deltaX}px, ${deltaY}px, 0) scale(0.2)`, opacity: 0.2 }
        ],
        { duration: 420, easing: 'cubic-bezier(.2,.8,.2,1)', fill: 'forwards' }
      );
      animation.addEventListener('finish', () => fly.remove(), { once: true });
      animation.addEventListener('cancel', () => fly.remove(), { once: true });
    };

    const addToCart = async (variantId, { quantity = 1, sourceElement = null, imageSrc = '' } = {}) => {
      const variantIdValue = `${variantId}`.trim();
      const parsedQuantity = Number.parseInt(`${quantity}`, 10);
      if (!variantIdValue) throw new Error('Invalid variant id');
      if (!Number.isFinite(parsedQuantity) || parsedQuantity <= 0) throw new Error('Invalid quantity');

      const formData = new FormData();
      formData.append('id', variantIdValue);
      formData.append('quantity', `${parsedQuantity}`);

      const response = await fetch(cartUrl('cart/add.js'), {
        method: 'POST',
        headers: {
          Accept: 'application/json'
        },
        credentials: 'same-origin',
        body: formData
      });
      if (!response.ok) {
        const errorBody = await response.text();
        throw new Error(`Add to cart failed: ${errorBody || response.status}`);
      }
      const cart = await fetchCart();
      renderCartItems(cart);
      dispatchCartChanged(cart, 'add', parsedQuantity);
      animateFlyToCart({ sourceElement, imageSrc });
      openCartDrawer();
      return cart;
    };

    window.SBCart = {
      ...(window.SBCart || {}),
      fetch: fetchCart,
      refresh: refreshCartDrawer,
      open: openCartDrawer,
      close: closeCartDrawer,
      clear: clearCart,
      add: addToCart
    };

    if (headerCartLink) {
      headerCartLink.addEventListener('click', (event) => {
        event.preventDefault();
        openCartDrawer();
        refreshCartDrawer();
      });
    }

    cartDrawerCloseButtons.forEach((button) => {
      button.addEventListener('click', () => closeCartDrawer());
    });

    if (cartDrawerRefresh) {
      cartDrawerRefresh.addEventListener('click', () => {
        refreshCartDrawer();
      });
    }

    if (cartDrawerClear) {
      cartDrawerClear.addEventListener('click', async () => {
        try {
          await clearCart();
        } catch (error) {
          if (cartDrawerStatus) cartDrawerStatus.textContent = 'Unable to clear cart.';
        }
      });
    }

    document.addEventListener('keydown', (event) => {
      if (event.key !== 'Escape') return;
      if (!cartDrawer || cartDrawer.hasAttribute('hidden')) return;
      closeCartDrawer();
    });

    document.addEventListener('sb:cart:changed', (event) => {
      const cart = event.detail && event.detail.cart;
      if (cart) {
        renderCartItems(cart);
        return;
      }
      refreshCartDrawer();
    });

    document.addEventListener('cart:update', (event) => {
      const cart = event.detail && event.detail.resource;
      if (cart) {
        renderCartItems(cart);
        const source = event.detail && event.detail.data && event.detail.data.source;
        if (source && source !== 'header-cart') {
          openCartDrawer();
        }
        return;
      }
      refreshCartDrawer();
    });

    document.addEventListener('sb:cart-badge:debug-bump', (event) => {
      const requestedCount = event.detail && Number.parseInt(`${event.detail.count}`, 10);
      const nextCount = Number.isFinite(requestedCount)
        ? Math.max(0, requestedCount)
        : Math.max(1, previousCartCount + 1);
      setCartCount(nextCount, { animate: true });
    });

    refreshCartDrawer();
  })();
</script>

{% schema %}
{
  "name": "t:general.header",
  "settings": [
    {
      "type": "link_list",
      "id": "menu",
      "label": "t:labels.menu",
      "info": "Top-level navigation. Dropdown content is configured with mega menu items below."
    }
  ],
  "blocks": [
    {
      "type": "mega_menu_item_product",
      "name": "Mega menu product",
      "settings": [
        {
          "type": "select",
          "id": "menu_item_index",
          "label": "Menu item index",
          "default": "1",
          "options": [
            {
              "value": "1",
              "label": "1"
            },
            {
              "value": "2",
              "label": "2"
            },
            {
              "value": "3",
              "label": "3"
            },
            {
              "value": "4",
              "label": "4"
            },
            {
              "value": "5",
              "label": "5"
            },
            {
              "value": "6",
              "label": "6"
            }
          ],
          "info": "Assign this item to a top-level menu item by position."
        },
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "checkbox",
          "id": "hide_on_mobile",
          "label": "Hide on mobile",
          "default": false
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image",
          "info": "Target minimum 584x584 at 1x export (584x584)."
        },
        {
          "type": "collection",
          "id": "accessories_collection",
          "label": "Accessories collection"
        }
      ]
    },
    {
      "type": "mega_menu_item_collection",
      "name": "Mega menu collection",
      "settings": [
        {
          "type": "select",
          "id": "menu_item_index",
          "label": "Menu item index",
          "default": "1",
          "options": [
            { "value": "1", "label": "1" },
            { "value": "2", "label": "2" },
            { "value": "3", "label": "3" },
            { "value": "4", "label": "4" },
            { "value": "5", "label": "5" },
            { "value": "6", "label": "6" }
          ],
          "info": "Assign this item to a top-level menu item by position."
        },
        {
          "type": "collection",
          "id": "collection",
          "label": "Collection"
        },
        {
          "type": "checkbox",
          "id": "hide_on_mobile",
          "label": "Hide on mobile",
          "default": false
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image",
          "info": "Target minimum 584x584 at 1x export (584x584)."
        },
        {
          "type": "product",
          "id": "related_product_1",
          "label": "Linked product 1"
        },
        {
          "type": "product",
          "id": "related_product_2",
          "label": "Linked product 2"
        },
        {
          "type": "product",
          "id": "related_product_3",
          "label": "Linked product 3"
        }
      ]
    },
    {
      "type": "mega_menu_item_page",
      "name": "Mega menu page",
      "settings": [
        {
          "type": "select",
          "id": "menu_item_index",
          "label": "Menu item index",
          "default": "1",
          "options": [
            { "value": "1", "label": "1" },
            { "value": "2", "label": "2" },
            { "value": "3", "label": "3" },
            { "value": "4", "label": "4" },
            { "value": "5", "label": "5" },
            { "value": "6", "label": "6" }
          ],
          "info": "Assign this item to a top-level menu item by position."
        },
        {
          "type": "page",
          "id": "page",
          "label": "Page"
        },
        {
          "type": "checkbox",
          "id": "hide_on_mobile",
          "label": "Hide on mobile",
          "default": false
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image",
          "info": "Target minimum 584x584 at 1x export (584x584)."
        }
      ]
    },
    {
      "type": "mega_menu_item_app",
      "name": "Mega menu mobile app",
      "settings": [
        {
          "type": "select",
          "id": "menu_item_index",
          "label": "Menu item index",
          "default": "1",
          "options": [
            { "value": "1", "label": "1" },
            { "value": "2", "label": "2" },
            { "value": "3", "label": "3" },
            { "value": "4", "label": "4" },
            { "value": "5", "label": "5" },
            { "value": "6", "label": "6" }
          ],
          "info": "Assign this item to a top-level menu item by position."
        },
        {
          "type": "checkbox",
          "id": "hide_on_mobile",
          "label": "Hide on mobile",
          "default": false
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image",
          "info": "Target minimum 584x584 at 1x export (584x584)."
        }
      ]
    }
  ],
  "max_blocks": 32,
  "presets": [
    {
      "name": "t:general.header",
      "blocks": [
        {
          "type": "mega_menu_item_product",
          "settings": {
            "menu_item_index": "1"
          }
        }
      ]
    }
  ]
}
{% endschema %}
