<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Organization",
    "name": {{ shop.name | json }},
    {% if settings.logo %}
      "logo": {{ settings.logo | image_url: width: 500 | prepend: "https:" | json }},
    {% endif %}
    "url": {{ request.origin | append: page.url | json }}
  }
</script>

{% liquid
  assign seasonal_sale_name = settings.seasonal_sale_name | strip
  assign announcement_text = settings.seasonal_announcement_copy | strip
  assign announcement_text = announcement_text | replace: '{{ Seasonal sale name }}', seasonal_sale_name
  assign show_announcement = false
  if announcement_text != blank
    assign show_announcement = true
  endif
  assign sale_end_date = settings.seasonal_sale_end_date | strip
  assign show_announcement_countdown = false
  if show_announcement and sale_end_date != blank
    assign show_announcement_countdown = true
  endif
  assign announcement_gradient = settings.seasonal_announcement_gradient | default: 'linear-gradient(90deg, #E9CC92 0%, #92734F 33%, #92734F 66%, #E9CC92 100%)'
  assign announcement_emoji_asset = 'emoji-sale-new-year.png'

  case announcement_gradient
    when 'linear-gradient(90deg, #E9CC92 0%, #92734F 33%, #92734F 66%, #E9CC92 100%)'
      assign announcement_emoji_asset = 'emoji-sale-new-year.png'
    when 'linear-gradient(90deg, #F3C1DE 0%, #C77CA5 33%, #C77CA5 66%, #F3C1DE 100%)'
      assign announcement_emoji_asset = 'emoji-sale-valentines-day.png'
    when 'linear-gradient(90deg, #A4CF83 0%, #768E57 33%, #768E57 66%, #A4CF83 100%)'
      assign announcement_emoji_asset = 'emoji-sale-spring.png'
    when 'linear-gradient(90deg, #B19CD9 0%, #7B5EA7 33%, #7B5EA7 66%, #B19CD9 100%)'
      assign announcement_emoji_asset = 'emoji-sale-easter.png'
    when 'linear-gradient(90deg, #9CBDCD 0%, #F08835 33%, #F08835 66%, #9CBDCD 100%)'
      assign announcement_emoji_asset = 'emoji-sale-summer.png'
    when 'linear-gradient(90deg, #E6A53C 0%, #1E4F8F 33%, #1E4F8F 66%, #E6A53C 100%)'
      assign announcement_emoji_asset = 'emoji-sale-back-to-school.png'
    when 'linear-gradient(90deg, #1F3937 0%, #57522A 33%, #E58C56 66%, #6F351F 100%)'
      assign announcement_emoji_asset = 'emoji-sale-fall.png'
    when 'linear-gradient(90deg, #2F173A 0%, #D84418 33%, #D84418 66%, #2F173A 100%)'
      assign announcement_emoji_asset = 'emoji-sale-halloween.png'
    when 'linear-gradient(90deg, #8759F1 0%, #023CFB 33%, #8759F1 66%, #023CFB 100%)'
      assign announcement_emoji_asset = 'emoji-sale-bfcm.png'
    when 'linear-gradient(90deg, #B49F76 0%, #C32B2E 33%, #C32B2E 66%, #B49F76 100%)'
      assign announcement_emoji_asset = 'emoji-sale-holiday.png'
    when 'linear-gradient(90deg, var(--sb-color-primary-500) 0%, var(--sb-color-primary-700) 33%, var(--sb-color-primary-700) 66%, var(--sb-color-primary-500) 100%)'
      assign announcement_emoji_asset = 'emoji-sale-anniversary.png'
  endcase
%}

<header
  class="header full-width{% if show_announcement %} has-announcement{% endif %}"
  {% if show_announcement %}
    style="--sb-announcement-background: {{ announcement_gradient }};"
  {% endif %}
>
  {% if show_announcement %}
    <div class="header__announcement">
      <div class="header__announcement-top">
        <span class="header__announcement-emoji" aria-hidden="true">
          <img src="{{ announcement_emoji_asset | asset_url }}" alt="" loading="eager" width="20" height="20">
        </span>
        <p class="header__announcement-text font-caption weight-semibold">{{ announcement_text | escape | newline_to_br }}</p>
        <span class="header__announcement-emoji" aria-hidden="true">
          <img src="{{ announcement_emoji_asset | asset_url }}" alt="" loading="eager" width="20" height="20">
        </span>
      </div>

      {% if show_announcement_countdown %}
        <div class="header__announcement-countdown" data-announcement-countdown data-sale-end-date="{{ sale_end_date | escape }}">
          <div class="header__announcement-countdown-group">
            <span class="header__announcement-countdown-value font-caption weight-bold" data-countdown-days>00</span>
            <span class="header__announcement-countdown-label font-caption2 weight-semibold">days</span>
          </div>
          <div class="header__announcement-countdown-group">
            <span class="header__announcement-countdown-value font-caption weight-bold" data-countdown-hours>00</span>
            <span class="header__announcement-countdown-label font-caption2 weight-semibold">hours</span>
          </div>
          <div class="header__announcement-countdown-group">
            <span class="header__announcement-countdown-value font-caption weight-bold" data-countdown-mins>00</span>
            <span class="header__announcement-countdown-label font-caption2 weight-semibold">mins</span>
          </div>
          <div class="header__announcement-countdown-group">
            <span class="header__announcement-countdown-value font-caption weight-bold" data-countdown-secs>00</span>
            <span class="header__announcement-countdown-label font-caption2 weight-semibold">secs</span>
          </div>
        </div>
      {% endif %}
    </div>
  {% endif %}

  <div class="header__inner">
    <div class="header__icons header__icons--left">
      <a class="header__icon-link header__icon-link--search" href="{{ routes.search_url }}" aria-label="Search">
        <span class="header__icon-asset" aria-hidden="true">
          {{ 'icon-search.svg' | inline_asset_content }}
        </span>
      </a>
      <a class="header__icon-link header__icon-link--search" href="{{ routes.search_url }}" aria-label="Search">
        <span class="header__icon-asset" aria-hidden="true">
          {{ 'icon-search.svg' | inline_asset_content }}
        </span>
      </a>
    </div>

    <a class="header__brand" href="{{ routes.root_url }}" aria-label="{{ shop.name | escape }}">
      <span class="header__brand-logo" aria-hidden="true">
        {{ 'logo-soundbrenner-wordmark.svg' | inline_asset_content }}
      </span>
    </a>

    <nav class="header__menu" aria-label="Primary">
      {% if section.settings.menu != blank and section.settings.menu.links.size > 0 %}
        {% for link in section.settings.menu.links %}
          {% liquid
            assign link_handle = link.title | handleize
            assign link_path = link.url | split: '?' | first
            assign is_active_link = false
            if link.current or request.path == link_path
              assign is_active_link = true
            endif

            assign has_mega_group = false
            assign has_mega_cards = false

            for block in section.blocks
              if block.type == 'mega_menu_group'
                assign group_handle = block.settings.menu_item_handle | strip | handleize
                if group_handle == link_handle
                  assign has_mega_group = true
                endif
              endif
            endfor

            for block in section.blocks
              if block.type == 'mega_menu_card'
                assign card_handle = block.settings.menu_item_handle | strip | handleize
                if card_handle == link_handle
                  assign has_mega_cards = true
                endif
              endif
            endfor

            assign show_placeholder_menu = false
            if link_handle == 'in-ear-monitors' and has_mega_cards == false
              assign show_placeholder_menu = true
            endif

            assign has_dropdown = false
            if has_mega_group and has_mega_cards
              assign has_dropdown = true
            elsif show_placeholder_menu
              assign has_dropdown = true
            endif
          %}

          <div class="header__menu-item{% if has_dropdown %} has-dropdown{% endif %}">
            <a
              class="header__menu-link font-caption weight-regular{% if is_active_link %} is-active{% endif %}"
              href="{{ link.url }}"
            >
              {{ link.title }}
            </a>

            {% if has_dropdown %}
              <div class="header__mega-menu" aria-label="{{ link.title | escape }}">
                <div class="header__mega-menu-panel">
                  <div class="header__mega-menu-grid">
                    {% assign rendered_cards = 0 %}

                    {% for block in section.blocks %}
                      {% liquid
                        if block.type != 'mega_menu_card'
                          continue
                        endif

                        assign block_handle = block.settings.menu_item_handle | strip | handleize
                        if block_handle != link_handle
                          continue
                        endif

                        assign rendered_cards = rendered_cards | plus: 1
                        assign card_product = block.settings.product
                        assign card_collection = block.settings.collection
                        assign card_page = block.settings.page
                        assign card_image = block.settings.image
                        assign card_title = block.settings.title | strip
                        assign card_body = block.settings.body | strip
                        assign card_mode = block.settings.card_mode
                        assign card_link = block.settings.card_link
                        assign card_rating_label = block.settings.app_rating_label | strip
                        assign card_submenu = block.settings.submenu

                        if card_link == blank
                          if card_product != blank
                            assign card_link = card_product.url
                          elsif card_collection != blank
                            assign card_link = card_collection.url
                          elsif card_page != blank
                            assign card_link = card_page.url
                          endif
                        endif

                        if card_title == blank
                          if card_product != blank
                            assign card_title = card_product.title
                          elsif card_collection != blank
                            assign card_title = card_collection.title
                          elsif card_page != blank
                            assign card_title = card_page.title
                          endif
                        endif

                        assign card_image_url = blank
                        if card_image != blank
                          assign card_image_url = card_image | image_url: width: 584
                        elsif card_product != blank and card_product.featured_image != blank
                          assign card_image_url = card_product.featured_image | image_url: width: 584
                        elsif card_collection != blank and card_collection.featured_image != blank
                          assign card_image_url = card_collection.featured_image | image_url: width: 584
                        endif

                        assign card_badge_label = blank
                        assign card_badge_type = blank
                        if card_product != blank and card_product.tags != blank
                          for product_tag in card_product.tags
                            assign product_tag_downcase = product_tag | downcase
                            if product_tag_downcase == 'bestseller'
                              assign card_badge_label = 'Bestseller'
                              assign card_badge_type = 'bestseller'
                              break
                            endif
                            if product_tag_downcase == 'new'
                              assign card_badge_label = 'New'
                              assign card_badge_type = 'new'
                            endif
                          endfor
                        endif
                      %}

                      <article class="header__mega-card" {{ block.shopify_attributes }}>
                        <a class="header__mega-card-media" href="{{ card_link | default: '#' }}">
                          {% if card_badge_label != blank %}
                            <span class="header__mega-card-badge header__mega-card-badge--{{ card_badge_type }} font-caption weight-semibold">
                              {{ card_badge_label }}
                            </span>
                          {% endif %}

                          {% if card_image_url != blank %}
                            <img
                              class="header__mega-card-image"
                              src="{{ card_image_url }}"
                              alt="{{ card_title | default: link.title | escape }}"
                              loading="lazy"
                              decoding="async"
                              width="584"
                              height="584"
                            >
                          {% else %}
                            <span class="header__mega-card-image-placeholder font-caption weight-semibold">Image</span>
                          {% endif %}
                        </a>

                        <a class="header__mega-card-title font-callout weight-bold" href="{{ card_link | default: '#' }}">
                          {{ card_title | default: link.title }}
                        </a>

                        {% if card_mode == 'app' %}
                          <div class="header__mega-card-app">
                            <p class="header__mega-card-rating font-body weight-regular">
                              <span class="header__mega-card-stars" aria-hidden="true">★★★★★</span>
                              <span>{{ card_rating_label | default: '4.8 stars on app stores' }}</span>
                            </p>

                            <div class="header__mega-card-app-links">
                              {% if block.settings.app_store_url != blank %}
                                <a href="{{ block.settings.app_store_url }}" aria-label="Download on the App Store">
                                  <img
                                    src="{{ 'app-download-app-store.png' | asset_url }}"
                                    alt="Download on the App Store"
                                    loading="lazy"
                                    width="120"
                                    height="36"
                                  >
                                </a>
                              {% endif %}
                              {% if block.settings.google_play_url != blank %}
                                <a href="{{ block.settings.google_play_url }}" aria-label="Get it on Google Play">
                                  <img
                                    src="{{ 'app-download-google-play.png' | asset_url }}"
                                    alt="Get it on Google Play"
                                    loading="lazy"
                                    width="120"
                                    height="36"
                                  >
                                </a>
                              {% endif %}
                            </div>
                          </div>
                        {% else %}
                          {% if card_body != blank %}
                            <p class="header__mega-card-body font-body weight-regular">{{ card_body }}</p>
                          {% endif %}

                          {% if card_submenu != blank and card_submenu.links.size > 0 %}
                            <ul class="header__mega-card-links font-body weight-semibold" role="list">
                              {% for submenu_link in card_submenu.links limit: 3 %}
                                <li>
                                  <a href="{{ submenu_link.url }}">{{ submenu_link.title }}</a>
                                </li>
                              {% endfor %}
                            </ul>
                          {% endif %}
                        {% endif %}
                      </article>
                    {% endfor %}

                    {% if rendered_cards == 0 and show_placeholder_menu %}
                      {% liquid
                        assign placeholder_product = all_products['wave-in-ear-monitors']
                        if placeholder_product == blank
                          assign placeholder_product = all_products['wave']
                        endif
                        assign placeholder_collection = collections['wave-in-ear-monitors']
                        assign placeholder_collection_url = routes.root_url | append: 'collections/wave-in-ear-monitors'
                        if placeholder_collection != blank
                          assign placeholder_collection_url = placeholder_collection.url
                        endif
                        assign placeholder_link = placeholder_collection_url
                        assign placeholder_image_url = blank
                        if placeholder_product != blank and placeholder_product.featured_image != blank
                          assign placeholder_image_url = placeholder_product.featured_image | image_url: width: 584
                          assign placeholder_link = placeholder_product.url
                        endif
                      %}
                      <article class="header__mega-card header__mega-card--placeholder">
                        <a class="header__mega-card-media" href="{{ placeholder_link }}">
                          {% if placeholder_image_url != blank %}
                            <img
                              class="header__mega-card-image"
                              src="{{ placeholder_image_url }}"
                              alt="Wave in-ear monitors"
                              loading="lazy"
                              decoding="async"
                              width="584"
                              height="584"
                            >
                          {% else %}
                            <span class="header__mega-card-image-placeholder font-caption weight-semibold">Wave</span>
                          {% endif %}
                        </a>

                        <a class="header__mega-card-title font-callout weight-bold" href="{{ placeholder_link }}">
                          Wave in-ear monitors
                        </a>
                        <p class="header__mega-card-body font-body weight-regular">Placeholder dropdown card. Replace in Header block settings.</p>
                        <ul class="header__mega-card-links font-body weight-semibold" role="list">
                          <li><a href="{{ placeholder_collection_url }}">Accessories</a></li>
                        </ul>
                      </article>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        {% liquid
          assign placeholder_product = all_products['wave-in-ear-monitors']
          if placeholder_product == blank
            assign placeholder_product = all_products['wave']
          endif
          assign placeholder_collection = collections['wave-in-ear-monitors']
          assign placeholder_collection_url = routes.root_url | append: 'collections/wave-in-ear-monitors'
          if placeholder_collection != blank
            assign placeholder_collection_url = placeholder_collection.url
          endif
          assign placeholder_link = placeholder_collection_url
          assign placeholder_image_url = blank
          if placeholder_product != blank and placeholder_product.featured_image != blank
            assign placeholder_image_url = placeholder_product.featured_image | image_url: width: 584
            assign placeholder_link = placeholder_product.url
          endif
        %}

        <div class="header__menu-item has-dropdown">
          <a class="header__menu-link font-caption weight-regular" href="{{ routes.root_url }}collections/in-ear-monitors">In-ear monitors</a>
          <div class="header__mega-menu" aria-label="In-ear monitors">
            <div class="header__mega-menu-panel">
              <div class="header__mega-menu-grid">
                <article class="header__mega-card header__mega-card--placeholder">
                  <a class="header__mega-card-media" href="{{ placeholder_link }}">
                    {% if placeholder_image_url != blank %}
                      <img
                        class="header__mega-card-image"
                        src="{{ placeholder_image_url }}"
                        alt="Wave in-ear monitors"
                        loading="lazy"
                        decoding="async"
                        width="584"
                        height="584"
                      >
                    {% else %}
                      <span class="header__mega-card-image-placeholder font-caption weight-semibold">Wave</span>
                    {% endif %}
                  </a>
                  <a class="header__mega-card-title font-callout weight-bold" href="{{ placeholder_link }}">Wave in-ear monitors</a>
                  <p class="header__mega-card-body font-body weight-regular">Placeholder dropdown card. Add menu blocks in Header settings.</p>
                  <ul class="header__mega-card-links font-body weight-semibold" role="list">
                    <li><a href="{{ placeholder_collection_url }}">Accessories</a></li>
                  </ul>
                </article>
              </div>
            </div>
          </div>
        </div>
        <a class="header__menu-link font-caption weight-regular" href="{{ routes.root_url }}collections/wearables">Wearables</a>
        <a class="header__menu-link font-caption weight-regular" href="{{ routes.root_url }}collections/earplugs">Earplugs</a>
        <a class="header__menu-link font-caption weight-regular" href="{{ routes.root_url }}collections/all">More products</a>
        <a class="header__menu-link font-caption weight-regular" href="{{ routes.root_url }}pages/support">Support</a>
      {% endif %}
    </nav>

    <div class="header__icons header__icons--right">
      <a
        class="header__icon-link header__icon-link--search header__icon-link--desktop-only"
        href="{{ routes.search_url }}"
        aria-label="Search"
      >
        <span class="header__icon-asset" aria-hidden="true">
          {{ 'icon-search.svg' | inline_asset_content }}
        </span>
      </a>
      <a class="header__icon-link header__icon-link--search" href="{{ routes.search_url }}" aria-label="Search">
        <span class="header__icon-asset" aria-hidden="true">
          {{ 'icon-search.svg' | inline_asset_content }}
        </span>
      </a>

      <a class="header__icon-link header__icon-link--cart" href="{{ routes.cart_url }}" data-header-cart-link aria-label="Cart">
        <sup data-header-cart-count {% if cart.item_count == 0 %}hidden{% endif %}>{{ cart.item_count }}</sup>
        <span class="header__icon-asset" aria-hidden="true">
          {{ 'icon-add-to-cart.svg' | inline_asset_content }}
        </span>
      </a>
    </div>
  </div>
</header>

<div class="header__cart-drawer" data-cart-drawer hidden>
  <div class="header__cart-drawer-backdrop" data-cart-drawer-close></div>
  <aside class="header__cart-drawer-panel" role="dialog" aria-modal="true" aria-label="Cart drawer">
    <div class="header__cart-drawer-header">
      <h3 class="header__cart-drawer-title">Your cart</h3>
      <button type="button" class="header__cart-drawer-close" data-cart-drawer-close aria-label="Close cart">Close</button>
    </div>
    <p class="header__cart-drawer-status" data-cart-drawer-status>Loading cart...</p>
    <ul class="header__cart-drawer-items" data-cart-drawer-items></ul>
    <div class="header__cart-drawer-actions">
      <button type="button" class="header__cart-drawer-action" data-cart-drawer-refresh>Refresh</button>
      <button type="button" class="header__cart-drawer-action" data-cart-drawer-clear>Clear cart</button>
      <a class="header__cart-drawer-action" href="{{ routes.cart_url }}">View cart</a>
      <a class="header__cart-drawer-action" href="/checkout">Checkout</a>
    </div>
  </aside>
</div>

<div class="header__debug-tools" aria-label="Debug controls">
  <button type="button" class="header__debug-button font-caption weight-regular" data-theme-toggle aria-label="Theme">
    Theme
  </button>

  {% if localization.available_languages.size > 1 %}
    <localization-form class="header__debug-localization">
      {% form 'localization', class: 'header__debug-language-form', id: 'HeaderDebugLanguageForm' %}
        <div class="header__debug-language-disclosure">
          <input type="hidden" name="return_to" value="{{ request.path }}">
          <button
            type="button"
            class="header__debug-button header__debug-button--language font-caption weight-regular"
            aria-expanded="false"
            aria-controls="HeaderDebugLanguageList"
          >
            {{ localization.language.iso_code | upcase }}
          </button>

          <ul id="HeaderDebugLanguageList" role="list" class="header__debug-language-list" hidden>
            {% for language in localization.available_languages %}
              <li class="header__debug-language-item" tabindex="-1">
                <a
                  href="#"
                  {% if language.iso_code == localization.language.iso_code %}
                    aria-current="true"
                  {% endif %}
                  hreflang="{{ language.iso_code }}"
                  lang="{{ language.iso_code }}"
                  data-value="{{ language.iso_code }}"
                >
                  {{ language.iso_code | upcase }}
                </a>
              </li>
            {% endfor %}
          </ul>

          <input type="hidden" name="language_code" value="{{ localization.language.iso_code }}">
        </div>
      {% endform %}
    </localization-form>
  {% endif %}
</div>

{% stylesheet %}
  .header {
    --sb-header-height: calc(var(--sb-space-48) + var(--sb-space-12));
    --sb-announcement-min-height: 0px;
    --sb-announcement-row-gap: 6px;
    background-color: var(--sb-color-neutral-200);
    border-bottom: 1px solid var(--sb-color-neutral-600);
    left: 0;
    position: fixed;
    right: 0;
    top: 0;
    transform: translateY(0);
    transition: none;
    z-index: 50;
  }

  .header.has-announcement {
    --sb-announcement-min-height: 42px;
  }

  .header__announcement {
    align-items: center;
    background: var(--sb-announcement-background, var(--sb-gradient-default-1));
    display: flex;
    flex-direction: column;
    gap: var(--sb-announcement-row-gap);
    justify-content: center;
    min-height: var(--sb-announcement-min-height);
    padding: var(--sb-space-8) var(--page-margin, 16px);
    width: 100%;
  }

  .header__announcement-top {
    align-items: center;
    column-gap: var(--sb-space-16);
    display: grid;
    grid-template-columns: minmax(0, 1fr) auto minmax(0, 1fr);
    width: 100%;
  }

  .header__announcement-emoji {
    align-items: center;
    display: inline-flex;
    flex: 0 0 auto;
    height: var(--sb-space-20);
    justify-content: center;
    overflow: hidden;
    width: var(--sb-space-20);
  }

  .header__announcement-emoji:first-child {
    justify-self: end;
  }

  .header__announcement-emoji:last-child {
    justify-self: start;
  }

  .header__announcement-emoji img {
    display: block;
    height: 100%;
    width: 100%;
  }

  .header__announcement-text {
    color: var(--sb-color-always-white);
    margin: 0;
    max-width: 100%;
    min-width: 0;
    text-align: center;
    white-space: normal;
    word-break: break-word;
  }

  .header__announcement-countdown {
    align-items: center;
    display: flex;
    flex-wrap: wrap;
    gap: var(--sb-space-12);
    justify-content: center;
    width: 100%;
  }

  .header__announcement-countdown-group {
    align-items: center;
    color: var(--sb-color-always-white);
    display: inline-flex;
    gap: var(--sb-space-6);
  }

  .header__announcement-countdown-value {
    align-items: center;
    background: var(--sb-color-always-black-25);
    box-sizing: border-box;
    border-radius: 4px;
    display: inline-flex;
    font-variant-numeric: tabular-nums;
    justify-content: center;
    line-height: 1;
    min-width: var(--sb-space-24);
    padding: var(--sb-space-2);
    text-align: center;
    width: var(--sb-space-24);
  }

  .header__announcement-countdown-label {
    color: var(--sb-color-always-white);
    line-height: 1;
  }

  .header.is-hidden {
    transform: translateY(-100%);
  }

  .header__inner {
    align-items: center;
    display: flex;
    height: var(--sb-header-height);
    justify-content: space-between;
    margin-inline: auto;
    max-width: var(--page-width, 1240px);
    position: relative;
    width: min(
      var(--page-width, 1240px),
      calc(100% - (var(--page-margin, 16px) * 2))
    );
  }

  .header a {
    text-decoration: none;
  }

  .header__brand {
    align-items: center;
    color: var(--sb-color-neutral-900);
    display: inline-flex;
    line-height: 0;
  }

  .header__brand:hover,
  .header__brand:focus-visible {
    color: var(--sb-color-primary-500);
  }

  .header__brand-logo {
    display: inline-flex;
    height: var(--sb-space-36);
    width: auto;
  }

  .header__brand-logo svg {
    display: block;
    height: 100%;
    width: auto;
  }

  .header__menu {
    align-items: center;
    display: flex;
    gap: var(--sb-space-24);
    left: 50%;
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    white-space: nowrap;
  }

  .header__menu-item {
    align-items: center;
    display: inline-flex;
  }

  .header__menu-link {
    color: var(--sb-color-neutral-900);
    display: inline-flex;
    min-height: var(--sb-space-36);
    position: relative;
    z-index: 2;
  }

  .header__menu-link:hover,
  .header__menu-link:focus-visible {
    color: var(--sb-color-primary-500);
  }

  .header__menu-link.is-active {
    color: var(--sb-color-primary-500);
  }

  .header__mega-menu {
    left: 50%;
    min-width: calc((var(--sb-space-128) * 4) + var(--sb-space-64) + var(--sb-space-24));
    opacity: 0;
    padding-top: var(--sb-space-16);
    pointer-events: none;
    position: absolute;
    top: 100%;
    transform: translate(-50%, var(--sb-space-12));
    visibility: hidden;
    width: min(
      var(--page-width, 1240px),
      calc(100vw - (var(--page-margin, 16px) * 2))
    );
    z-index: 60;
    transition: opacity 180ms ease, transform 180ms ease, visibility 180ms linear;
  }

  .header__menu-item.has-dropdown:hover > .header__mega-menu,
  .header__menu-item.has-dropdown:focus-within > .header__mega-menu {
    opacity: 1;
    pointer-events: auto;
    transform: translate(-50%, 0);
    visibility: visible;
  }

  .header__mega-menu-panel {
    background: var(--sb-color-neutral-200);
    border-radius: var(--sb-space-24);
    padding: var(--sb-space-36) var(--sb-space-64) var(--sb-space-48);
  }

  .header__mega-menu-grid {
    display: grid;
    gap: var(--sb-space-36);
    grid-template-columns: repeat(4, minmax(0, 1fr));
  }

  .header__mega-card {
    min-width: 0;
  }

  .header__mega-card-media {
    border-radius: var(--sb-space-24);
    box-shadow: 0 0 10px 0 var(--sb-color-always-black-12);
    display: block;
    overflow: hidden;
    position: relative;
  }

  .header__mega-card-image {
    aspect-ratio: 1 / 1;
    display: block;
    height: auto;
    object-fit: cover;
    width: 100%;
  }

  .header__mega-card-image-placeholder {
    align-items: center;
    aspect-ratio: 1 / 1;
    background: var(--sb-color-neutral-300);
    color: var(--sb-color-neutral-900);
    display: flex;
    justify-content: center;
    width: 100%;
  }

  .header__mega-card-badge {
    border-radius: var(--sb-space-12);
    color: var(--sb-color-always-white);
    left: var(--sb-space-16);
    padding: var(--sb-space-8) var(--sb-space-12);
    position: absolute;
    top: var(--sb-space-16);
    z-index: 1;
  }

  .header__mega-card-badge--bestseller {
    background: var(--sb-color-red-500);
  }

  .header__mega-card-badge--new {
    background: var(--sb-color-primary-500);
  }

  .header__mega-card-title {
    color: var(--sb-color-neutral-900);
    display: block;
    margin-top: var(--sb-space-20);
  }

  .header__mega-card-title:hover,
  .header__mega-card-title:focus-visible {
    color: var(--sb-color-primary-500);
  }

  .header__mega-card-body {
    color: var(--sb-color-neutral-900);
    margin: var(--sb-space-12) 0 0;
  }

  .header__mega-card-links {
    display: flex;
    flex-direction: column;
    gap: var(--sb-space-12);
    list-style: none;
    margin: var(--sb-space-20) 0 0;
    padding: 0;
  }

  .header__mega-card-links a {
    color: var(--sb-color-neutral-900);
  }

  .header__mega-card-links a:hover,
  .header__mega-card-links a:focus-visible {
    color: var(--sb-color-primary-500);
  }

  .header__mega-card-app {
    margin-top: var(--sb-space-12);
  }

  .header__mega-card-rating {
    align-items: center;
    color: var(--sb-color-neutral-900);
    display: flex;
    gap: var(--sb-space-8);
    margin: 0;
  }

  .header__mega-card-stars {
    color: var(--sb-color-neutral-900);
    letter-spacing: var(--sb-space-2);
    line-height: 1;
  }

  .header__mega-card-app-links {
    display: flex;
    flex-wrap: wrap;
    gap: var(--sb-space-12);
    margin-top: var(--sb-space-20);
  }

  .header__mega-card-app-links a {
    display: inline-flex;
    line-height: 0;
  }

  .header__mega-card-app-links img {
    display: block;
    height: auto;
    width: calc(var(--sb-space-96) + var(--sb-space-24));
  }

  .header__icons {
    align-items: center;
    display: flex;
    gap: var(--sb-space-24);
    margin-left: auto;
  }

  .header__icons--left {
    display: none;
    margin-left: 0;
  }

  .header__icon-link {
    align-items: center;
    color: var(--sb-color-neutral-900);
    cursor: pointer;
    display: inline-flex;
    justify-content: center;
    line-height: 0;
    position: relative;
    text-decoration: none;
  }

  .header__icon-link:hover,
  .header__icon-link:focus-visible {
    color: var(--sb-color-primary-500);
  }

  .header__icon-asset {
    align-items: center;
    display: inline-flex;
    height: 16px;
    justify-content: center;
    width: 16px;
  }

  .header__icon-asset svg,
  .header__icon-asset img {
    display: block;
    height: 100%;
    width: 100%;
  }

  .header__icon-link--search svg [fill] {
    fill: currentColor;
  }

  .header__icon-link--cart svg [fill] {
    fill: currentColor;
  }

  .header [data-header-cart-link] {
    align-items: center;
    display: inline-flex;
  }

  .header [data-header-cart-link]:hover,
  .header [data-header-cart-link]:focus-visible {
    color: var(--sb-color-primary-500);
  }

  .header a sup {
    color: currentColor;
    left: calc(100% - var(--sb-space-2));
    max-width: var(--page-margin);
    position: absolute;
    overflow: hidden;
    top: calc(var(--sb-space-2) * -1);
  }

  @media screen and (max-width: 989px) {
    .header__inner {
      justify-content: space-between;
    }

    .header__brand {
      left: 50%;
      position: absolute;
      transform: translateX(-50%);
    }

    .header__menu {
      display: none;
    }

    .header__mega-menu {
      display: none;
    }

    .header__icons--left {
      display: flex;
    }

    .header__icons--right .header__icon-link--desktop-only {
      display: none;
    }
  }

  .header .header__cart-drawer-action,
  .header .header__cart-drawer-close {
    align-items: center;
    background: transparent;
    border: 1px solid var(--sb-color-neutral-600);
    border-radius: 999px;
    color: var(--sb-color-neutral-900);
    cursor: pointer;
    display: inline-flex;
    font: inherit;
    min-height: var(--sb-space-36);
    padding: 0 var(--sb-space-12);
  }

  .header__cart-drawer {
    inset: 0;
    position: fixed;
    z-index: 80;
  }

  .header__cart-drawer[hidden] {
    display: none;
  }

  .header__cart-drawer-backdrop {
    background: var(--sb-color-always-black-25);
    inset: 0;
    position: absolute;
  }

  .header__cart-drawer-panel {
    background: var(--sb-color-neutral-100);
    border-left: 1px solid var(--sb-color-neutral-600);
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    gap: var(--sb-space-12);
    height: 100%;
    max-width: 420px;
    padding: var(--sb-space-16);
    position: absolute;
    right: 0;
    top: 0;
    width: min(100%, 420px);
  }

  .header__cart-drawer-header {
    align-items: center;
    display: flex;
    justify-content: space-between;
    gap: var(--sb-space-12);
  }

  .header__cart-drawer-title {
    color: var(--sb-color-neutral-900);
    margin: 0;
  }

  .header__cart-drawer-status {
    color: var(--sb-color-neutral-800);
    margin: 0;
  }

  .header__cart-drawer-items {
    display: flex;
    flex-direction: column;
    gap: var(--sb-space-8);
    list-style: none;
    margin: 0;
    min-height: 0;
    overflow: auto;
    padding: 0;
    flex: 1 1 auto;
  }

  .header__cart-drawer-item {
    border-bottom: 1px solid var(--sb-color-neutral-600);
    display: flex;
    justify-content: space-between;
    gap: var(--sb-space-12);
    padding: var(--sb-space-8) 0;
  }

  .header__cart-drawer-item-info {
    display: flex;
    flex-direction: column;
    gap: var(--sb-space-4);
    min-width: 0;
  }

  .header__cart-drawer-item-title {
    color: var(--sb-color-neutral-900);
    margin: 0;
  }

  .header__cart-drawer-item-variant,
  .header__cart-drawer-item-price {
    color: var(--sb-color-neutral-800);
    margin: 0;
  }

  .header__cart-drawer-item-qty {
    color: var(--sb-color-neutral-900);
    white-space: nowrap;
  }

  .header__cart-drawer-actions {
    display: flex;
    flex-wrap: wrap;
    gap: var(--sb-space-8);
  }

  .header__cart-drawer-action {
    text-decoration: none;
  }

  .shopify-section:has(> .header) {
    min-height: calc(var(--sb-header-height) + var(--sb-announcement-min-height, 0px));
  }

  .header__debug-tools {
    align-items: center;
    background: var(--sb-color-neutral-100);
    border: 1px solid var(--sb-color-neutral-600);
    border-radius: 999px;
    bottom: var(--sb-space-8);
    display: inline-flex;
    gap: var(--sb-space-4);
    padding: var(--sb-space-2);
    position: fixed;
    right: var(--sb-space-8);
    z-index: 95;
  }

  .header__debug-button {
    align-items: center;
    background: transparent;
    border: 0;
    border-radius: 999px;
    color: var(--sb-color-neutral-800);
    cursor: pointer;
    display: inline-flex;
    height: var(--sb-space-24);
    justify-content: center;
    line-height: 1;
    padding-inline: var(--sb-space-8);
    white-space: nowrap;
  }

  .header__debug-button:hover,
  .header__debug-button:focus-visible {
    color: var(--sb-color-primary-500);
  }

  .header__debug-button[disabled] {
    cursor: default;
    opacity: 0.75;
  }

  .header__debug-localization,
  .header__debug-language-form {
    margin: 0;
  }

  .header__debug-language-disclosure {
    position: relative;
  }

  .header__debug-language-list {
    background: var(--sb-color-neutral-100);
    border: 1px solid var(--sb-color-neutral-600);
    border-radius: var(--sb-space-12);
    bottom: calc(100% + var(--sb-space-4));
    display: flex;
    flex-direction: column;
    gap: var(--sb-space-2);
    list-style: none;
    margin: 0;
    min-width: var(--sb-space-96);
    padding: var(--sb-space-4);
    position: absolute;
    right: 0;
    z-index: 96;
  }

  .header__debug-language-item a {
    border-radius: 999px;
    color: var(--sb-color-neutral-800);
    display: block;
    line-height: 1;
    padding: var(--sb-space-6) var(--sb-space-8);
    text-align: center;
    text-decoration: none;
  }

  .header__debug-language-item a:hover,
  .header__debug-language-item a:focus-visible {
    color: var(--sb-color-primary-500);
  }
{% endstylesheet %}

<script>
  (() => {
    const header = document.querySelector('.header');
    if (!header || header.dataset.headerInit === 'true') return;
    header.dataset.headerInit = 'true';

    const countdownRoot = header.querySelector('[data-announcement-countdown]');
    if (countdownRoot) {
      const endDateValue = countdownRoot.getAttribute('data-sale-end-date') || '';
      const endTimestamp = Date.parse(endDateValue);
      const daysValue = countdownRoot.querySelector('[data-countdown-days]');
      const hoursValue = countdownRoot.querySelector('[data-countdown-hours]');
      const minsValue = countdownRoot.querySelector('[data-countdown-mins]');
      const secsValue = countdownRoot.querySelector('[data-countdown-secs]');

      if (!Number.isFinite(endTimestamp) || !daysValue || !hoursValue || !minsValue || !secsValue) {
        countdownRoot.setAttribute('hidden', '');
      } else {
        const formatCountdownValue = (value) => `${Math.min(99, Math.max(0, value))}`.padStart(2, '0');
        let countdownTimer = null;

        const updateCountdown = () => {
          const remainingSeconds = Math.max(0, Math.floor((endTimestamp - Date.now()) / 1000));
          const days = Math.floor(remainingSeconds / 86400);
          const hours = Math.floor((remainingSeconds % 86400) / 3600);
          const mins = Math.floor((remainingSeconds % 3600) / 60);
          const secs = remainingSeconds % 60;

          daysValue.textContent = formatCountdownValue(days);
          hoursValue.textContent = formatCountdownValue(hours);
          minsValue.textContent = formatCountdownValue(mins);
          secsValue.textContent = formatCountdownValue(secs);

          if (remainingSeconds <= 0 && countdownTimer) {
            window.clearInterval(countdownTimer);
            countdownTimer = null;
          }
        };

        updateCountdown();
        countdownTimer = window.setInterval(updateCountdown, 1000);
      }
    }

    const getWindowY = () => window.scrollY || window.pageYOffset || document.documentElement.scrollTop || 0;
    let lastY = getWindowY();
    const topThreshold = 8;
    const revealAfterUpDistance = 18;
    let upwardTravel = 0;
    let hiddenOffset = 0;
    let topExitMode = lastY <= topThreshold;

    const clamp = (value, min, max) => Math.min(max, Math.max(min, value));
    const headerHeight = () => header.getBoundingClientRect().height || 0;
    const headerSection = header.closest('.shopify-section');
    const syncHeaderSectionMinHeight = () => {
      if (!headerSection) return;
      headerSection.style.minHeight = `${headerHeight()}px`;
    };
    const applyOffset = () => {
      header.style.transform = `translateY(${-hiddenOffset}px)`;
    };
    const captureHeaderState = () => ({
      hiddenOffset,
      topExitMode,
      upwardTravel
    });
    const restoreHeaderState = (state) => {
      if (!state || typeof state !== 'object') return;
      const nextOffset = Number.parseFloat(`${state.hiddenOffset}`);
      hiddenOffset = clamp(Number.isFinite(nextOffset) ? nextOffset : 0, 0, headerHeight());
      topExitMode = typeof state.topExitMode === 'boolean'
        ? state.topExitMode
        : hiddenOffset < headerHeight();
      upwardTravel = 0;
      applyOffset();
      lastY = getWindowY();
    };

    window.SBHeaderNav = {
      ...(window.SBHeaderNav || {}),
      captureState: captureHeaderState,
      restoreState: restoreHeaderState
    };

    const sync = (currentY, { force = false } = {}) => {
      const delta = currentY - lastY;
      const maxOffset = headerHeight();

      if (force || currentY <= topThreshold) {
        hiddenOffset = 0;
        upwardTravel = 0;
        topExitMode = true;
        applyOffset();
        lastY = currentY;
        return;
      }

      if (delta > 0) {
        upwardTravel = 0;
        if (topExitMode) {
          // Only when leaving the top, follow page scroll.
          hiddenOffset = clamp(currentY, 0, maxOffset);
          if (hiddenOffset >= maxOffset - 0.5 || currentY > maxOffset) topExitMode = false;
        } else {
          // Everywhere else, hide instantly on downward scroll.
          hiddenOffset = maxOffset;
        }
        applyOffset();
      } else if (delta < 0) {
        upwardTravel += Math.abs(delta);
        if (upwardTravel >= revealAfterUpDistance) {
          hiddenOffset = 0;
          upwardTravel = 0;
          applyOffset();
        }
      }

      lastY = currentY;
    };

    const onWindowScroll = () => {
      sync(getWindowY());
    };

    window.addEventListener('scroll', onWindowScroll, { passive: true });
    window.addEventListener(
      'resize',
      () => {
        sync(getWindowY(), { force: true });
        syncHeaderSectionMinHeight();
      },
      { passive: true }
    );
    window.requestAnimationFrame(() => {
      sync(getWindowY(), { force: true });
      syncHeaderSectionMinHeight();
    });
    window.setTimeout(syncHeaderSectionMinHeight, 300);

    const root = document.documentElement;
    const toggle = document.querySelector('[data-theme-toggle]');
    const lockedTheme = root.getAttribute('data-theme-locked');

    const STORAGE_KEY = 'sb-theme-mode';
    const formatThemeLabel = (theme) => (theme === 'light' ? 'Light' : 'Dark');

    const applyTheme = (theme) => {
      if (theme !== 'dark' && theme !== 'light') return;
      root.setAttribute('data-theme', theme);
      if (!toggle) return;
      toggle.setAttribute('data-theme-current', theme);
      const themeLabel = formatThemeLabel(theme);
      toggle.textContent = themeLabel;
      toggle.setAttribute('aria-label', `Theme: ${themeLabel}`);
      toggle.disabled = lockedTheme === 'light' || lockedTheme === 'dark';
    };

    if (toggle) {
      if (lockedTheme === 'light' || lockedTheme === 'dark') {
        applyTheme(lockedTheme);
      } else {
        const storedTheme = localStorage.getItem(STORAGE_KEY);
        if (storedTheme === 'dark' || storedTheme === 'light') applyTheme(storedTheme);
        else applyTheme(root.getAttribute('data-theme') === 'light' ? 'light' : 'dark');
      }

      toggle.addEventListener('click', () => {
        if (lockedTheme === 'light' || lockedTheme === 'dark') return;
        const current = root.getAttribute('data-theme') || 'dark';
        const next = current === 'dark' ? 'light' : 'dark';
        applyTheme(next);
        localStorage.setItem(STORAGE_KEY, next);
      });
    }

    if (!customElements.get('localization-form')) {
      class LocalizationForm extends HTMLElement {
        constructor() {
          super();
          this.elements = {
            input: this.querySelector('input[name="language_code"], input[name="country_code"]'),
            button: this.querySelector('button'),
            panel: this.querySelector('ul')
          };

          if (!this.elements.button || !this.elements.panel || !this.elements.input) return;

          this.elements.button.addEventListener('click', this.openSelector.bind(this));
          this.elements.button.addEventListener('focusout', this.closeSelector.bind(this));
          this.addEventListener('keyup', this.onContainerKeyUp.bind(this));
          this.querySelectorAll('a').forEach((item) => item.addEventListener('click', this.onItemClick.bind(this)));
        }

        hidePanel() {
          this.elements.button.setAttribute('aria-expanded', 'false');
          this.elements.panel.setAttribute('hidden', true);
        }

        onContainerKeyUp(event) {
          if (event.code.toUpperCase() !== 'ESCAPE') return;
          this.hidePanel();
          this.elements.button.focus();
        }

        onItemClick(event) {
          event.preventDefault();
          const form = this.querySelector('form');
          this.elements.input.value = event.currentTarget.dataset.value;
          if (form) form.submit();
        }

        openSelector() {
          this.elements.button.focus();
          this.elements.panel.toggleAttribute('hidden');
          this.elements.button.setAttribute(
            'aria-expanded',
            (this.elements.button.getAttribute('aria-expanded') === 'false').toString()
          );
        }

        closeSelector(event) {
          const shouldClose = event.relatedTarget && event.relatedTarget.nodeName === 'BUTTON';
          if (event.relatedTarget === null || shouldClose) {
            this.hidePanel();
          }
        }
      }

      customElements.define('localization-form', LocalizationForm);
    }

    const cartDrawer = document.querySelector('[data-cart-drawer]');
    const cartDrawerStatus = document.querySelector('[data-cart-drawer-status]');
    const cartDrawerItems = document.querySelector('[data-cart-drawer-items]');
    const cartDrawerRefresh = document.querySelector('[data-cart-drawer-refresh]');
    const cartDrawerClear = document.querySelector('[data-cart-drawer-clear]');
    const cartDrawerCloseButtons = document.querySelectorAll('[data-cart-drawer-close]');
    const headerCartLink = header.querySelector('[data-header-cart-link]');
    const headerCartCount = header.querySelector('[data-header-cart-count]');
    const shopRoot = (() => {
      const root = window.Shopify && window.Shopify.routes && typeof window.Shopify.routes.root === 'string'
        ? window.Shopify.routes.root
        : '/';
      return root.endsWith('/') ? root : `${root}/`;
    })();
    const cartUrl = (path) => `${shopRoot}${path}`;

    const setCartCount = (count) => {
      if (!headerCartCount) return;
      headerCartCount.textContent = `${count}`;
      headerCartCount.hidden = count <= 0;
    };

    const formatMoney = (cents, currency = 'USD') => {
      const normalizedCents = Number.isFinite(Number(cents)) ? Number(cents) : 0;
      try {
        return new Intl.NumberFormat(undefined, { style: 'currency', currency }).format(normalizedCents / 100);
      } catch (_) {
        return `${(normalizedCents / 100).toFixed(2)} ${currency}`;
      }
    };

    const renderCartItems = (cart) => {
      if (!cartDrawerItems || !cartDrawerStatus) return;
      cartDrawerItems.innerHTML = '';
      setCartCount(cart.item_count || 0);

      if (!cart.items || cart.items.length === 0) {
        cartDrawerStatus.textContent = 'Cart is empty.';
        return;
      }

      cartDrawerStatus.textContent = `${cart.item_count} item${cart.item_count === 1 ? '' : 's'} in cart`;
      cart.items.forEach((item) => {
        const row = document.createElement('li');
        row.className = 'header__cart-drawer-item';
        const variantTitle = item.variant_title && item.variant_title !== 'Default Title' ? item.variant_title : '';
        row.innerHTML = `
          <div class="header__cart-drawer-item-info">
            <p class="header__cart-drawer-item-title">${item.product_title}</p>
            ${variantTitle ? `<p class="header__cart-drawer-item-variant">${variantTitle}</p>` : ''}
            <p class="header__cart-drawer-item-price">${formatMoney(item.final_line_price, cart.currency || 'USD')}</p>
          </div>
          <span class="header__cart-drawer-item-qty">x${item.quantity}</span>
        `;
        cartDrawerItems.appendChild(row);
      });
    };

    const fetchCart = async () => {
      const response = await fetch(cartUrl('cart.js'), {
        method: 'GET',
        headers: { Accept: 'application/json' }
      });
      if (!response.ok) throw new Error('Cart fetch failed');
      return response.json();
    };

    const openCartDrawer = () => {
      if (!cartDrawer) return;
      cartDrawer.removeAttribute('hidden');
      document.documentElement.style.overflow = 'hidden';
    };

    const closeCartDrawer = () => {
      if (!cartDrawer) return;
      cartDrawer.setAttribute('hidden', '');
      document.documentElement.style.overflow = '';
    };

    const refreshCartDrawer = async () => {
      if (!cartDrawerStatus) return;
      cartDrawerStatus.textContent = 'Loading cart...';
      try {
        const cart = await fetchCart();
        renderCartItems(cart);
        return cart;
      } catch (error) {
        cartDrawerStatus.textContent = 'Unable to load cart.';
        throw error;
      }
    };

    const dispatchCartChanged = (cart, source = 'unknown', itemCount = 0) => {
      const detail = { cart, source, itemCount };
      document.dispatchEvent(new CustomEvent('sb:cart:changed', { detail }));
      document.dispatchEvent(new CustomEvent('cart:updated', { detail }));
      document.dispatchEvent(
        new CustomEvent('cart:update', {
          bubbles: true,
          detail: {
            resource: cart,
            sourceId: 'header-cart',
            data: {
              source,
              itemCount
            }
          }
        })
      );
    };

    const clearCart = async () => {
      if (cartDrawerStatus) cartDrawerStatus.textContent = 'Clearing cart...';
      const response = await fetch(cartUrl('cart/clear.js'), {
        method: 'POST',
        headers: { Accept: 'application/json' }
      });
      if (!response.ok) throw new Error('Cart clear failed');
      const cart = await fetchCart();
      renderCartItems(cart);
      dispatchCartChanged(cart, 'clear');
      return cart;
    };

    const animateFlyToCart = ({ sourceElement, imageSrc }) => {
      if (!sourceElement || !headerCartLink || !imageSrc) return;
      const sourceRect = sourceElement.getBoundingClientRect();
      const targetRect = headerCartLink.getBoundingClientRect();
      if (!sourceRect.width || !sourceRect.height || !targetRect.width || !targetRect.height) return;

      const fly = document.createElement('img');
      fly.src = imageSrc;
      fly.alt = '';
      fly.setAttribute('aria-hidden', 'true');
      fly.style.position = 'fixed';
      fly.style.left = `${sourceRect.left + sourceRect.width / 2 - 24}px`;
      fly.style.top = `${sourceRect.top + sourceRect.height / 2 - 24}px`;
      fly.style.width = `${Math.max(48, Math.min(96, sourceRect.width * 0.35))}px`;
      fly.style.height = fly.style.width;
      fly.style.borderRadius = '999px';
      fly.style.objectFit = 'cover';
      fly.style.pointerEvents = 'none';
      fly.style.zIndex = '120';
      fly.style.boxShadow = '0 0 24px 0 var(--sb-color-always-black-25)';
      document.body.appendChild(fly);

      const deltaX = targetRect.left + targetRect.width / 2 - (sourceRect.left + sourceRect.width / 2);
      const deltaY = targetRect.top + targetRect.height / 2 - (sourceRect.top + sourceRect.height / 2);
      const animation = fly.animate(
        [
          { transform: 'translate3d(0, 0, 0) scale(1)', opacity: 1 },
          { transform: `translate3d(${deltaX}px, ${deltaY}px, 0) scale(0.2)`, opacity: 0.2 }
        ],
        { duration: 420, easing: 'cubic-bezier(.2,.8,.2,1)', fill: 'forwards' }
      );
      animation.addEventListener('finish', () => fly.remove(), { once: true });
      animation.addEventListener('cancel', () => fly.remove(), { once: true });
    };

    const addToCart = async (variantId, { quantity = 1, sourceElement = null, imageSrc = '' } = {}) => {
      const variantIdValue = `${variantId}`.trim();
      const parsedQuantity = Number.parseInt(`${quantity}`, 10);
      if (!variantIdValue) throw new Error('Invalid variant id');
      if (!Number.isFinite(parsedQuantity) || parsedQuantity <= 0) throw new Error('Invalid quantity');

      const formData = new FormData();
      formData.append('id', variantIdValue);
      formData.append('quantity', `${parsedQuantity}`);

      const response = await fetch(cartUrl('cart/add.js'), {
        method: 'POST',
        headers: {
          Accept: 'application/json'
        },
        credentials: 'same-origin',
        body: formData
      });
      if (!response.ok) {
        const errorBody = await response.text();
        throw new Error(`Add to cart failed: ${errorBody || response.status}`);
      }
      const cart = await fetchCart();
      renderCartItems(cart);
      dispatchCartChanged(cart, 'add', parsedQuantity);
      animateFlyToCart({ sourceElement, imageSrc });
      openCartDrawer();
      return cart;
    };

    window.SBCart = {
      ...(window.SBCart || {}),
      fetch: fetchCart,
      refresh: refreshCartDrawer,
      open: openCartDrawer,
      close: closeCartDrawer,
      clear: clearCart,
      add: addToCart
    };

    if (headerCartLink) {
      headerCartLink.addEventListener('click', (event) => {
        event.preventDefault();
        openCartDrawer();
        refreshCartDrawer();
      });
    }

    cartDrawerCloseButtons.forEach((button) => {
      button.addEventListener('click', () => closeCartDrawer());
    });

    if (cartDrawerRefresh) {
      cartDrawerRefresh.addEventListener('click', () => {
        refreshCartDrawer();
      });
    }

    if (cartDrawerClear) {
      cartDrawerClear.addEventListener('click', async () => {
        try {
          await clearCart();
        } catch (error) {
          if (cartDrawerStatus) cartDrawerStatus.textContent = 'Unable to clear cart.';
        }
      });
    }

    document.addEventListener('keydown', (event) => {
      if (event.key !== 'Escape') return;
      if (!cartDrawer || cartDrawer.hasAttribute('hidden')) return;
      closeCartDrawer();
    });

    document.addEventListener('sb:cart:changed', (event) => {
      const cart = event.detail && event.detail.cart;
      if (cart) {
        renderCartItems(cart);
        return;
      }
      refreshCartDrawer();
    });

    document.addEventListener('cart:update', (event) => {
      const cart = event.detail && event.detail.resource;
      if (cart) {
        renderCartItems(cart);
        const source = event.detail && event.detail.data && event.detail.data.source;
        if (source && source !== 'header-cart') {
          openCartDrawer();
        }
        return;
      }
      refreshCartDrawer();
    });

    refreshCartDrawer();
  })();
</script>

{% schema %}
{
  "name": "t:general.header",
  "settings": [
    {
      "type": "link_list",
      "id": "menu",
      "label": "t:labels.menu"
    }
  ],
  "blocks": [
    {
      "type": "mega_menu_group",
      "name": "Mega menu group",
      "settings": [
        {
          "type": "text",
          "id": "menu_item_handle",
          "label": "Menu item handle",
          "default": "in-ear-monitors",
          "info": "Match this to the top-level menu item title handle."
        }
      ]
    },
    {
      "type": "mega_menu_card",
      "name": "Mega menu card",
      "settings": [
        {
          "type": "text",
          "id": "menu_item_handle",
          "label": "Menu item handle",
          "default": "in-ear-monitors",
          "info": "Match this to the top-level menu item title handle."
        },
        {
          "type": "select",
          "id": "card_mode",
          "label": "Card mode",
          "default": "standard",
          "options": [
            {
              "value": "standard",
              "label": "Standard"
            },
            {
              "value": "app",
              "label": "App"
            }
          ]
        },
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "collection",
          "id": "collection",
          "label": "Collection"
        },
        {
          "type": "page",
          "id": "page",
          "label": "Page"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image",
          "info": "Target minimum 584x584 at 1x export (584x584)."
        },
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Wave in-ear monitors"
        },
        {
          "type": "textarea",
          "id": "body",
          "label": "Description",
          "default": "Placeholder card. Replace this content in Header settings."
        },
        {
          "type": "url",
          "id": "card_link",
          "label": "Card link"
        },
        {
          "type": "link_list",
          "id": "submenu",
          "label": "Submenu links"
        },
        {
          "type": "text",
          "id": "app_rating_label",
          "label": "App rating label",
          "default": "4.8 stars on app stores"
        },
        {
          "type": "url",
          "id": "app_store_url",
          "label": "App Store link"
        },
        {
          "type": "url",
          "id": "google_play_url",
          "label": "Google Play link"
        }
      ]
    }
  ],
  "max_blocks": 32,
  "presets": [
    {
      "name": "t:general.header",
      "blocks": [
        {
          "type": "mega_menu_group",
          "settings": {
            "menu_item_handle": "in-ear-monitors"
          }
        },
        {
          "type": "mega_menu_card",
          "settings": {
            "menu_item_handle": "in-ear-monitors",
            "title": "Wave in-ear monitors",
            "body": "Placeholder card. Replace this content in Header settings."
          }
        }
      ]
    }
  ]
}
{% endschema %}
