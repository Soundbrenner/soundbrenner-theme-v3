<section class="sb-manual-chapters" id="sb-manual-{{ section.id }}">
  <aside class="sb-manual-chapters__sidebar" data-sb-reveal>
    <nav class="sb-manual-chapters__nav" aria-label="Manual chapters">
      {% assign first_chapter_link = true %}
      {% for block in section.blocks %}
        {% if block.type == 'heading' %}
          {% assign raw_anchor = block.settings.heading | append: '-' | append: block.id %}
          {% assign chapter_id = raw_anchor | handleize %}
          <a
            class="sb-manual-chapters__nav-link font-caption weight-semibold{% if first_chapter_link %} is-active{% endif %}"
            href="#{{ chapter_id }}"
            data-sb-reveal-item
            data-manual-link
            data-target="{{ chapter_id }}"
          >
            {{ block.settings.heading | default: 'Chapter' }}
          </a>
          {% assign first_chapter_link = false %}
        {% endif %}
      {% endfor %}
    </nav>
  </aside>

  <div class="sb-manual-chapters__mobile-nav" data-sb-reveal>
    <details class="sb-manual-chapters__mobile-details">
      <summary class="sb-manual-chapters__mobile-trigger font-caption weight-semibold" data-sb-reveal-item>Browse chapters</summary>
      <div class="sb-manual-chapters__mobile-list" role="list">
        {% assign first_mobile_chapter_link = true %}
        {% for block in section.blocks %}
          {% if block.type == 'heading' %}
            {% assign raw_anchor = block.settings.heading | append: '-' | append: block.id %}
            {% assign chapter_id = raw_anchor | handleize %}
            <a
              class="sb-manual-chapters__mobile-link font-caption weight-semibold{% if first_mobile_chapter_link %} is-active{% endif %}"
              href="#{{ chapter_id }}"
              data-sb-reveal-item
              data-manual-link
              data-target="{{ chapter_id }}"
            >
              {{ block.settings.heading | default: 'Chapter' }}
            </a>
            {% assign first_mobile_chapter_link = false %}
          {% endif %}
        {% endfor %}
      </div>
    </details>
  </div>

  <div class="sb-manual-chapters__content">
    {% for block in section.blocks %}
      {% if block.type == 'heading' %}
        {% assign raw_anchor = block.settings.heading | append: '-' | append: block.id %}
        {% assign chapter_id = raw_anchor | handleize %}
        <article id="{{ chapter_id }}" class="sb-manual-chapters__chapter" data-sb-reveal {{ block.shopify_attributes }}>
          <h2 class="sb-manual-chapters__heading font-title weight-bold" data-sb-reveal-item>{{ block.settings.heading }}</h2>
        </article>
      {% elsif block.type == 'text' %}
        <div class="sb-manual-chapters__body font-body weight-regular rte" data-sb-reveal {{ block.shopify_attributes }}>
          <div data-sb-reveal-item>
            {{ block.settings.text }}
          </div>
        </div>
      {% elsif block.type == 'subheading' %}
        <h3 class="sb-manual-chapters__heading-medium font-callout weight-bold" data-sb-reveal {{ block.shopify_attributes }}>
          <span data-sb-reveal-item>{{ block.settings.heading }}</span>
        </h3>
      {% elsif block.type == 'heading_small' %}
        <h4 class="sb-manual-chapters__heading-small font-body weight-bold" data-sb-reveal {{ block.shopify_attributes }}>
          <span data-sb-reveal-item>{{ block.settings.heading }}</span>
        </h4>
      {% elsif block.type == 'image' %}
        <figure class="sb-manual-chapters__media" data-sb-reveal {{ block.shopify_attributes }}>
          {% if block.settings.image != blank %}
            {{
              block.settings.image
              | image_url: width: 2400
              | image_tag:
                loading: 'lazy',
                class: 'sb-manual-chapters__media-file',
                alt: block.settings.image.alt
            }}
          {% else %}
            <img
              src="{{ 'manual-chapter-placeholder.jpg' | asset_url }}"
              alt=""
              loading="lazy"
              class="sb-manual-chapters__media-file"
              width="1824"
              height="1026"
            >
          {% endif %}
        </figure>
      {% elsif block.type == 'button' %}
        <div class="sb-manual-chapters__button-wrap" data-sb-reveal {{ block.shopify_attributes }}>
          {% if block.settings.link != blank %}
            <a
              class="sb-button-radiant sb-button-radiant--large sb-button-large-radiant"
              href="{{ block.settings.link }}"
              data-sb-reveal-item
            >
              <span class="sb-button-radiant__label">{{ block.settings.label | default: 'Placeholder' }}</span>
            </a>
          {% else %}
            <button
              type="button"
              class="sb-button-radiant sb-button-radiant--large sb-button-large-radiant"
              data-sb-reveal-item
            >
              <span class="sb-button-radiant__label">{{ block.settings.label | default: 'Placeholder' }}</span>
            </button>
          {% endif %}
        </div>
      {% elsif block.type == 'vimeo_video' %}
        <figure
          class="sb-manual-chapters__video"
          data-sb-reveal
          data-manual-vimeo
          data-vimeo-source="{{ block.settings.video_source | escape }}"
          {{ block.shopify_attributes }}
        >
          <iframe
            title="Vimeo video"
            loading="lazy"
            allow="autoplay; fullscreen; picture-in-picture; clipboard-write; encrypted-media; web-share"
            allowfullscreen
            referrerpolicy="strict-origin-when-cross-origin"
            data-manual-vimeo-frame
          ></iframe>
        </figure>
      {% elsif block.type == 'faq_item' %}
        <article class="sb-manual-chapters__faq" data-sb-reveal {{ block.shopify_attributes }}>
          <button
            type="button"
            class="sb-manual-chapters__faq-trigger"
            aria-expanded="false"
            data-manual-faq-trigger
            data-sb-reveal-item
          >
            <span class="sb-manual-chapters__faq-question font-body weight-bold">{{ block.settings.question }}</span>
            <span class="sb-manual-chapters__faq-icon" aria-hidden="true">
              <span class="sb-manual-chapters__faq-icon-plus">{{ 'icon-faq-add.svg' | inline_asset_content }}</span>
              <span class="sb-manual-chapters__faq-icon-close">{{ 'icon-faq-close.svg' | inline_asset_content }}</span>
            </span>
          </button>
          <div class="sb-manual-chapters__faq-answer font-body weight-regular rte" data-manual-faq-answer data-sb-reveal-item>
            {{ block.settings.answer }}
          </div>
          <hr class="sb-manual-chapters__faq-divider" data-sb-reveal-item>
        </article>
      {% elsif block.type == 'divider' %}
        <div data-sb-reveal>
          <hr class="sb-manual-chapters__divider" data-sb-reveal-item {{ block.shopify_attributes }}>
        </div>
      {% endif %}
    {% endfor %}
  </div>
</section>

{% stylesheet %}
  .sb-manual-chapters {
    display: grid;
    gap: var(--sb-space-48);
    grid-template-columns: 280px minmax(0, 1fr);
  }

  .sb-manual-chapters__sidebar {
    align-self: start;
    position: sticky;
    top: var(--sb-space-96);
    width: 280px;
  }

  .sb-manual-chapters__nav {
    display: flex;
    flex-direction: column;
    gap: var(--sb-space-12);
  }

  .sb-manual-chapters__nav-link {
    background: var(--sb-color-neutral-200);
    border-radius: var(--sb-radius-pill);
    color: var(--sb-color-neutral-900);
    padding: var(--sb-space-16) var(--sb-space-20);
    text-decoration: none;
  }

  .sb-manual-chapters__nav-link.is-active {
    background: var(--sb-color-primary-500);
  }

  .sb-manual-chapters__nav-link:not(.is-active):hover,
  .sb-manual-chapters__nav-link:not(.is-active):focus-visible {
    background: var(--sb-color-neutral-300);
  }

  .sb-manual-chapters__content {
    display: flex;
    flex-direction: column;
    gap: var(--sb-space-24);
    min-width: 0;
  }

  .sb-manual-chapters__chapter {
    scroll-margin-top: var(--sb-space-64);
  }

  .sb-manual-chapters__media {
    margin: 0;
    overflow: hidden;
    border-radius: 24px;
    width: 100%;
  }

  .sb-manual-chapters__media-file {
    display: block;
    height: auto;
    width: 100%;
  }

  .sb-manual-chapters__divider {
    background: var(--sb-color-neutral-600);
    border: 0;
    height: 1px;
    margin: var(--sb-space-24) 0;
    width: 100%;
  }

  .sb-manual-chapters__button-wrap {
    width: fit-content;
  }

  .sb-manual-chapters__video {
    margin: 0;
    max-width: min(100%, 400px);
    width: 100%;
  }

  .sb-manual-chapters__video iframe {
    border: 0;
    border-radius: 0;
    display: block;
    height: auto;
    width: 100%;
  }

  .sb-manual-chapters__faq {
    width: 100%;
  }

  .sb-manual-chapters__faq-trigger {
    align-items: center;
    background: transparent;
    border: 0;
    color: var(--sb-color-neutral-900);
    cursor: pointer;
    display: flex;
    gap: var(--sb-space-16);
    justify-content: space-between;
    padding: 0;
    text-align: left;
    width: 100%;
  }

  .sb-manual-chapters__faq-question {
    color: var(--sb-color-neutral-900);
    margin: 0;
  }

  .sb-manual-chapters__faq-icon {
    color: var(--sb-color-primary-500);
    display: inline-flex;
    flex: 0 0 auto;
    height: var(--sb-space-20);
    line-height: 0;
    position: relative;
    width: var(--sb-space-20);
  }

  .sb-manual-chapters__faq-icon svg {
    display: block;
    height: var(--sb-space-20);
    width: var(--sb-space-20);
  }

  .sb-manual-chapters__faq-icon svg path:not([fill='none']),
  .sb-manual-chapters__faq-icon svg circle:not([fill='none']),
  .sb-manual-chapters__faq-icon svg rect:not([fill='none']) {
    fill: currentColor !important;
  }

  .sb-manual-chapters__faq-icon svg path:not([stroke='none']),
  .sb-manual-chapters__faq-icon svg circle:not([stroke='none']),
  .sb-manual-chapters__faq-icon svg rect:not([stroke='none']) {
    stroke: currentColor !important;
  }

  .sb-manual-chapters__faq-icon-plus,
  .sb-manual-chapters__faq-icon-close {
    display: inline-flex;
    inset: 0;
    position: absolute;
    transition:
      opacity 220ms ease,
      transform 260ms cubic-bezier(0.22, 1, 0.36, 1);
  }

  .sb-manual-chapters__faq-answer {
    color: var(--sb-color-neutral-800);
    display: none;
    margin-top: var(--sb-space-24);
  }

  .sb-manual-chapters__faq.is-open .sb-manual-chapters__faq-answer {
    display: block;
  }

  .sb-manual-chapters__faq-icon-plus {
    opacity: 1;
    transform: rotate(0deg) scale(1);
  }

  .sb-manual-chapters__faq-icon-close {
    opacity: 0;
    transform: rotate(-90deg) scale(0.85);
  }

  .sb-manual-chapters__faq.is-open .sb-manual-chapters__faq-icon-plus {
    opacity: 0;
    transform: rotate(90deg) scale(0.85);
  }

  .sb-manual-chapters__faq.is-open .sb-manual-chapters__faq-icon-close {
    opacity: 1;
    transform: rotate(0deg) scale(1);
  }

  .sb-manual-chapters__faq-divider {
    background: var(--sb-color-neutral-600);
    border: 0;
    height: 1px;
    margin: var(--sb-space-24) 0 0;
    width: 100%;
  }

  .sb-manual-chapters__heading {
    color: var(--sb-color-neutral-900);
    margin: 0;
  }

  .sb-manual-chapters__heading-medium {
    color: var(--sb-color-neutral-900);
    margin: 0;
  }

  .sb-manual-chapters__heading-small {
    color: var(--sb-color-neutral-900);
    margin: 0;
  }

  .sb-manual-chapters__body {
    color: var(--sb-color-neutral-800);
  }

  .sb-manual-chapters__body [data-sb-reveal-item] > *,
  .sb-manual-chapters__faq-answer > * {
    margin: 0;
  }

  .sb-manual-chapters__body [data-sb-reveal-item] > * + *,
  .sb-manual-chapters__faq-answer > * + * {
    margin-top: var(--sb-space-24);
  }

  .sb-manual-chapters__mobile-nav {
    display: none;
  }

  @media (max-width: 749px) {
    .sb-manual-chapters {
      display: flex;
      flex-direction: column;
      gap: var(--sb-space-24);
    }

    .sb-manual-chapters__sidebar {
      display: none;
    }

    .sb-manual-chapters__content {
      display: flex;
      flex-direction: column;
      gap: var(--sb-space-24);
    }

    .sb-manual-chapters__mobile-nav {
      display: none;
    }

    .sb-manual-chapters__mobile-details {
      position: relative;
    }

    .sb-manual-chapters__mobile-trigger {
      align-items: center;
      background: var(--sb-color-neutral-200);
      border-radius: var(--sb-radius-pill);
      color: var(--sb-color-neutral-900);
      cursor: pointer;
      display: flex;
      justify-content: center;
      list-style: none;
      padding: var(--sb-space-16) var(--sb-space-20);
      text-align: center;
    }

    .sb-manual-chapters__mobile-trigger::-webkit-details-marker {
      display: none;
    }

    .sb-manual-chapters__mobile-list {
      background: var(--sb-color-neutral-200);
      border-radius: var(--sb-radius-card);
      display: flex;
      flex-direction: column;
      gap: var(--sb-space-12);
      left: 0;
      max-height: 60svh;
      overflow: auto;
      padding: var(--sb-space-12);
      position: absolute;
      right: 0;
      top: calc(100% + var(--sb-space-12));
    }

    .sb-manual-chapters__mobile-link {
      background: var(--sb-color-neutral-200);
      border-radius: var(--sb-radius-pill);
      color: var(--sb-color-neutral-900);
      padding: var(--sb-space-16) var(--sb-space-20);
      text-decoration: none;
    }

    .sb-manual-chapters__mobile-link.is-active {
      background: var(--sb-color-primary-500);
    }

    .sb-manual-chapters__mobile-link:not(.is-active):hover,
    .sb-manual-chapters__mobile-link:not(.is-active):focus-visible {
      background: var(--sb-color-neutral-300);
    }
  }
{% endstylesheet %}

<script>
  (() => {
    const root = document.getElementById('sb-manual-{{ section.id }}');
    if (!root || root.dataset.manualInit === 'true') return;
    root.dataset.manualInit = 'true';

    const links = [...root.querySelectorAll('[data-manual-link]')];
    const chapters = [...root.querySelectorAll('.sb-manual-chapters__chapter')];
    const mobileDetails = root.querySelector('.sb-manual-chapters__mobile-details');
    const sidebar = root.querySelector('.sb-manual-chapters__sidebar');
    if (!links.length || !chapters.length) return;

    const chapterData = chapters.map((chapter) => {
      const heading = chapter.querySelector('.sb-manual-chapters__heading');
      return { id: chapter.id, heading: heading || chapter };
    });

    const getStickyOffset = () => {
      if (!sidebar || window.getComputedStyle(sidebar).display === 'none') return 72;
      const parsed = parseFloat(window.getComputedStyle(sidebar).top);
      return Number.isNaN(parsed) ? 96 : parsed;
    };

    const setActive = (id) => {
      links.forEach((link) => {
        link.classList.toggle('is-active', link.dataset.target === id);
      });
    };

    const getActiveChapterId = () => {
      const triggerLine = getStickyOffset() + 8;
      const pageY = window.scrollY || window.pageYOffset || 0;
      const triggerPageY = pageY + triggerLine;
      let current = chapterData[0].id;

      chapterData.forEach((chapter) => {
        const headingTop = chapter.heading.getBoundingClientRect().top + pageY;
        if (headingTop <= triggerPageY) current = chapter.id;
      });

      return current;
    };

    let ticking = false;
    const syncActive = () => {
      setActive(getActiveChapterId());
    };

    const requestSync = () => {
      if (ticking) return;
      ticking = true;
      window.requestAnimationFrame(() => {
        syncActive();
        ticking = false;
      });
    };

    links.forEach((link) => {
      link.addEventListener('click', () => {
        window.setTimeout(requestSync, 0);
        if (mobileDetails && mobileDetails.hasAttribute('open')) {
          mobileDetails.removeAttribute('open');
        }
      });
    });

    root.querySelectorAll('[data-manual-faq-trigger]').forEach((trigger) => {
      trigger.addEventListener('click', () => {
        const faq = trigger.closest('.sb-manual-chapters__faq');
        if (!faq) return;

        const isOpening = !faq.classList.contains('is-open');
        root.querySelectorAll('.sb-manual-chapters__faq').forEach((item) => {
          item.classList.remove('is-open');
          const itemTrigger = item.querySelector('[data-manual-faq-trigger]');
          if (itemTrigger) itemTrigger.setAttribute('aria-expanded', 'false');
        });

        if (isOpening) {
          faq.classList.add('is-open');
          trigger.setAttribute('aria-expanded', 'true');
        }
      });
    });

    root.querySelectorAll('[data-manual-vimeo]').forEach((video) => {
      const source = (video.getAttribute('data-vimeo-source') || '').trim();
      const frame = video.querySelector('[data-manual-vimeo-frame]');
      if (!source || !frame) return;

      const extractVimeoId = (value) => {
        if (/^\d+$/.test(value)) return value;
        const match = value.match(/(\d{6,})/);
        return match ? match[1] : '';
      };

      const applyFrameSrc = (videoId) => {
        if (!videoId) return;
        frame.src = `https://player.vimeo.com/video/${videoId}?title=0&byline=0&portrait=0`;
      };

      const applyAspectRatio = (width, height) => {
        if (!width || !height) return;
        const w = Number(width);
        const h = Number(height);
        if (!Number.isFinite(w) || !Number.isFinite(h) || w <= 0 || h <= 0) return;
        frame.style.aspectRatio = `${w} / ${h}`;
      };

      const directId = extractVimeoId(source);

      fetch(`https://vimeo.com/api/oembed.json?url=${encodeURIComponent(source)}`)
        .then((response) => {
          if (!response.ok) throw new Error('oEmbed request failed');
          return response.json();
        })
        .then((data) => {
          if (!frame.src && data && data.video_id) {
            applyFrameSrc(String(data.video_id));
          }
          applyAspectRatio(data?.width, data?.height);
        })
        .catch(() => {
          if (directId) applyFrameSrc(directId);
        });
    });

    window.addEventListener('scroll', requestSync, { passive: true });
    window.addEventListener('resize', requestSync, { passive: true });
    window.addEventListener('hashchange', requestSync);

    syncActive();
    window.setTimeout(syncActive, 120);
    window.setTimeout(syncActive, 360);
  })();
</script>

{% schema %}
{
  "name": "Manual chapters",
  "settings": [],
  "blocks": [
    {
      "type": "heading",
      "name": "Header large",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "Header large"
        }
      ]
    },
    {
      "type": "subheading",
      "name": "Header medium",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "Header medium"
        }
      ]
    },
    {
      "type": "heading_small",
      "name": "Header small",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "Header small"
        }
      ]
    },
    {
      "type": "text",
      "name": "Body",
      "settings": [
        {
          "type": "richtext",
          "id": "text",
          "label": "Body",
          "default": "<p>Write your manual content here.</p>"
        }
      ]
    },
    {
      "type": "image",
      "name": "Image",
      "settings": [
        {
          "type": "paragraph",
          "content": "Target minimum 912px at 2x export (1824px width)."
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        }
      ]
    },
    {
      "type": "vimeo_video",
      "name": "Vimeo video",
      "settings": [
        {
          "type": "text",
          "id": "video_source",
          "label": "Vimeo URL or ID",
          "default": "https://vimeo.com/1102070112"
        }
      ]
    },
    {
      "type": "button",
      "name": "Button large radiant",
      "settings": [
        {
          "type": "text",
          "id": "label",
          "label": "Label",
          "default": "Placeholder"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link"
        }
      ]
    },
    {
      "type": "faq_item",
      "name": "FAQ item",
      "settings": [
        {
          "type": "text",
          "id": "question",
          "label": "Question",
          "default": "Placeholder question"
        },
        {
          "type": "richtext",
          "id": "answer",
          "label": "Answer",
          "default": "<p>Placeholder answer.</p>"
        }
      ]
    },
    {
      "type": "divider",
      "name": "Divider",
      "settings": []
    }
  ],
  "presets": [
    {
      "name": "Manual chapters",
      "blocks": [
        {
          "type": "heading"
        },
        {
          "type": "text"
        },
        {
          "type": "heading"
        }
      ]
    }
  ]
}
{% endschema %}
