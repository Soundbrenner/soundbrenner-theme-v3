{% assign hero_card_fallback_image_desktop = 'placeholder-hero-card-desktop.jpg' | asset_url %}
{% assign hero_card_fallback_image_mobile = 'placeholder-hero-card-mobile.jpg' | asset_url %}
{% assign hero_card_use_seasonal = section.settings.use_seasonal_hero_card %}
{% assign hero_card_use_resource_copy = section.settings.use_resource_title_description %}
{% assign hero_card_use_product_metaobjects = section.settings.use_product_page_metaobjects %}
{% assign hero_card_product_mode = false %}
{% assign hero_card_hide_section = false %}
{% assign hero_card_selected_variant = blank %}
{% assign hero_card_app_store_link = 'https://apps.apple.com/us/app/the-metronome-by-soundbrenner/id1048954353' %}
{% assign hero_card_google_play_link = 'https://play.google.com/store/apps/details?id=com.soundbrenner.pulse' %}
{% assign hero_card_china_download_link = 'https://files.soundbrenner.com/downloads/TheMetronome.apk' %}
{% assign seasonal_sale_name = settings.seasonal_sale_name | strip %}
{% assign seasonal_sale_token = '{{ Seasonal sale name }}' %}

{% if hero_card_use_product_metaobjects %}
  {% if request.page_type == 'product' and product != blank %}
    {% assign hero_card_footer_ref = product.metafields.custom.sbv2_footer_card.value | default: product.metafields.custom.sbv2_footer_card %}
    {% if hero_card_footer_ref != blank %}
      {% assign hero_card_product_mode = true %}
      {% assign hero_card_selected_variant = product.selected_or_first_available_variant %}
      {% assign hero_card_source_image_desktop = hero_card_footer_ref.background_image_desktop.value | default: hero_card_footer_ref.background_image_desktop %}
      {% assign hero_card_source_image_mobile = hero_card_footer_ref.background_image_mobile.value | default: hero_card_footer_ref.background_image_mobile %}
      {% assign hero_card_headline = 'Not happy? Get your money back!' %}
      {% assign hero_card_subheadline = 'Test risk free with 30-day money-back guarantee.' %}
      {% assign hero_card_show_button = true %}
    {% else %}
      {% assign hero_card_hide_section = true %}
    {% endif %}
  {% else %}
    {% assign hero_card_hide_section = true %}
  {% endif %}
{% elsif hero_card_use_seasonal %}
  {% assign hero_card_source_image_desktop = settings.seasonal_hero_image_desktop %}
  {% assign hero_card_source_image_mobile = settings.seasonal_hero_image_mobile %}
  {% assign hero_card_kicker = settings.seasonal_hero_kicker %}
  {% assign hero_card_headline = settings.seasonal_hero_headline %}
  {% assign hero_card_subheadline = settings.seasonal_hero_subheadline %}
  {% assign hero_card_button_label = settings.seasonal_hero_button_label %}
  {% assign hero_card_button_link = settings.seasonal_hero_button_link %}
  {% assign hero_card_kicker = hero_card_kicker | replace: seasonal_sale_token, seasonal_sale_name %}
  {% assign hero_card_headline = hero_card_headline | replace: seasonal_sale_token, seasonal_sale_name %}
  {% assign hero_card_subheadline = hero_card_subheadline | replace: seasonal_sale_token, seasonal_sale_name %}
  {% assign hero_card_button_label = hero_card_button_label | replace: seasonal_sale_token, seasonal_sale_name %}
  {% if hero_card_button_label != blank %}
    {% assign hero_card_show_button = true %}
  {% else %}
    {% assign hero_card_show_button = false %}
  {% endif %}
{% elsif hero_card_use_resource_copy %}
  {% assign hero_card_source_image_desktop = section.settings.background_image_desktop %}
  {% assign hero_card_source_image_mobile = section.settings.background_image_mobile %}
  {% assign hero_card_subheadline = section.settings.subheadline %}
  {% assign hero_card_button_label = section.settings.button_label %}
  {% assign hero_card_button_link = section.settings.button_link %}
  {% assign hero_card_show_button = section.settings.show_button %}
  {% if hero_card_show_button and hero_card_button_label == blank %}
    {% assign hero_card_button_label = 'Placeholder' %}
  {% endif %}

  {% if collection != blank %}
    {% assign hero_card_kicker = collection.title %}
    {% assign hero_card_headline = collection.description | strip_html %}
  {% elsif page != blank %}
    {% assign hero_card_kicker = page.title %}
    {% assign hero_card_headline = page.content | strip_html %}
  {% else %}
    {% assign hero_card_kicker = section.settings.kicker %}
    {% assign hero_card_headline = section.settings.headline %}
  {% endif %}
{% else %}
  {% assign hero_card_source_image_desktop = section.settings.background_image_desktop %}
  {% assign hero_card_source_image_mobile = section.settings.background_image_mobile %}
  {% assign hero_card_kicker = section.settings.kicker %}
  {% assign hero_card_headline = section.settings.headline %}
  {% assign hero_card_subheadline = section.settings.subheadline %}
  {% assign hero_card_button_label = section.settings.button_label %}
  {% assign hero_card_button_link = section.settings.button_link %}
  {% assign hero_card_show_button = section.settings.show_button %}
  {% if hero_card_show_button and hero_card_button_label == blank %}
    {% assign hero_card_button_label = 'Placeholder' %}
  {% endif %}
{% endif %}

{% if hero_card_source_image_mobile != blank %}
  {% assign hero_card_mobile_request_width = hero_card_source_image_mobile.width | at_most: 1206 %}
  {% assign hero_card_mobile_image = hero_card_source_image_mobile | image_url: width: hero_card_mobile_request_width %}
{% else %}
  {% assign hero_card_mobile_image = hero_card_fallback_image_mobile %}
{% endif %}
{% if hero_card_source_image_desktop != blank %}
  {% assign hero_card_desktop_request_width = hero_card_source_image_desktop.width | default: 2480 | at_most: 2480 %}
  {% assign hero_card_desktop_image = hero_card_source_image_desktop | image_url: width: hero_card_desktop_request_width %}
{% else %}
  {% assign hero_card_desktop_image = hero_card_fallback_image_desktop %}
{% endif %}

{% if hero_card_hide_section %}
  <script>
    (() => {
      const sectionWrapper = document.currentScript && document.currentScript.closest('.shopify-section');
      if (sectionWrapper) {
        sectionWrapper.style.setProperty('display', 'none', 'important');
      }
    })();
  </script>
{% else %}
  <div class="sb-hero-card-section" data-sb-reveal>
    <div
      class="sb-framing-card{% if hero_card_product_mode %} sb-framing-card--product-mode{% endif %}"
      data-sb-reveal-item
      {% if hero_card_product_mode %}
        data-hero-card-product-mode
        data-product-id="{{ product.id }}"
        data-currency="{{ cart.currency.iso_code | default: shop.currency }}"
        data-initial-variant-id="{{ hero_card_selected_variant.id }}"
        data-initial-price="{{ hero_card_selected_variant.price | default: 0 }}"
        data-initial-compare-price="{{ hero_card_selected_variant.compare_at_price | default: 0 }}"
      {% endif %}
      style="--sb-hero-card-bg-mobile: url('{{ hero_card_mobile_image }}'); --sb-hero-card-bg-desktop: url('{{ hero_card_desktop_image }}');"
    >
      <div class="sb-framing-card__content">
        {% if hero_card_kicker != blank %}
          <p class="sb-framing-card__kicker font-body weight-semibold">{{ hero_card_kicker }}</p>
        {% endif %}
        {% if hero_card_headline != blank %}
          <h2 class="sb-framing-card__headline font-title weight-bold">{{ hero_card_headline }}</h2>
        {% endif %}
        {% if hero_card_subheadline != blank %}
          <p class="sb-framing-card__subheadline font-body weight-semibold">{{ hero_card_subheadline }}</p>
        {% endif %}
        {% if hero_card_show_button %}
          {% if hero_card_product_mode %}
            <form method="post" action="/cart/add" class="sb-framing-card__product-form" data-hero-card-product-form>
              <input type="hidden" name="id" value="{{ hero_card_selected_variant.id }}" data-hero-card-variant-id>
              <button
                type="submit"
                class="sb-framing-card__product-button sb-button-radiant sb-button-radiant--large sb-button-radiant--leading-icon font-caption weight-bold"
                aria-label="Add to cart"
                data-hero-card-submit
              >
                <span class="sb-framing-card__product-button-icon" aria-hidden="true">
                  <img
                    class="sb-framing-card__product-button-icon-image"
                    src="{{ 'icon-add-to-cart.svg' | asset_url }}"
                    alt=""
                    width="16"
                    height="16"
                  >
                </span>
                <span class="sb-framing-card__product-button-copy">
                  <span class="sb-framing-card__product-button-label" data-hero-card-button-label>Add to cart</span>
                  <span class="sb-framing-card__product-button-prices">
                    <span class="sb-framing-card__product-button-price sb-framing-card__product-button-price--compare" data-hero-card-compare-price></span>
                    <span class="sb-framing-card__product-button-price sb-framing-card__product-button-price--current" data-hero-card-current-price></span>
                  </span>
                </span>
              </button>
            </form>
          {% else %}
            {% render 'radiant-button',
              label: hero_card_button_label,
              link: hero_card_button_link,
              size: section.settings.button_size,
              icon_position: section.settings.icon_position,
              extra_class: 'sb-framing-card__button'
            %}
          {% endif %}
        {% endif %}

        {% if section.settings.enable_app_download_buttons and hero_card_product_mode == false %}
          <div class="sb-framing-card__app-downloads">
          <div class="sb-framing-card__app-downloads-qr" aria-hidden="true">
            <img
              src="{{ 'app-download-qr-metronome-app.png' | asset_url }}"
              alt=""
              loading="lazy"
              width="80"
              height="80"
            >
          </div>

          <a class="sb-framing-card__app-download-link" href="{{ hero_card_app_store_link }}" target="_blank" rel="noopener noreferrer">
            <img
              class="sb-framing-card__app-download-badge sb-framing-card__app-download-badge--app-store"
              src="{{ 'app-download-app-store.png' | asset_url }}"
              alt="Download on the App Store"
              loading="lazy"
            >
          </a>

          <a class="sb-framing-card__app-download-link" href="{{ hero_card_google_play_link }}" target="_blank" rel="noopener noreferrer">
            <img
              class="sb-framing-card__app-download-badge sb-framing-card__app-download-badge--google-play"
              src="{{ 'app-download-google-play.png' | asset_url }}"
              alt="Get it on Google Play"
              loading="lazy"
            >
          </a>

          <a class="sb-framing-card__app-download-link" href="{{ hero_card_china_download_link }}" target="_blank" rel="noopener noreferrer">
            <img
              class="sb-framing-card__app-download-badge sb-framing-card__app-download-badge--china"
              src="{{ 'app-download-china.png' | asset_url }}"
              alt="Download in China"
              loading="lazy"
            >
          </a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
{% endif %}

{% stylesheet %}
  .sb-framing-card {
    --sb-hero-bg-focus-mobile: 50%;
    --sb-hero-bg-focus-desktop: 75%;
    align-items: flex-start;
    background: var(--sb-color-neutral-200);
    background-image: var(--sb-hero-card-bg-mobile);
    background-position: var(--sb-hero-bg-focus-mobile) center;
    background-repeat: no-repeat;
    background-size: cover;
    border-radius: 24px;
    display: flex;
    height: 380px;
    padding-block: var(--sb-space-64);
    padding-inline: var(--sb-space-64);
    width: 100%;
  }

  .sb-framing-card__content {
    display: flex;
    flex-direction: column;
    gap: var(--sb-space-20);
    margin-inline: 0;
    max-width: 560px;
    text-align: center;
    width: 100%;
  }

  .sb-framing-card__content h2,
  .sb-framing-card__content p {
    color: var(--sb-color-neutral-900);
    margin: 0;
  }

  .sb-framing-card__button {
    margin-inline: auto;
    margin-top: var(--sb-space-4);
    width: fit-content;
  }

  .sb-framing-card__product-form {
    margin-top: var(--sb-space-4);
    width: 100%;
  }

  .sb-framing-card__product-button {
    justify-content: center;
    width: 100%;
  }

  .sb-framing-card__product-button-icon {
    align-items: center;
    display: inline-flex;
    justify-content: center;
    width: var(--sb-space-16);
  }

  .sb-framing-card__product-button-icon-image {
    display: block;
    height: var(--sb-space-16);
    width: var(--sb-space-16);
  }

  .sb-framing-card__product-button-copy {
    align-items: center;
    display: inline-flex;
    gap: var(--sb-space-4);
    justify-content: center;
  }

  .sb-framing-card__product-button-prices {
    align-items: center;
    display: inline-flex;
    gap: var(--sb-space-4);
  }

  .sb-framing-card__product-button-price {
    line-height: 1;
  }

  .sb-framing-card__product-button-price--compare {
    color: var(--sb-color-always-white);
    text-decoration: line-through;
  }

  .sb-framing-card__product-button-price--compare[hidden] {
    display: none;
  }

  .sb-framing-card__app-downloads {
    align-items: center;
    display: flex;
    flex-wrap: wrap;
    gap: var(--sb-space-20);
    justify-content: flex-start;
    padding-top: var(--sb-space-4);
    width: 100%;
  }

  .sb-framing-card__app-downloads-qr {
    flex: 0 0 auto;
    height: var(--sb-space-80, calc(var(--sb-space-16) * 5));
    max-height: var(--sb-space-80, calc(var(--sb-space-16) * 5));
    max-width: var(--sb-space-80, calc(var(--sb-space-16) * 5));
    min-height: var(--sb-space-80, calc(var(--sb-space-16) * 5));
    min-width: var(--sb-space-80, calc(var(--sb-space-16) * 5));
    width: var(--sb-space-80, calc(var(--sb-space-16) * 5));
  }

  .sb-framing-card__app-downloads-qr img {
    display: block;
    height: var(--sb-space-80, calc(var(--sb-space-16) * 5));
    max-height: var(--sb-space-80, calc(var(--sb-space-16) * 5));
    max-width: var(--sb-space-80, calc(var(--sb-space-16) * 5));
    min-height: var(--sb-space-80, calc(var(--sb-space-16) * 5));
    min-width: var(--sb-space-80, calc(var(--sb-space-16) * 5));
    object-fit: contain;
    width: var(--sb-space-80, calc(var(--sb-space-16) * 5));
  }

  .sb-framing-card__app-download-link {
    display: inline-flex;
    flex: 0 0 auto;
    line-height: 0;
    text-decoration: none;
    transition: none;
    user-select: none;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
  }

  .sb-framing-card__app-download-badge {
    display: block;
    height: var(--sb-space-36);
    user-select: none;
    width: auto;
    -webkit-user-drag: none;
    -webkit-user-select: none;
  }

  .sb-framing-card__app-download-badge--app-store {
    aspect-ratio: 108 / 36;
  }

  .sb-framing-card__app-download-badge--google-play {
    aspect-ratio: 122 / 36;
  }

  .sb-framing-card__app-download-badge--china {
    aspect-ratio: 122 / 36;
  }

  .sb-framing-card__app-download-link[href]:hover,
  .sb-framing-card__app-download-link[href]:focus-visible {
    opacity: 0.75;
  }

  @media (max-width: 749px) {
    .sb-framing-card__app-downloads-qr {
      display: none;
    }

    .sb-framing-card__app-downloads {
      justify-content: center;
    }
  }

  @media (min-width: 750px) {
    .sb-framing-card {
      align-items: center;
      background-image: var(--sb-hero-card-bg-desktop);
      background-position: var(--sb-hero-bg-focus-desktop) center;
    }

    .sb-framing-card__content {
      text-align: left;
    }

    .sb-framing-card__button {
      margin-inline: 0;
    }

    .sb-framing-card__product-button {
      justify-content: flex-start;
      width: fit-content;
    }

    .sb-framing-card__product-button-copy {
      justify-content: flex-start;
    }
  }
{% endstylesheet %}

{% javascript %}
  (() => {
    const cards = Array.from(document.querySelectorAll('[data-hero-card-product-mode]'));
    if (!cards.length) return;

    cards.forEach((card) => {
      if (card.dataset.heroCardInit === 'true') return;
      card.dataset.heroCardInit = 'true';

      const variantIdInput = card.querySelector('[data-hero-card-variant-id]');
      const currentPriceElement = card.querySelector('[data-hero-card-current-price]');
      const comparePriceElement = card.querySelector('[data-hero-card-compare-price]');
      const form = card.querySelector('[data-hero-card-product-form]');
      const submitButton = card.querySelector('[data-hero-card-submit]');
      const buttonLabel = card.querySelector('[data-hero-card-button-label]');
      const currencyCode = card.dataset.currency || 'USD';
      const productId = card.dataset.productId || '';
      if (!variantIdInput || !currentPriceElement || !comparePriceElement || !form || !submitButton || !buttonLabel) return;

      const formatter = new Intl.NumberFormat(undefined, {
        style: 'currency',
        currency: currencyCode,
      });

      const formatMoney = (centsValue) => {
        const amount = Number(centsValue) || 0;
        return formatter.format(amount / 100);
      };

      const applyVariant = (variant) => {
        if (!variant || !variant.id) return;
        variantIdInput.value = `${variant.id}`;
        currentPriceElement.textContent = formatMoney(variant.price);

        const hasCompare = Number(variant.compare_at_price) > Number(variant.price);
        if (hasCompare) {
          comparePriceElement.textContent = formatMoney(variant.compare_at_price);
          comparePriceElement.hidden = false;
        } else {
          comparePriceElement.textContent = '';
          comparePriceElement.hidden = true;
        }
      };

      applyVariant({
        id: Number(card.dataset.initialVariantId || '0'),
        price: Number(card.dataset.initialPrice || '0'),
        compare_at_price: Number(card.dataset.initialComparePrice || '0'),
      });

      document.addEventListener('variant:update', (event) => {
        const variant = event?.detail?.resource;
        const eventProductId = event?.detail?.data?.productId;
        if (!variant || `${eventProductId || ''}` !== `${productId}`) return;
        applyVariant(variant);
      });

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const variantId = Number(variantIdInput.value || '0');
        if (!variantId) return;

        submitButton.disabled = true;
        const originalLabel = buttonLabel.textContent;
        buttonLabel.textContent = 'Adding...';

        try {
          if (window.SBCart && typeof window.SBCart.add === 'function') {
            await window.SBCart.add(variantId, {
              sourceId: `hero-card-${variantId}`,
              sourceData: {
                source: 'hero-card',
              },
            });
          } else {
            throw new Error('SBCart unavailable');
          }

          buttonLabel.textContent = 'Added';
          window.setTimeout(() => {
            buttonLabel.textContent = originalLabel;
            submitButton.disabled = false;
          }, 1200);
        } catch (_) {
          buttonLabel.textContent = originalLabel;
          submitButton.disabled = false;
        }
      });
    });
  })();
{% endjavascript %}

{% schema %}
{
  "name": "Hero card",
  "settings": [
    {
      "type": "checkbox",
      "id": "use_seasonal_hero_card",
      "label": "Use seasonal hero card",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "use_resource_title_description",
      "label": "Title and description from Shopify page CMS",
      "default": false,
      "visible_if": "{{ section.settings.use_seasonal_hero_card == false }}"
    },
    {
      "type": "checkbox",
      "id": "use_product_page_metaobjects",
      "label": "Use product page metaobjects",
      "info": "Uses product footer metaobject values, fixed guarantee copy, and a dynamic add to cart button. Product templates only.",
      "default": false,
      "visible_if": "{{ section.settings.use_seasonal_hero_card == false }}"
    },
    {
      "type": "image_picker",
      "id": "background_image_desktop",
      "label": "Background image desktop",
      "info": "Target minimum 1240x380 at 2x export (2480x760).",
      "visible_if": "{{ section.settings.use_seasonal_hero_card == false and section.settings.use_product_page_metaobjects == false }}"
    },
    {
      "type": "image_picker",
      "id": "background_image_mobile",
      "label": "Background image mobile",
      "info": "Target minimum 402x380 at 3x export (1206x1140).",
      "visible_if": "{{ section.settings.use_seasonal_hero_card == false and section.settings.use_product_page_metaobjects == false }}"
    },
    {
      "type": "text",
      "id": "kicker",
      "label": "Kicker",
      "visible_if": "{{ section.settings.use_seasonal_hero_card == false and section.settings.use_resource_title_description == false and section.settings.use_product_page_metaobjects == false }}"
    },
    {
      "type": "textarea",
      "id": "headline",
      "label": "Headline",
      "visible_if": "{{ section.settings.use_seasonal_hero_card == false and section.settings.use_resource_title_description == false and section.settings.use_product_page_metaobjects == false }}"
    },
    {
      "type": "textarea",
      "id": "subheadline",
      "label": "Subheadline",
      "visible_if": "{{ section.settings.use_seasonal_hero_card == false and section.settings.use_product_page_metaobjects == false }}"
    },
    {
      "type": "checkbox",
      "id": "show_button",
      "label": "Show button",
      "default": false,
      "visible_if": "{{ section.settings.use_seasonal_hero_card == false and section.settings.use_product_page_metaobjects == false }}"
    },
    {
      "type": "text",
      "id": "button_label",
      "label": "Button label",
      "default": "Placeholder",
      "visible_if": "{{ section.settings.use_seasonal_hero_card == false and section.settings.show_button and section.settings.use_product_page_metaobjects == false }}"
    },
    {
      "type": "select",
      "id": "button_size",
      "label": "Button size",
      "default": "large",
      "options": [
        { "value": "large", "label": "Large" },
        { "value": "medium", "label": "Medium" }
      ],
      "visible_if": "{{ section.settings.use_seasonal_hero_card == false and section.settings.show_button and section.settings.use_product_page_metaobjects == false }}"
    },
    {
      "type": "select",
      "id": "icon_position",
      "label": "Icon position",
      "default": "none",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "leading", "label": "Leading" },
        { "value": "trailing", "label": "Trailing" }
      ],
      "visible_if": "{{ section.settings.use_seasonal_hero_card == false and section.settings.show_button and section.settings.use_product_page_metaobjects == false }}"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "Button link",
      "visible_if": "{{ section.settings.use_seasonal_hero_card == false and section.settings.show_button and section.settings.use_product_page_metaobjects == false }}"
    },
    {
      "type": "checkbox",
      "id": "enable_app_download_buttons",
      "label": "Enable app download buttons",
      "default": false,
      "visible_if": "{{ section.settings.use_product_page_metaobjects == false }}"
    }
  ],
  "presets": [
    {
      "name": "Hero card"
    }
  ]
}
{% endschema %}
